<!DOCTYPE html>
<html lang="pl">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      font-family: Collage, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #fff;
      text-align: center;
    }

    .hidden { display: none !important; }
    .container { margin-top: 40px; }

    .login-box input, .login-box select {
      display: block;
      margin: 10px auto;
      padding: 8px;
      width: 200px;
      border-radius: 6px;
      border: none;
    }

    button {
      padding: 8px 16px;
      border: none;
      background: red;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    button[disabled] { background: gray !important; cursor: default; }

    .full-btn {
      display: block;
      width: 200px;
      margin: 10px auto;
      padding: 8px;
      border-radius: 6px;
      background: red;
      border: none;
      color: white;
      cursor: pointer;
    }
    .full-btn.alt { background: #333; }

    .card {
      border: 1px solid #555;
      border-radius: 10px;
      padding: 10px;
      margin: 10px;
      background: #111;
    }

    .lista-zapisanych {
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      padding: 8px;
      margin-top: 6px;
      text-align: left;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    #wersjaApki {
      position: fixed;
      top: 8px;
      right: 12px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      user-select: none;
      z-index: 1000;
    }

    button.loading {
      background: #222 !important;
      opacity: 0.6;
      pointer-events: none;
      transition: background 0.2s ease, opacity 0.2s ease;
    }

/* Splash (statyczny) */
#splash {
  position: fixed;
  inset: 0;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 4000;
}

    .select-like-input {
      width: 200px;
      height: 36px;
      margin: 10px auto;
      border-radius: 6px;
      border: none;
      padding: 6px;
      font-size: 14px;
      display: block;
    }

    .grupa-check {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 14px;
      color: white;
    }
    .grupa-check input {
      margin-bottom: 4px;
      transform: scale(1.3);
    }

    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      background: #444;
      color: #fff;
      cursor: pointer;
      margin: 2px;
    }
    .btn.danger { background: #800; }

    #trainerDeletePopup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }
    #trainerDeletePopup.show { display: flex; }
    #trainerDeletePopup .popup-card {
      background: #111;
      border: 1px solid #555;
      border-radius: 10px;
      padding: 16px 20px;
      max-width: 260px;
      text-align: center;
    }

    /* BUSY OVERLAY */
    #busyOverlay.hidden { display: none !important; }
    #busyOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5000;
      padding: 24px;
    }

    button, input, select { font-size: 14px; }
  </style>
<script>
  // Ustaw globalnie dla Twojego du≈ºego skryptu:
  window.WERSJA_APKI = '1.05.10.04';

  const poprzednia = localStorage.getItem('wersjaApki');
  if (poprzednia !== window.WERSJA_APKI) {
    localStorage.setItem('wersjaApki', window.WERSJA_APKI);
    location.reload(); // bez (true) ‚Äî to ju≈º jest przestarza≈Çe
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(r => console.log("‚úÖ SW zarejestrowany:", r))
      .catch(e => console.error("‚ùå B≈ÇƒÖd SW:", e));
  }
</script>

</head>

<body>

  <div id="wersjaApki"><span id="wersjaNum"></span></div>

  <!-- BUSY OVERLAY (jeden, zgodny z JS: busyText) -->
  <div id="busyOverlay" class="hidden">
    <div style="font-size:20px; margin-bottom:12px;">‚è≥ Przygotowujƒô aplikacjƒô‚Ä¶</div>
    <div id="busyText" style="opacity:.85; max-width:320px; line-height:1.4;">
      Tworzƒô pliki klubu, ustawiam sezon i konfiguracjƒô.
    </div>
  </div>

  <!-- Splash -->
<div id="splash">
  <div style="text-align:center;">
    <div style="
      font-size:48px;
      font-weight:700;
      letter-spacing:2px;
      color:#000;
      margin-bottom:12px;
    ">
      ORG HUB
    </div>
    <div style="
      font-size:22px;
      letter-spacing:4px;
      color:#000;
      opacity:0.8;
    ">
      SYSTEMS
    </div>
  </div>
</div>

  <!-- G≈Ç√≥wna aplikacja -->
  <div id="app" class="hidden">

    <!-- LANDING ORGHUB -->
    <div id="orgHubLandingView" class="container hidden">
<h1 style="margin-bottom:6px;color:#000;">Witamy w aplikacji</h1>
<div style="font-size:28px;font-weight:800;letter-spacing:2px;margin-bottom:18px;color:#000;">
  ORGHUB SYSTEMS
</div>

      <button class="full-btn" onclick="goToConfig()">Skonfiguruj klub</button>
    </div>

    <!-- KONFIGURACJA KLUBU -->
    <div id="clubConfigView" class="container hidden">
      <h1>Konfiguracja klubu</h1>

      <div class="card" style="max-width:320px;margin:12px auto;">
        <!-- LOGO -->
        <button class="full-btn" onclick="pickLogo()">Wgraj swoje logo</button>
        <div style="margin-top:8px;">
          <img id="cfgLogoPreview" src="" alt="" style="display:none;width:160px;border-radius:10px;border:1px solid #444;">
          <div style="font-size:12px;opacity:0.75;margin-top:6px;">
            PNG/JPG, najlepiej kwadrat, np. 512√ó512
          </div>
          <input id="cfgLogoInput" type="file" accept="image/*" class="hidden" />
        </div>

        <!-- NAZWA (zgodnie z JS: editClubName) -->
        <button class="full-btn alt" id="btnClubName" onclick="clubNameEditStart()">
        <span id="clubNameText">Podaj nazwƒô klubu</span>
        <input id="clubNameInput" type="text" class="hidden"
         placeholder="Wpisz nazwƒô klubu"
         style="width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:none;">
      </button>

        <div id="cfgClubNameLabel" style="margin-top:6px;opacity:0.9;"></div>

        <!-- KOLOR T≈ÅA -->
        <button class="full-btn alt" onclick="toggleColorPicker(true)">Wybierz kolor t≈Ça</button>
        <div id="cfgColorLabel" style="margin-top:6px;opacity:0.9;"></div>

        <div id="cfgColorGrid" class="hidden"
             style="margin-top:10px;display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;">
        </div>

        <!-- EMAIL -->
        <button class="full-btn alt" id="btnEmail" onclick="emailEditStart()">
        <span id="emailText">Tw√≥j email</span>
        <input id="emailInput" type="email" class="hidden"
         placeholder="Wpisz email"
         style="width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:none;">
        </button>

        <div id="cfgEmailLabel" style="margin-top:6px;opacity:0.9;"></div>

        <button class="full-btn" style="margin-top:14px;" onclick="submitClubConfig()">Wy≈õlij</button>
        <button class="full-btn alt" onclick="goBackFromConfig()">‚¨Ö Powr√≥t</button>

        <p id="cfgMsg" style="margin-top:10px;"></p>
      </div>

      <!-- PANEL 2 - UZUPE≈ÅNIENIE DANYCH KLUBU -->
<div id="clubSetupView" class="container hidden">
  <h1>Uzupe≈Çnij dane klubu</h1>
  <div class="card" style="max-width:320px; margin:12px auto; padding:16px;">

    <!-- POCZƒÑTEK SEZONU -->
    <button class="full-btn alt" id="btnSetupSeasonStart" onclick="setupSeasonStartPick()">
      <span id="setupSeasonStartText">PoczƒÖtek sezonu</span>
      <input id="setupSeasonStartInput" type="date" class="hidden"
             style="width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:none;">
    </button>
    <div id="setupSeasonStartLabel" style="margin-top:6px; opacity:0.9; min-height:1.2em;"></div>

    <!-- KONIEC SEZONU -->
    <button class="full-btn alt" id="btnSetupSeasonEnd" onclick="setupSeasonEndPick()">
      <span id="setupSeasonEndText">Koniec sezonu</span>
      <input id="setupSeasonEndInput" type="date" class="hidden"
             style="width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:none;">
    </button>
    <div id="setupSeasonEndLabel" style="margin-top:6px; opacity:0.9; min-height:1.2em;"></div>

    <!-- PRZYCISKI -->
    <button class="full-btn alt" id="btnSetupPayments" disabled
            style="margin-top:20px; width:100%;">P≈Çatno≈õci (jeszcze nieaktywne)</button>

    <button class="full-btn" id="btnSetupSubmit" disabled
            style="margin-top:12px; width:100%;">Wy≈õlij i aktywuj klub</button>

    <button class="full-btn alt" onclick="goBackFromSetup()" 
            style="margin-top:12px; width:100%;">‚¨Ö Powr√≥t</button>

    <p id="setupMsg" style="margin-top:16px; min-height:3em;"></p>
  </div>
</div>


    <!-- LOGOWANIE -->
    <div id="loginView" class="container hidden">
<img src="icon-512.png" class="logo" style="width:200px;margin-bottom:15px;" alt="Logo">

<div style="width:220px; margin:0 auto 40px auto; text-align:center;">
  <div id="clubIdBadge" style="font-size:32px; font-weight:900; letter-spacing:3px; line-height:1.1;"></div>
</div>

<h1 style="margin:0 0 40px 0;">Logowanie</h1>


      <div class="login-box">
        <input id="numer" type="text" placeholder="Numer / Inicja≈Çy">
        <input id="haslo" type="password" placeholder="Has≈Ço">
        <button class="full-btn" onclick="zaloguj()">Zaloguj</button>
        <button class="full-btn alt" onclick="pokazRejestracjaSelect()">Rejestracja</button>
      </div>
      <p id="komunikat"></p>
    </div>

    <!-- WYB√ìR TYP REJESTRACJI -->
    <div id="registerSelectView" class="container hidden">
      <h1>Rejestracja</h1>
      <button class="full-btn" onclick="pokazRejestracjaZawodnik()">Zawodnik</button>
      <button class="full-btn" onclick="pokazRejestracjaTrener()">Trener</button>
      <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- REJESTRACJA ZAWODNIKA -->
    <div id="registerZawodnikView" class="container hidden">
      <h1>Rejestracja zawodnika</h1>
      <div class="login-box">
        <input id="regNumer" type="number" placeholder="Numer zawodnika">
        <input id="regNazwisko" type="text" placeholder="Imiƒô i nazwisko">
        <input id="regHaslo" type="password" placeholder="Ustaw has≈Ço">
        <button class="full-btn" onclick="wyslijRejestracje()">Zarejestruj</button>
      </div>
      <p id="regMsg"></p>
      <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- REJESTRACJA TRENERA -->
    <div id="rejestracjaTrenerView" class="container hidden">
      <h1>Rejestracja trenera</h1>
      <div class="login-box">
        <input id="regNazwiskoTrener" type="text" placeholder="Imiƒô i nazwisko">
        <input id="regHasloTrener" type="password" placeholder="Ustaw has≈Ço">
        <button class="full-btn" onclick="wyslijRejestracjeTrener()">Zarejestruj</button>
        <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
      </div>
      <p id="regMsgTrener"></p>
    </div>

<!-- DODAJ WYDARZENIE (TRENER) -->
<div id="trainerDodajWydarzenieView" class="container hidden">
  <h1>Dodaj wydarzenie</h1>

  <div class="login-box">
    <input id="eventData" type="date">
    <input id="eventStart" type="time">
    <input id="eventEnd" type="time">
    <input id="eventRodzaj" type="text" placeholder="Rodzaj wydarzenia">

    <!-- TRENERZY (kaskadowo, max 4) -->
    <select id="eventTrener1" class="select-like-input" onchange="onTrenerPick(1)">
      <option value="">‚Äî wybierz trenera ‚Äî</option>
    </select>

    <div id="trener2Wrap" class="hidden">
      <select id="eventTrener2" class="select-like-input" onchange="onTrenerPick(2)">
        <option value="">‚Äî kolejny trener ‚Äî</option>
      </select>
    </div>

    <div id="trener3Wrap" class="hidden">
      <select id="eventTrener3" class="select-like-input" onchange="onTrenerPick(3)">
        <option value="">‚Äî kolejny trener ‚Äî</option>
      </select>
    </div>

    <div id="trener4Wrap" class="hidden">
      <select id="eventTrener4" class="select-like-input">
        <option value="">‚Äî kolejny trener ‚Äî</option>
      </select>
    </div>
  </div><!-- ‚úÖ domkniƒôcie login-box -->

<!-- GRUPY: przycisk + popup -->
<button class="full-btn alt" id="btnPickGroups" onclick="openGroupsPopup()">Wybierz grupy</button>
<div id="groupsSummary" style="margin-top:6px;opacity:0.85;font-size:13px;">‚Äî</div>

<div id="groupsPopup" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; justify-content:center; align-items:center;
  z-index:3000; padding:18px;
">
  <div class="card" style="max-width:320px;width:100%; text-align:left;">
    <div style="font-weight:800; font-size:16px; margin-bottom:10px;">Wybierz grupy</div>

    <div id="groupsList" style="display:flex; flex-direction:column; gap:8px;"></div>

    <div style="display:flex; gap:8px; margin-top:14px;">
      <button class="full-btn alt" style="flex:1;" onclick="closeGroupsPopup()">Anuluj</button>
      <button class="full-btn" style="flex:1;" onclick="applyGroupsPopup()">Zapisz</button>
    </div>
  </div>
</div>

  <div style="margin-top:10px;">
    <label><input id="eventStat" type="checkbox"> Liczyƒá do statystyk</label>
  </div>

  <button class="full-btn" onclick="wyslijNoweWydarzenie()">üíæ Dodaj wydarzenie</button>
  <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>

  <p id="eventMsg" style="margin-top:10px;"></p>
</div>


    <!-- P≈ÅATNO≈öCI -->
    <div id="platnosciView" class="container hidden">
      <h1>P≈Çatno≈õci</h1>
      <div id="listaPlatnosci">≈Åadowanie...</div>
    </div>

    <!-- WYDARZENIA (ZAWODNIK) -->
    <div id="homeView" class="container hidden">
      <h1 id="tytulTreningow">TWOJE WYDARZENIA</h1>
      <div id="listaTreningow">≈Åadowanie...</div>
      <button onclick="pokazStatystyki()" style="margin-top:20px;">üìà Poka≈º statystyki</button>
      <button onclick="powrotDoPlatnosci()" style="margin-top:10px;background:#333;">‚¨Ö Powr√≥t do p≈Çatno≈õci</button>
    </div>

    <!-- STATYSTYKI -->
    <div id="statsView" class="container hidden">
      <h1>Moje statystyki</h1>
      <div id="listaStatystyk">≈Åadowanie...</div>
      <button onclick="powrotDoTreningow()" style="margin-top:20px;">‚¨Ö Powr√≥t</button>
    </div>

    <!-- PANEL TRENERA -->
    <div id="trainerPanelView" class="container hidden">
      <h1>Panel trenera</h1>
      <button class="full-btn" onclick="trainerPokazZawodnicy()">üë• Zawodnicy</button>
      <button class="full-btn" onclick="trainerPokazWydarzenia()">üèí Wydarzenia</button>
      <button class="full-btn alt" onclick="pokazLogowanie()">‚¨Ö Wyloguj</button>
    </div>

    <!-- LISTA ZAWODNIK√ìW (TRENER) -->
    <div id="trainerZawodnicyView" class="container hidden">
      <h1>Lista zawodnik√≥w</h1>
      <div id="trainerListaZawodnikow">≈Åadowanie...</div>
      <button class="full-btn alt" onclick="trainerPowrot()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- WYDARZENIA (TRENER) -->
    <div id="trainerWydarzeniaView" class="container hidden">
      <h1>Wydarzenia</h1>
      <div id="trainerListaWydarzen">≈Åadowanie...</div>
      <button class="full-btn" style="margin-top:20px;" onclick="pokazDodajWydarzenie()">‚ûï Dodaj wydarzenie</button>
      <button class="full-btn alt" onclick="trainerPowrot()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- Popup potwierdzenia usuniƒôcia -->
    <div id="trainerDeletePopup">
      <div class="popup-card">
        <p style="margin-bottom:15px;">Czy napewno chcesz usunƒÖƒá wydarzenie ?</p>
        <button class="full-btn" onclick="trainerConfirmDeleteYes()">TAK</button>
        <button class="full-btn alt" style="margin-top:8px;" onclick="trainerHideDeletePopup()">Anuluj</button>
      </div>
    </div>

    <!-- Popup edycji wydarzenia -->
<div id="trainerEditPopup" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  justify-content: center;
  align-items: center;
  z-index: 2100;
  display: none;
">
  <div class="popup-card" style="max-width:320px;">
    <p style="margin:0 0 10px 0;"><b>Edytuj wydarzenie</b></p>
    <div class="login-box" style="margin-top:10px;">
      <input id="editEventData" type="date">
      <input id="editEventStart" type="time">
      <input id="editEventEnd" type="time">
      <input id="editEventRodzaj" type="text" placeholder="Rodzaj wydarzenia">

      <!-- TRENERZY (kaskadowo, max 4) -->
      <select id="editTrener1" class="select-like-input" onchange="onEditTrenerPick(1)">
        <option value="">‚Äî wybierz trenera ‚Äî</option>
      </select>

      <div id="editTrener2Wrap" class="hidden">
        <select id="editTrener2" class="select-like-input" onchange="onEditTrenerPick(2)">
          <option value="">‚Äî kolejny trener ‚Äî</option>
        </select>
      </div>

      <div id="editTrener3Wrap" class="hidden">
        <select id="editTrener3" class="select-like-input" onchange="onEditTrenerPick(3)">
          <option value="">‚Äî kolejny trener ‚Äî</option>
        </select>
      </div>

      <div id="editTrener4Wrap" class="hidden">
        <select id="editTrener4" class="select-like-input">
          <option value="">‚Äî kolejny trener ‚Äî</option>
        </select>
      </div>

      <!-- GRUPY -->
      <button class="full-btn alt" id="btnEditPickGroups" type="button" onclick="openEditGroupsPopup()">
        Wybierz grupy
      </button>
      <div id="editGroupsSummary" style="margin-top:6px;opacity:0.85;font-size:13px;">‚Äî</div>
    </div>

    <!-- POPUP GRUP (edycja) -->
    <div id="editGroupsPopup" class="hidden" style="
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:flex; justify-content:center; align-items:center;
      z-index:3001; padding:18px;
    ">
      <div class="card" style="max-width:320px;width:100%; text-align:left;">
        <div style="font-weight:800; font-size:16px; margin-bottom:10px;">Wybierz grupy (edycja)</div>

        <div id="editGroupsList" style="display:flex; flex-direction:column; gap:8px;"></div>

        <div style="display:flex; gap:8px; margin-top:14px;">
          <button class="full-btn alt" style="flex:1;" type="button" onclick="closeEditGroupsPopup()">Anuluj</button>
          <button class="full-btn" style="flex:1;" type="button" onclick="applyEditGroupsPopup()">Zapisz</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px;">
     <button class="full-btn" id="btnEditSave">üíæ Zapisz zmiany</button>
      <button class="full-btn alt" onclick="trainerHideEditPopup()">Anuluj</button>
    </div>

    <p id="editEventMsg" style="margin-top:10px;"></p>
  </div>
</div>

  </div><!-- /app -->

<script>
/* =================== 00 START / INTRO =================== */
function odtworzIntroSound() {
  try {
    const audio = new Audio("sound.mp3");
    audio.volume = 0.7;
    audio.play().catch(() => {});
  } catch (err) {}
}

/* =================== 10 KONFIG / GLOBALNE =================== */
const WERSJA_APKI = window.WERSJA_APKI || "ORGHUB APP";
const CORE_URL = "https://still-shape-2aa3.orghubsystems.workers.dev";

// ===== DEBUG: poka≈º b≈ÇƒÖd JS na ekranie (≈ºeby nie sta≈Ço "w ciszy") =====
window.addEventListener("error", (ev) => {
  try {
    const splash = document.getElementById("splash");
    const app = document.getElementById("app");
    if (splash) splash.style.display = "none";
    if (app) app.classList.remove("hidden");

    const box = document.createElement("div");
    box.style.position = "fixed";
    box.style.inset = "0";
    box.style.background = "#fff";
    box.style.color = "#000";
    box.style.padding = "16px";
    box.style.zIndex = "999999";
    box.style.overflow = "auto";
    box.style.fontFamily = "monospace";
    box.innerHTML =
      `<h2 style="margin:0 0 10px 0;">‚ùå B≈ÇƒÖd JS (apka nie wystartowa≈Ça)</h2>
       <div><b>${(ev && ev.message) ? ev.message : "unknown error"}</b></div>
       <div style="margin-top:8px;">Plik: ${ev?.filename || "-"}</div>
       <div>Linia: ${ev?.lineno || "-"}, Kolumna: ${ev?.colno || "-"}</div>
       <pre style="white-space:pre-wrap;margin-top:12px;">${(ev && ev.error && ev.error.stack) ? ev.error.stack : ""}</pre>`;
    document.body.appendChild(box);
  } catch (e) {}
});

window.addEventListener("unhandledrejection", (ev) => {
  try { alert("Unhandled Promise Rejection: " + (ev?.reason?.message || ev?.reason || ev)); } catch (e) {}
});

// stan aplikacji
let clubId = localStorage.getItem("orghub_clubId") || "";
let numerZalogowanego = null;
let grupaZalogowanego = null;
window.grupyTrenera = "";
let currentView = "loginView";

/* =================== 20 PAMIƒòƒÜ LOKALNA (localStorage) =================== */
const LS_KEY_CFG = "orghub.clubConfig.v1";
const LS_KEY_CLUBID = "orghub_clubId";
const LS_KEY_THEME = "orghub_theme";
const LS_KEY_CFG_LOCK = "orghub_cfg_locked";

function isCfgLocked_() {
  return localStorage.getItem(LS_KEY_CFG_LOCK) === "1";
}

function lockCfg_() {
  localStorage.setItem(LS_KEY_CFG_LOCK, "1");
}

function unlockCfg_() {
  localStorage.removeItem(LS_KEY_CFG_LOCK);
}

function loadLocalClubConfig() {
  try { return JSON.parse(localStorage.getItem(LS_KEY_CFG) || "null"); }
  catch { return null; }
}
function saveLocalClubConfig(cfg) {
  localStorage.setItem(LS_KEY_CFG, JSON.stringify(cfg || {}));
}
function clearLocalClubConfig() {
  localStorage.removeItem(LS_KEY_CFG);
}
function saveClubId_(id) {
  clubId = String(id || "").trim();
  if (clubId) localStorage.setItem(LS_KEY_CLUBID, clubId);
  else localStorage.removeItem(LS_KEY_CLUBID);
}
function saveTheme_(theme) {
  localStorage.setItem(LS_KEY_THEME, JSON.stringify(theme || {}));
}
function loadTheme_() {
  try { return JSON.parse(localStorage.getItem(LS_KEY_THEME) || "null"); }
  catch { return null; }
}

function initClubFromUrl_() {
  try {
    const params = new URLSearchParams(window.location.search);
    const urlClubId = params.get("clubId");

    if (urlClubId) {
      saveClubId_(urlClubId);   // klub z linku
    } else {
      saveClubId_("");          // link og√≥lny = reset
    }
  } catch (e) {}
}

/* =================== 30 BUSY OVERLAY =================== */
function showBusy(text) {
  const ov = document.getElementById("busyOverlay");
  const bt = document.getElementById("busyText");
  if (bt && text) bt.textContent = text;
  if (ov) ov.classList.remove("hidden");
}
function hideBusy() {
  const ov = document.getElementById("busyOverlay");
  if (ov) ov.classList.add("hidden");
}

/* =================== 40 NAWIGACJA / ROUTER =================== */
function ukryjWszystkie() {
  document.querySelectorAll(".container").forEach(v => v.classList.add("hidden"));
}

function goToView(viewId, options = {}) {
  const { replace = false } = options;

  const el = document.getElementById(viewId);
  if (el) {
    // Najpierw poka≈º nowy widok (≈ºeby nie zosta≈Ç ukryty przez ukryjWszystkie)
    el.classList.remove("hidden");
  }

  ukryjWszystkie();  // Teraz ukryj resztƒô ‚Äì nowy widok ju≈º jest widoczny

  currentView = viewId;
  const state = { view: viewId };
  try {
    if (replace) history.replaceState(state, "", "");
    else history.pushState(state, "", "");
  } catch (e) {}
}

function showViewFromHistory(viewId) {
  ukryjWszystkie();
  const el = document.getElementById(viewId);
  if (el) el.classList.remove("hidden");
  currentView = viewId;
}

function appBack() { history.back(); }

window.addEventListener("popstate", (event) => {
  const state = event.state;
  if (state && state.view) showViewFromHistory(state.view);
  else showViewFromHistory((clubId && isCfgLocked_()) ? "loginView" : "orgHubLandingView");
});

function refreshClubBadge_() {
  const el = document.getElementById("clubIdBadge");
  if (el) el.textContent = (clubId || "").toUpperCase();
}

function applyTheme_(theme) {
  try {
    if (theme?.bgColor) document.body.style.backgroundColor = theme.bgColor;

    const logoImg = document.querySelector("#loginView img.logo") || document.querySelector("#loginView img");
    if (logoImg && theme?.logoUrl) logoImg.src = theme.logoUrl;

  } catch (e) {}
}

async function startApp_() {

  const params = new URLSearchParams(window.location.search);
  const clubFromUrl = params.get("clubId");

  // --- KOLOR ---
  if (!clubFromUrl) {

    // Fabryka = zawsze bia≈Ço
    document.body.style.backgroundColor = "#ffffff";

  } else {

    try {
      const branding = await apiClubGet("branding", {});

      if (branding?.bg_color) {
        document.body.style.backgroundColor = branding.bg_color;
      }

      if (branding?.logo_data) {
        const logoImg =
          document.querySelector("#loginView img.logo") ||
          document.querySelector("#loginView img");

        if (logoImg) logoImg.src = branding.logo_data;
      }

    } catch (e) {
      console.warn("Branding load failed", e);
    }

  }

  // --- ROUTER ---
  refreshClubBadge_();
  goToView(clubFromUrl ? "loginView" : "orgHubLandingView", { replace: true });
}

/* =================== 50 API (CORE / CLUB) =================== */
function requireClubId() {
  if (!clubId) throw new Error("Brak clubId. Najpierw skonfiguruj klub.");
}

// POST do CORE bez clubId (np. createClub)
async function apiCorePost(payload = {}) {
  const body = new URLSearchParams({ ...payload });
  const res = await fetch(CORE_URL, { method: "POST", body });
  return res.json();
}

// GET/POST do CLUB (wymaga clubId)
async function apiClubGet(action, params = {}) {
  requireClubId();
  const url = new URL(CORE_URL);
  url.searchParams.set("action", action);
  url.searchParams.set("clubId", clubId);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v ?? ""));
  const res = await fetch(url.toString(), { cache: "no-store" });
  return res.json();
}

function extractGasError_(html) {
  try {
    // Najczƒô≈õciej w≈Ça≈õciwy komunikat siedzi w <div class="errorMessage">...</div>
    const m = String(html || "").match(/<div class="errorMessage"[^>]*>([\s\S]*?)<\/div>/i);
    if (!m) return "";
    // usu≈Ñ tagi i zbij spacje
    return m[1]
      .replace(/<br\s*\/?>/gi, "\n")
      .replace(/<[^>]+>/g, "")
      .replace(/\s+\n/g, "\n")
      .replace(/\n\s+/g, "\n")
      .trim();
  } catch (e) {
    return "";
  }
}

async function apiClubPost(payload = {}) {
  requireClubId();
  const body = new URLSearchParams({ clubId, ...payload });
  const res = await fetch(CORE_URL, { method: "POST", body });

  const text = await res.text();

  // 1) normalny JSON
  try {
    return JSON.parse(text);
  } catch (e) {}

  // 2) HTML z GAS ‚Äî wyciƒÖgamy sensowny komunikat
  const msg = extractGasError_(text);
  return {
    ok: false,
    error: msg ? ("GAS ERROR: " + msg) : ("Backend zwr√≥ci≈Ç nie-JSON (" + res.status + ")."),
    raw: text.slice(0, 600)
  };
}


/* =================== 60 ORGHUB START / KONFIGURACJA =================== */
// Tu masz dwa widoki: orgHubLandingView (start) i clubConfigView (panel)
// Docelowo zrobimy ‚Äúprzycisk zamienia siƒô w input‚Äù ‚Äî ale to bƒôdzie kolejny krok.

let cfgDraft = {
  clubName: "",
  email: "",
  sezonStart: "", // YYYY-MM-01
  sezonEnd: "",   // YYYY-MM-30 (tymczasowo)
  bgColor: "#000000",
  logoDataUrl: "" // dataURL
};

// paleta (wiƒôcej kolor√≥w zrobimy w nastƒôpnym kroku)
const COLOR_PRESETS = [
  // Czarne / szaro≈õci (2 odcienie)
  "#000000", "#1a1a1a",

  // Granat (2)
  "#0b1b2b", "#123a5a",

  // Niebieski (2)
  "#0b2b5a", "#1a4fa3",

  // Turkus (2)
  "#0b2b2b", "#118a8a",

  // Ziele≈Ñ (2)
  "#0b2b1b", "#1f7a3a",

  // Oliwka (2)
  "#2b2b0b", "#7a7a1f",

  // Pomara≈Ñcz/brƒÖz (2)
  "#2b1b0b", "#a35a1a",

  // Bordo/fiolet (2)
  "#2b0b1b", "#6a1b3a"
];

  const COLOR_NAMES = {
  // Czarne / szaro≈õci
  "#000000": "Czarny",
  "#1a1a1a": "Grafit",

  // Granat
  "#0b1b2b": "Granat",
  "#123a5a": "Granat jasny",

  // Niebieski
  "#0b2b5a": "Niebieski",
  "#1a4fa3": "Niebieski jasny",

  // Turkus
  "#0b2b2b": "Turkus",
  "#118a8a": "Turkus jasny",

  // Ziele≈Ñ
  "#0b2b1b": "Ziele≈Ñ",
  "#1f7a3a": "Ziele≈Ñ jasna",

  // Oliwka
  "#2b2b0b": "Oliwka",
  "#7a7a1f": "Oliwka jasna",

  // Pomara≈Ñcz/brƒÖz
  "#2b1b0b": "BrƒÖz",
  "#a35a1a": "Pomara≈Ñcz",

  // Bordo/fiolet
  "#2b0b1b": "Bordo",
  "#6a1b3a": "Fiolet"
};


 function clubNameEditStart() {
  const btn = document.getElementById("btnClubName");
  const span = document.getElementById("clubNameText");
  const input = document.getElementById("clubNameInput");
  if (!btn || !span || !input) return;

  // poka≈º input w klawiszu
  span.classList.add("hidden");
  input.classList.remove("hidden");
  input.value = cfgDraft.clubName || "";
  input.focus();
  input.select();

  // podpinamy handlery tylko raz
  if (input.dataset.bound === "1") return;
  input.dataset.bound = "1";

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      clubNameEditCommit();
    }
    if (e.key === "Escape") {
      e.preventDefault();
      clubNameEditCancel();
    }
  });

  input.addEventListener("blur", () => {
    clubNameEditCommit();
  });
}

function clubNameEditCommit() {
  const span = document.getElementById("clubNameText");
  const input = document.getElementById("clubNameInput");
  if (!span || !input) return;

  const v = String(input.value || "").trim();
  cfgDraft.clubName = v;

  // wr√≥ƒá do trybu "klawisz"
  input.classList.add("hidden");
  span.classList.remove("hidden");

  // tekst w klawiszu
  span.textContent = v ? v : "Podaj nazwƒô klubu";
}

function clubNameEditCancel() {
  const span = document.getElementById("clubNameText");
  const input = document.getElementById("clubNameInput");
  if (!span || !input) return;

  input.classList.add("hidden");
  span.classList.remove("hidden");
  span.textContent = cfgDraft.clubName ? cfgDraft.clubName : "Podaj nazwƒô klubu";
}

function seasonStartPick() {
  const span = document.getElementById("seasonStartText");
  const input = document.getElementById("seasonStartInput");
  if (!span || !input) return;

  // poka≈º input (kalendarz) w klawiszu
  span.classList.add("hidden");
  input.classList.remove("hidden");

  // ustaw aktualnƒÖ warto≈õƒá je≈õli jest
  input.value = cfgDraft.sezonStart ? String(cfgDraft.sezonStart).slice(0, 10) : "";

  // otw√≥rz picker (je≈õli przeglƒÖdarka pozwala)
  try { input.showPicker && input.showPicker(); } catch (e) {}

  if (input.dataset.bound === "1") return;
  input.dataset.bound = "1";

  input.addEventListener("change", () => {
    const v = String(input.value || "").trim(); // YYYY-MM-DD
    cfgDraft.sezonStart = v; // trzymamy pe≈ÇnƒÖ datƒô

    // wr√≥ƒá do klawisza z datƒÖ
    input.classList.add("hidden");
    span.classList.remove("hidden");
    span.textContent = v ? v : "PoczƒÖtek sezonu";
  });

  input.addEventListener("blur", () => {
    // jak user wyjdzie bez wyboru, wr√≥ƒá do trybu klawisza
    input.classList.add("hidden");
    span.classList.remove("hidden");
    span.textContent = cfgDraft.sezonStart ? cfgDraft.sezonStart : "PoczƒÖtek sezonu";
  });
}

  function seasonEndPick() {
  const span = document.getElementById("seasonEndText");
  const input = document.getElementById("seasonEndInput");
  if (!span || !input) return;

  // poka≈º input (kalendarz) w klawiszu
  span.classList.add("hidden");
  input.classList.remove("hidden");

  // ustaw aktualnƒÖ warto≈õƒá je≈õli jest
  input.value = cfgDraft.sezonEnd ? String(cfgDraft.sezonEnd).slice(0, 10) : "";

  // otw√≥rz picker (je≈õli przeglƒÖdarka pozwala)
  try { input.showPicker && input.showPicker(); } catch (e) {}

  if (input.dataset.bound === "1") return;
  input.dataset.bound = "1";

  input.addEventListener("change", () => {
    const v = String(input.value || "").trim(); // YYYY-MM-DD
    cfgDraft.sezonEnd = v;

    // wr√≥ƒá do klawisza z datƒÖ
    input.classList.add("hidden");
    span.classList.remove("hidden");
    span.textContent = v ? v : "Koniec sezonu";
  });

  input.addEventListener("blur", () => {
    input.classList.add("hidden");
    span.classList.remove("hidden");
    span.textContent = cfgDraft.sezonEnd ? cfgDraft.sezonEnd : "Koniec sezonu";
  });
}

function emailEditStart() {
  const span = document.getElementById("emailText");
  const input = document.getElementById("emailInput");
  if (!span || !input) return;

  span.classList.add("hidden");
  input.classList.remove("hidden");
  input.value = cfgDraft.email || "";
  input.focus();
  input.select();

  if (input.dataset.bound === "1") return;
  input.dataset.bound = "1";

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      emailEditCommit();
    }
    if (e.key === "Escape") {
      e.preventDefault();
      emailEditCancel();
    }
  });

  input.addEventListener("blur", () => {
    emailEditCommit();
  });
}

function emailEditCommit() {
  const span = document.getElementById("emailText");
  const input = document.getElementById("emailInput");
  if (!span || !input) return;

  const v = String(input.value || "").trim();
  cfgDraft.email = v;

  input.classList.add("hidden");
  span.classList.remove("hidden");
  span.textContent = v ? v : "Tw√≥j email";
}

function emailEditCancel() {
  const span = document.getElementById("emailText");
  const input = document.getElementById("emailInput");
  if (!span || !input) return;

  input.classList.add("hidden");
  span.classList.remove("hidden");
  span.textContent = cfgDraft.email ? cfgDraft.email : "Tw√≥j email";
}
  
function renderConfigUI_() {
  const nameEl = document.getElementById("cfgClubNameLabel");
  const ssEl = document.getElementById("cfgSeasonStartLabel");
  const seEl = document.getElementById("cfgSeasonEndLabel");
  const emEl = document.getElementById("cfgEmailLabel");
  const colEl = document.getElementById("cfgColorLabel");
  const prev = document.getElementById("cfgLogoPreview");
  const grid = document.getElementById("cfgColorGrid");

  // POD PRZYCISKAMI ZAWSZE PUSTO
  if (nameEl) nameEl.textContent = "";
  if (ssEl) ssEl.textContent = "";
  if (seEl) seEl.textContent = "";
  if (emEl) emEl.textContent = "";
  if (colEl) colEl.textContent = "";

  // LOGO ‚Äì bez zmian
  if (prev) {
    if (cfgDraft.logoDataUrl) {
      prev.src = cfgDraft.logoDataUrl;
      prev.style.display = "inline-block";
    } else {
      prev.style.display = "none";
    }
  }

  // SIATKA KOLOR√ìW ‚Äì bez opisu tekstowego
  if (grid) {
    grid.innerHTML = COLOR_PRESETS.map(c => `
      <div onclick="setBgColor('${c}')" style="
        width:100%;
        aspect-ratio:1/1;
        border-radius:10px;
        border:1px solid #444;
        background:${c};
        cursor:pointer;">
      </div>
    `).join("");
  }
}

function goToConfig() {
  // je≈õli klub ju≈º skonfigurowany i config zablokowany ‚Äì nie pokazuj panelu
  if (clubId && isCfgLocked_()) {
    goToView("loginView");
    return;
  }

  const saved = loadLocalClubConfig();
  if (saved) cfgDraft = { ...cfgDraft, ...saved };

  renderConfigUI_();
  goToView("clubConfigView");
}

function goBackFromConfig() {
  goToView(clubId ? "loginView" : "orgHubLandingView");
}

function toggleColorPicker(show) {
  const grid = document.getElementById("cfgColorGrid");
  if (!grid) return;
  if (show) grid.classList.remove("hidden");
  else grid.classList.add("hidden");
}

function setBgColor(color) {
  cfgDraft.bgColor = color;
  document.body.style.backgroundColor = color;

  // Pod przyciskiem ma byƒá zawsze pusto
  const colEl = document.getElementById("cfgColorLabel");
  if (colEl) colEl.textContent = "";

  // Tekst NA KLAWISZU ma pokazywaƒá nazwƒô wybranego koloru
  const btn = document.querySelector("#clubConfigView button[onclick*='toggleColorPicker']");
  if (btn) {
    const name = (COLOR_NAMES && COLOR_NAMES[color]) ? COLOR_NAMES[color] : "Kolor t≈Ça";
    btn.textContent = name;
    btn.classList.add("alt");
  }

  // opcjonalnie: schowaj siatkƒô po wyborze
  toggleColorPicker(false);
}

function pickLogo() {
  const input = document.getElementById("cfgLogoInput");
  if (!input) return;

  input.onchange = async () => {
    const file = input.files && input.files[0];
    if (!file) return;

    if (file.size > 2 * 1024 * 1024) {
      const msg = document.getElementById("cfgMsg");
      if (msg) msg.textContent = "‚ùå Logo za du≈ºe (max ~2MB).";
      return;
    }

    cfgDraft.logoDataUrl = await fileToDataUrl_(file);
    renderConfigUI_();
  };

  input.click();
}

function fileToDataUrl_(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}


/* =================== 61 WYS≈ÅANIE KONFIGURACJI -> CREATECLUB =================== */
function validateCfg_() {
  if (!cfgDraft.logoDataUrl) return "Wgraj logo.";
  if (!cfgDraft.clubName) return "Podaj nazwƒô klubu.";
  if (!cfgDraft.sezonStart) return "Podaj poczƒÖtek sezonu.";
  if (!cfgDraft.sezonEnd) return "Podaj koniec sezonu.";
  if (!cfgDraft.bgColor) return "Wybierz kolor t≈Ça.";
  if (!cfgDraft.email) return "Podaj email admina.";
  if (cfgDraft.sezonStart > cfgDraft.sezonEnd) return "PoczƒÖtek sezonu nie mo≈ºe byƒá po ko≈Ñcu sezonu.";
  return "";
}

async function submitClubConfig() {
  const msg = document.getElementById("cfgMsg");
  if (msg) msg.textContent = "";

  const err = validateCfg_();
  if (err) {
    if (msg) msg.textContent = "‚ùå " + err;
    return;
  }

  // zapis roboczy lokalnie (≈ºeby nie zginƒô≈Ço po od≈õwie≈ºeniu)
  saveLocalClubConfig({ ...cfgDraft });

  showBusy("Tworzƒô pliki klubu i konfiguracjƒô sezonu‚Ä¶");

  try {
    const r = await apiCorePost({
      action: "createClub",
      clubName: cfgDraft.clubName,
      sezonStart: cfgDraft.sezonStart,
      sezonEnd: cfgDraft.sezonEnd,
      bgColor: cfgDraft.bgColor,
      ownerEmail: cfgDraft.email,
      logoBase64: cfgDraft.logoDataUrl
    });

    if (!r || (r.success !== true && r.ok !== true)) {
      hideBusy();
      if (msg) msg.textContent = "‚ùå " + (r?.error || r?.message || JSON.stringify(r));
      return;
    }

    if (!r.clubId) {
      hideBusy();
      if (msg) msg.textContent = "‚ùå CORE nie zwr√≥ci≈Ç clubId.";
      return;
    }

// ustaw clubId
saveClubId_(r.clubId);

// zablokuj panel konfiguracyjny na tym urzƒÖdzeniu
lockCfg_();

    // theme
    const theme = {
      bgColor: r.bgColor || cfgDraft.bgColor,
      logoUrl: r.logoUrl || cfgDraft.logoDataUrl, // je≈õli CORE nie hostuje jeszcze logo, u≈ºyj dataUrl
      clubName: r.clubName || cfgDraft.clubName
    };
    saveTheme_(theme);
    applyTheme_(theme);

    // utrwal config (z clubId)
    saveLocalClubConfig({ ...cfgDraft, clubId: r.clubId });

hideBusy();

goToConfig2();
refreshClubBadge_();    

    } catch (e) {
    hideBusy();
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

function goToConfig2() {
  goToView("clubSetupView");
}

// mo≈ºesz od razu dodaƒá te≈º funkcjƒô powrotu (opcjonalnie, ale warto)
function goBackFromSetup() {
  goToView("clubConfigView");
}
    
/* =================== 70 LOGOWANIE / REJESTRACJA =================== */
function pokazLogowanie() {
  numerZalogowanego = null;
  grupaZalogowanego = null;
  window.grupyTrenera = "";
  refreshClubBadge_();
  goToView("loginView");
}
function pokazRejestracjaSelect() { goToView("registerSelectView"); }
function pokazRejestracjaZawodnik() { goToView("registerZawodnikView"); }
function pokazRejestracjaTrener() { goToView("rejestracjaTrenerView"); }
  

async function zaloguj() {
  const login = document.getElementById("numer").value.trim();
  const haslo = document.getElementById("haslo").value.trim();
  const komunikat = document.getElementById("komunikat");

  if (!clubId) { komunikat.innerText = "Najpierw skonfiguruj klub."; goToView("orgHubLandingView"); return; }
  if (!login || !haslo) { komunikat.innerText = "Podaj login i has≈Ço."; return; }

  komunikat.innerText = "Trwa logowanie...";

  try {
    const data = await apiClubPost({ mode: "login", numer: login, haslo });

    if (!data.success) {
      komunikat.innerText = "‚ùå " + (data.message || "B≈ÇƒÖd logowania");
      return;
    }

    komunikat.innerText = "‚úÖ Zalogowano";

    if (data.role === "zawodnik") {
      numerZalogowanego = data.login;
      grupaZalogowanego = data.grupa || "";

      const platnosci = await apiClubGet("platnosci", { numer: numerZalogowanego });
      if (Array.isArray(platnosci) && platnosci.length > 0) {
        goToView("platnosciView");
        renderPlatnosci(platnosci);
        return;
      }

      await pokazTreningi();
      return;
    }

    if (data.role === "trener") {
      window.grupyTrenera = data.grupa || "";
      goToView("trainerPanelView");
      return;
    }

  } catch (e) {
    komunikat.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

/* =================== 75 REJESTRACJA =================== */
async function wyslijRejestracje() {
  const numer = document.getElementById("regNumer").value.trim();
  const nazwisko = document.getElementById("regNazwisko").value.trim();
  const haslo = document.getElementById("regHaslo").value.trim();
  const msg = document.getElementById("regMsg");

  if (!numer || !nazwisko || !haslo) {
    msg.innerText = "Wype≈Çnij wszystkie pola.";
    return;
  }

  msg.innerText = "‚è≥ Rejestracja...";
  try {
    const data = await apiClubPost({ mode: "rejestracja", numer, nazwisko, haslo });

    if (data && data.ok) {
      document.getElementById("regNumer").value = "";
      document.getElementById("regNazwisko").value = "";
      document.getElementById("regHaslo").value = "";
      msg.innerText = "‚úÖ Rejestracja zako≈Ñczona!";
      setTimeout(() => { msg.innerText = ""; pokazLogowanie(); }, 1500);
    } else {
      msg.innerText = "‚ùå " + (data?.error || data?.message || data?.msg || JSON.stringify(data));
    }
  } catch (e) {
    msg.innerText = "‚ùå " + (e?.message || e);
  }
}

async function wyslijRejestracjeTrener() {
  const poleNazw = document.getElementById("regNazwiskoTrener");
  const poleHaslo = document.getElementById("regHasloTrener");
  const msg = document.getElementById("regMsgTrener");

  const nazwisko = poleNazw.value.trim();
  const haslo = poleHaslo.value.trim();

  if (!nazwisko || !haslo) {
    msg.innerText = "Wype≈Çnij wszystkie pola.";
    return;
  }

  msg.innerText = "‚è≥ Rejestracja...";

  try {
    const data = await apiClubPost({
      mode: "rejestracjaTrener",
      nazwisko,
      haslo
    });

    if (data && data.ok) {
      const inic = String(data.inic || "").toUpperCase() || "(?)";

      msg.innerHTML = `
        ‚úÖ <b>Zarejestrowano trenera!</b><br>
        Login do systemu:<br>
        <div style="font-size:22px;font-weight:800;letter-spacing:2px;margin:10px 0 14px 0;">
          ${inic}
        </div>

        <button class="full-btn" id="btnCopyInic">üìã Skopiuj login</button>
        <button class="full-btn alt" id="btnGoLogin" disabled>
          ‚û°Ô∏è Przejd≈∫ do logowania
        </button>

        <div id="copyInfo" style="opacity:.8;margin-top:10px;font-size:13px;"></div>
      `;

      poleNazw.value = "";
      poleHaslo.value = "";

      const btnCopy = document.getElementById("btnCopyInic");
      const btnGo = document.getElementById("btnGoLogin");
      const info = document.getElementById("copyInfo");

      if (btnCopy) {
        btnCopy.onclick = async () => {
          try {
            await navigator.clipboard.writeText(inic);
            btnCopy.textContent = "‚úÖ Skopiowano";
            if (info) info.textContent = "Mo≈ºesz teraz przej≈õƒá do logowania.";
            if (btnGo) btnGo.disabled = false;
          } catch (e) {
            if (info) {
              info.textContent =
                "‚ùå Nie uda≈Ço siƒô skopiowaƒá. Zaznacz login rƒôcznie: " + inic;
            }
          }
        };
      }

      if (btnGo) {
        btnGo.onclick = () => pokazLogowanie();
      }

    } else {
      msg.innerText =
        "‚ùå " + (data?.error || data?.message || data?.msg || JSON.stringify(data));
    }

  } catch (e) {
    msg.innerText = "‚ùå " + (e?.message || e);
  }
}



/* =================== 80 ZAWODNIK: TRENINGI / ZAPISY =================== */
function renderPlatnosci(lista) {
  const div = document.getElementById("listaPlatnosci");
  if (!lista?.length) {
    div.innerHTML = "<p>Brak zaleg≈Ço≈õci ‚úÖ</p>" +
      "<button class='full-btn' onclick='pokazTreningi()'>Dalej ‚û°</button>";
    return;
  }

  div.innerHTML =
    "<h3>Zaleg≈Çe p≈Çatno≈õci:</h3>" +
    lista.map(p => `<div class='card' style='background:#a00;'>üî¥ ${p.nazwa} ‚Äì ${p.kwota} z≈Ç</div>`).join('') +
    `<button class='full-btn' onclick='pokazTreningi()' style='margin-top:20px;'>Dalej ‚û°</button>`;
}

async function pokazTreningi() {
  goToView("homeView");
  const lista = await apiClubGet("treningi", { grupa: grupaZalogowanego, numer: numerZalogowanego });
  renderTreningi(lista);
}

function renderTreningi(lista) {
  const div = document.getElementById('listaTreningow');
  if (!lista?.length) { div.innerHTML = "<p>Brak wydarze≈Ñ</p>"; return; }

  div.innerHTML = lista.map(t => `
    <div class="card">
      <p>
        <b>${t.rodzaj}</b> &nbsp;&nbsp; ${t.data} (${t.dzien})<br>
        Godzina: <b>${t.godzStart}</b> ‚Äì <b>${t.godzKoniec}</b><br>
        Trener: <b>${t.trener}</b> &nbsp;&nbsp; Zapisanych: ${t.zapisanych}
      </p>

      <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;">
        <button id="btn-${t.id}" ${t.zapisany ? 'disabled' : ''} onclick="zapiszSie('${t.id}')">
          ${t.zapisany ? 'Zapisano ‚úÖ' : 'Zapisz siƒô'}
        </button>
        <button id="wypisz-${t.id}" ${t.zapisany ? '' : 'disabled'} style="background:#444;" onclick="wypiszSie('${t.id}')">
          Wypisz siƒô
        </button>
        <button style="background:#333;" onclick="toggleZapisani('${t.id}')">üë• Zapisani</button>
      </div>

      <div id="zapisani-${t.id}" class="hidden lista-zapisanych"></div>
    </div>
  `).join('');
}

async function toggleZapisani(id) {
  const box = document.getElementById(`zapisani-${id}`);
  if (!box) return;

  if (!box.classList.contains('hidden')) { box.classList.add('hidden'); return; }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>';

  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd pobierania listy</div>';
  }
}

async function zapiszSie(id) {
  const btn = document.getElementById(`btn-${id}`);
  const wypiszBtn = document.getElementById(`wypisz-${id}`);
  const box = document.getElementById(`zapisani-${id}`);

  btn.classList.add("loading");
  try {
    const r = await apiClubGet("zapisz", { numer: numerZalogowanego, treningId: id });
    if (r.ok) {
      btn.innerText = "Zapisano ‚úÖ";
      btn.disabled = true;
      wypiszBtn.disabled = false;
      if (box && !box.classList.contains("hidden")) await odswiezListeZapisanych(id);
    } else alert(r.message);
  } catch (err) {
    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + err);
  } finally {
    btn.classList.remove("loading");
  }
}

async function wypiszSie(id) {
  const btn = document.getElementById(`wypisz-${id}`);
  const zapiszBtn = document.getElementById(`btn-${id}`);
  const box = document.getElementById(`zapisani-${id}`);

  btn.classList.add("loading");
  try {
    const r = await apiClubGet("wypisz", { numer: numerZalogowanego, treningId: id });
    if (r.ok) {
      zapiszBtn.innerText = "Zapisz siƒô";
      zapiszBtn.disabled = false;
      btn.disabled = true;
      if (box && !box.classList.contains("hidden")) await odswiezListeZapisanych(id);
    } else alert(r.message);
  } catch (err) {
    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + err);
  } finally {
    btn.classList.remove("loading");
  }
}

async function odswiezListeZapisanych(id) {
  const box = document.getElementById(`zapisani-${id}`);
  if (!box) return;

  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ Od≈õwie≈ºanie...</div>';
  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd od≈õwie≈ºania</div>';
  }
}

/* =================== 90 TRENER: LISTA / WYDARZENIA / DODAWANIE / USUWANIE =================== */
function trainerPowrot() { appBack(); }

  // ‚úÖ MUSI byƒá globalne dla onclick w HTML
window.trainerPokazWydarzenia = async function trainerPokazWydarzenia() {
  goToView("trainerWydarzeniaView");
  try {
    const lista = await apiClubGet("treningiTrener", { grupa: window.grupyTrenera || "" });
    renderTreningiTrainer(lista);
  } catch (e) {
    const div = document.getElementById("trainerListaWydarzen");
    if (div) div.innerHTML = `<div class="card" style="background:#700;">‚ùå B≈ÇƒÖd: ${e?.message || e}</div>`;
  }
};

async function trainerPokazZawodnicy() {
  goToView("trainerZawodnicyView");
  const box = document.getElementById("trainerListaZawodnikow");
  box.innerHTML = "<div class='card' style='background:#222;'>‚è≥ ≈Åadowanie...</div>";

  try {
    const lista = await apiClubGet("listaZawodnikow", { grupy: window.grupyTrenera || "" });
    if (!Array.isArray(lista) || lista.length === 0) {
      box.innerHTML = "<div class='card' style='background:#111;'>Brak danych</div>";
      return;
    }

    box.innerHTML = lista.map(z => `
      <div class="card" style="text-align:left;">
        <b>#${z.nr}</b> ‚Äî ${z.nazwisko}<br>
        <span style="opacity:0.8;">${z.suma} trening√≥w ≈ÇƒÖcznie</span>
      </div>
    `).join('');
  } catch {
    box.innerHTML = "<div class='card' style='background:#700;'>B≈ÇƒÖd pobierania danych</div>";
  }
}

function renderTreningiTrainer(lista) {
  const div = document.getElementById("trainerListaWydarzen");
  if (!lista?.length) { div.innerHTML = "<p>Brak wydarze≈Ñ</p>"; return; }

  // ‚úÖ Globalna mapa event√≥w dla popupu edycji
  window.__trainerEventsByKey = {};

  // lokalny parser "dd.mm.yyyy" albo "dd-mm-yyyy" -> "yyyy-mm-dd"
  function toISO_(dataTxt) {
    const s = String(dataTxt || "").trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    const m = s.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{4})$/);
    if (!m) return "";
    const dd = String(m[1]).padStart(2, "0");
    const mm = String(m[2]).padStart(2, "0");
    const yyyy = m[3];
    return `${yyyy}-${mm}-${dd}`;
  }

  div.innerHTML = lista.map(t => {
    const key = `${t.miesiac}-${t.czasCol}`;
    const dataISO = toISO_(t.data);

    // ‚úÖ zapisz dane do edycji (bez wrzucania obiekt√≥w do onclick)
    window.__trainerEventsByKey[key] = {
      key,
      miesiac: t.miesiac,
      czasCol: t.czasCol,
      dataISO,
      start: String(t.godzStart || ""),
      end: String(t.godzKoniec || ""),
      rodzaj: String(t.rodzaj || ""),
    };

    return `
      <div class="card" data-event-id="${key}">
        <b>${t.rodzaj}</b> ${t.data} (${t.dzien})<br>
        Godzina: <b>${t.godzStart}</b> ‚Äì <b>${t.godzKoniec}</b><br>
        Trener: <b>${t.trener || "‚Äî"}</b> | Zapisanych: ${t.zapisanych}<br><br>

        <div style="display:flex; justify-content:center; gap:8px; flex-wrap:wrap;">
          <button class="btn" onclick="trainerToggleZapisani('${t.id}')">üë• Zapisani</button>
          <button class="btn" onclick="trainerShowEditPopup('${t.miesiac}', ${t.czasCol})">‚úèÔ∏è Edytuj</button>
          <button class="btn danger" onclick="trainerShowDeletePopup('${t.miesiac}', ${t.czasCol})">üóëÔ∏è Usu≈Ñ</button>
        </div>

        <div id="trainer-zapisani-${t.id}" class="hidden"></div>
      </div>
    `;
  }).join('');
}


async function trainerToggleZapisani(id) {
  const box = document.getElementById(`trainer-zapisani-${id}`);
  if (!box) return;

  if (!box.classList.contains('hidden')) { box.classList.add('hidden'); return; }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>';

  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd pobierania listy</div>';
  }
}

/* --- dodawanie wydarzenia --- */
async function zaladujListeTrenerow() {
  try {
    const lista = await apiClubGet("getTrenerzy", {});
    const t1 = document.getElementById("eventTrener1");
    const t2 = document.getElementById("eventTrener2");
    t1.innerHTML = "<option value=''>‚Äî wybierz trenera ‚Äî</option>";
    t2.innerHTML = "<option value=''>‚Äî Brak ‚Äî</option>";
    (lista || []).forEach(nazw => {
      t1.innerHTML += `<option value="${nazw}">${nazw}</option>`;
      t2.innerHTML += `<option value="${nazw}">${nazw}</option>`;
    });
  } catch {}
}

  function resetTrenerSelects_() {
  // ukryj kolejne selecty
  ["trener2Wrap","trener3Wrap","trener4Wrap"].forEach(id => {
    const w = document.getElementById(id);
    if (w) w.classList.add("hidden");
  });

  // wyczy≈õƒá warto≈õci (≈ºeby nie ‚Äúpamiƒôta≈Ço‚Äù)
  ["eventTrener1","eventTrener2","eventTrener3","eventTrener4"].forEach(id => {
    const s = document.getElementById(id);
    if (s) s.value = "";
  });
}

// pokazuj kolejny select dopiero gdy wybrano poprzedni
function onTrenerPick(n) {
  const cur = document.getElementById(`eventTrener${n}`);
  const nextWrap = document.getElementById(`trener${n+1}Wrap`);
  if (!cur) return;

  const picked = String(cur.value || "").trim();
  if (nextWrap) {
    if (picked) nextWrap.classList.remove("hidden");
    else nextWrap.classList.add("hidden");
  }
}

  /* ===== EDYCJA: TRENERZY (selecty) ===== */
async function zaladujListeTrenerowDoEdycji() {
  try {
    const lista = await apiClubGet("getTrenerzy", {});
    const ids = ["editTrener1","editTrener2","editTrener3","editTrener4"];

    ids.forEach((id, idx) => {
      const sel = document.getElementById(id);
      if (!sel) return;

      // pierwsza lista ma "wybierz", kolejne majƒÖ "kolejny"
      const firstOpt = (idx === 0)
        ? "<option value=''>‚Äî wybierz trenera ‚Äî</option>"
        : "<option value=''>‚Äî kolejny trener ‚Äî</option>";

      sel.innerHTML = firstOpt + (lista || []).map(n => `<option value="${n}">${n}</option>`).join("");
    });
  } catch (e) {
    console.warn("Nie uda≈Ço siƒô wczytaƒá trener√≥w do edycji", e);
  }
}

function resetEditTrenerSelects_() {
  ["editTrener2Wrap","editTrener3Wrap","editTrener4Wrap"].forEach(id => {
    const w = document.getElementById(id);
    if (w) w.classList.add("hidden");
  });

  ["editTrener1","editTrener2","editTrener3","editTrener4"].forEach(id => {
    const s = document.getElementById(id);
    if (s) s.value = "";
  });
}

function onEditTrenerPick(n) {
  const cur = document.getElementById(`editTrener${n}`);
  const nextWrap = document.getElementById(`editTrener${n+1}Wrap`);
  if (!cur) return;

  const picked = String(cur.value || "").trim();
  if (nextWrap) {
    if (picked) nextWrap.classList.remove("hidden");
    else nextWrap.classList.add("hidden");
  }
}

/* ===== EDYCJA: GRUPY (popup G1‚ÄìG10) ===== */
let selectedEditGroups = new Set(); // np. "G1","G2"...

function renderEditGroupsList_() {
  const box = document.getElementById("editGroupsList");
  if (!box) return;

  const groups = Array.from({ length: 10 }, (_, i) => `G${i + 1}`);

  box.innerHTML = groups.map(g => {
    const checked = selectedEditGroups.has(g) ? "checked" : "";
    return `
      <label style="display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid #333;border-radius:10px;background:#111;">
        <span style="font-weight:700;">${g}</span>
        <input type="checkbox" class="editGrpPick" value="${g}" ${checked} style="transform:scale(1.25);">
      </label>
    `;
  }).join("");
}

function openEditGroupsPopup() {
  renderEditGroupsList_();
  const pop = document.getElementById("editGroupsPopup");
  if (pop) pop.classList.remove("hidden");
}

function closeEditGroupsPopup() {
  const pop = document.getElementById("editGroupsPopup");
  if (pop) pop.classList.add("hidden");
}

function applyEditGroupsPopup() {
  const picks = document.querySelectorAll("#editGroupsList .editGrpPick");
  selectedEditGroups = new Set();
  picks.forEach(ch => { if (ch.checked) selectedEditGroups.add(ch.value); });

  updateEditGroupsSummary_();
  closeEditGroupsPopup();
}

function updateEditGroupsSummary_() {
  const el = document.getElementById("editGroupsSummary");
  if (!el) return;

  const arr = Array.from(selectedEditGroups);
  arr.sort((a, b) => Number(a.slice(1)) - Number(b.slice(1)));

  el.textContent = arr.length ? `‚úÖ Wybrane: ${arr.join(", ")}` : "‚Äî";
}

function resetEditGroups_() {
  selectedEditGroups = new Set();
  updateEditGroupsSummary_();
}

function pokazDodajWydarzenie() {
  goToView("trainerDodajWydarzenieView");
  resetTrenerSelects_();
  resetGroups_();
  zaladujListeTrenerow();
}

  /* ===== GRUPY: popup G1‚ÄìG10 ===== */
let selectedGroups = new Set(); // np. "G1","G2"...

function renderGroupsList_() {
  const box = document.getElementById("groupsList");
  if (!box) return;

  const groups = Array.from({ length: 10 }, (_, i) => `G${i + 1}`);

  box.innerHTML = groups.map(g => {
    const checked = selectedGroups.has(g) ? "checked" : "";
    return `
      <label style="display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid #333;border-radius:10px;background:#111;">
        <span style="font-weight:700;">${g}</span>
        <input type="checkbox" class="grpPick" value="${g}" ${checked} style="transform:scale(1.25);">
      </label>
    `;
  }).join("");
}

function openGroupsPopup() {
  renderGroupsList_();
  const pop = document.getElementById("groupsPopup");
  if (pop) pop.classList.remove("hidden");
}

function closeGroupsPopup() {
  const pop = document.getElementById("groupsPopup");
  if (pop) pop.classList.add("hidden");
}

function applyGroupsPopup() {
  const picks = document.querySelectorAll("#groupsList .grpPick");
  selectedGroups = new Set();
  picks.forEach(ch => { if (ch.checked) selectedGroups.add(ch.value); });

  updateGroupsSummary_();
  closeGroupsPopup();
}

function updateGroupsSummary_() {
  const el = document.getElementById("groupsSummary");
  if (!el) return;

  const arr = Array.from(selectedGroups);
  arr.sort((a, b) => Number(a.slice(1)) - Number(b.slice(1)));

  el.textContent = arr.length ? `‚úÖ Wybrane: ${arr.join(", ")}` : "‚Äî";
}

function resetGroups_() {
  selectedGroups = new Set();
  updateGroupsSummary_();
}

function validHour(hhmm) { return /^\d{2}:\d{2}$/.test(hhmm); }

async function wyslijNoweWydarzenie() {
  const data = document.getElementById("eventData").value;
  const start = document.getElementById("eventStart").value;
  const end = document.getElementById("eventEnd").value;
  const rodzaj = document.getElementById("eventRodzaj").value;

  const trener1 = document.getElementById("eventTrener1").value;
  const trener2 = document.getElementById("eventTrener2")?.value || "";
  const trener3 = document.getElementById("eventTrener3")?.value || "";
  const trener4 = document.getElementById("eventTrener4")?.value || "";

  const grupy = Array.from(selectedGroups).join(",");
  const liczDoStat = document.getElementById("eventStat").checked;
  const msg = document.getElementById("eventMsg");

  if (!data || !start || !rodzaj) { msg.innerText = "Uzupe≈Çnij: Data, Godzina, Rodzaj."; return; }
  if (!validHour(start) || !validHour(end)) { msg.innerText = "‚ùå Godzina w formacie HH:MM."; return; }
  if (start >= end) { msg.innerText = "‚ùå Koniec musi byƒá p√≥≈∫niej ni≈º start."; return; }

  msg.innerText = "‚è≥ Dodawanie wydarzenia...";
  try {
    const r = await apiClubPost({
      action: "dodajWydarzenie",
      data,
      godzStart: start,
      godzKoniec: end,
      rodzaj,
      trener1,
      trener2,
      trener3,
      trener4,
      grupy,
      liczDoStatystyk: String(liczDoStat)
    });

    msg.innerText = r.message || "Nieznany wynik.";

    if (r.success) {
      document.querySelectorAll("#trainerDodajWydarzenieView input").forEach(i => {
        if (i.type !== "checkbox") i.value = "";
        else i.checked = false;
      });

      resetTrenerSelects_();
      resetGroups_();

      setTimeout(() => trainerPokazWydarzenia(), 800);
    }

  } catch (err) {
    msg.innerText = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + err;
  }
}

 // ===== EDYCJA WYDARZENIA =====

function trainerShowDeletePopup(miesiac, czasCol) {
  deleteMiesiac = miesiac;
  deleteCzasCol = czasCol;
  document.getElementById("trainerDeletePopup").classList.add("show");
}
function trainerHideDeletePopup() {
  document.getElementById("trainerDeletePopup").classList.remove("show");
}
async function trainerConfirmDeleteYes() {
  trainerHideDeletePopup();

  const treningId = `${deleteMiesiac}-${deleteCzasCol}`;
  const card = document.querySelector(`[data-event-id='${treningId}']`);
  if (card) card.innerHTML = `<div class="card" style="background:#222;text-align:center;">‚è≥ Usuwam wydarzenie‚Ä¶</div>`;

  try {
    const data = await apiClubGet("usunWydarzenie", { treningId });
    if (data.success) {
      if (card) card.innerHTML = `<div class="card" style="background:#152;text-align:center;">üóëÔ∏è Usuniƒôto</div>`;
      setTimeout(() => trainerPokazWydarzenia(), 800);
    } else {
      if (card) card.innerHTML = `<div class="card" style="background:#522;text-align:center;">‚ùå ${data.error || "B≈ÇƒÖd"}</div>`;
    }
  } catch (err) {
    if (card) card.innerHTML = `<div class="card" style="background:#522;text-align:center;">‚ùå ${err}</div>`;
  }
}
  
/* =================== 90B TRENER: EDYCJA WYDARZENIA (POPUP) =================== */

// stan edycji
let editMiesiac = null;
let editCol5 = null;

// otwarcie popupu + wype≈Çnienie p√≥l + dociƒÖgniƒôcie trener√≥w i grup (bez psucia startu apki)
async function trainerShowEditPopup(miesiac, col5) {
  editMiesiac = String(miesiac || "");
  editCol5 = Number(col5);

  const pop = document.getElementById("trainerEditPopup");
  const msg = document.getElementById("editEventMsg");
  if (msg) msg.textContent = "‚è≥ ≈Åadujƒô trener√≥w i grupy...";

  // 1) podstawowe pola z cache listy (od razu)
  const key = `${editMiesiac}-${editCol5}`;
  const cached = window.__trainerEventsByKey ? window.__trainerEventsByKey[key] : null;

  const d = document.getElementById("editEventData");
  const s = document.getElementById("editEventStart");
  const e = document.getElementById("editEventEnd");
  const r = document.getElementById("editEventRodzaj");

  if (d) d.value = cached?.dataISO || "";
  if (s) s.value = cached?.start || "";
  if (e) e.value = cached?.end || "";
  if (r) r.value = cached?.rodzaj || "";

  // 2) reset UI (≈ºeby nie pamiƒôta≈Ço)
  resetEditTrenerSelects_();
  resetEditGroups_();

  // 3) poka≈º popup od razu, ale z komunikatem "≈Çadujƒô"
  if (pop) pop.style.display = "flex";

  // 4) za≈Çaduj opcje trener√≥w do select√≥w
  await zaladujListeTrenerowDoEdycji();

  // 5) pobierz szczeg√≥≈Çy wydarzenia (trenerzy + grupy)
  try {
    const treningId = `${editMiesiac}-${editCol5}`;
    const details = await apiClubGet("wydarzenieDetails", { treningId });

    if (details?.success) {
      const trenerArr = normalizeTrenerzy_(details?.trenerzy);
      const grupyArr  = normalizeGrupy_(details?.grupy);

      setEditTrenerzy_(trenerArr);
      setEditGroups_(grupyArr);

      if (msg) msg.textContent = ""; // gotowe
    } else {
      if (msg) msg.textContent = "‚ö†Ô∏è Nie uda≈Ço siƒô wczytaƒá trener√≥w i grup.";
      console.warn("wydarzenieDetails:", details);
    }
  } catch (err) {
    if (msg) msg.textContent = "‚ö†Ô∏è B≈ÇƒÖd pobierania trener√≥w i grup.";
    console.warn(err);
  }
}

function trainerHideEditPopup() {
  const pop = document.getElementById("trainerEditPopup");
  if (pop) pop.style.display = "none";
  editMiesiac = null;
  editCol5 = null;

  const msg = document.getElementById("editEventMsg");
  if (msg) msg.textContent = "";
}

function validHour_(hhmm) { return /^\d{2}:\d{2}$/.test(String(hhmm || "")); }

function normalizeTrenerzy_(input) {
  if (!input) return [];
  if (Array.isArray(input)) return input.map(x => String(x||"").trim()).filter(Boolean);
  // string: "A, B" albo "A;B"
  return String(input)
    .split(/[,;]+/)
    .map(s => s.trim())
    .filter(Boolean);
}

function normalizeGrupy_(input) {
  if (!input) return [];
  if (Array.isArray(input)) return input.map(x => String(x||"").trim()).filter(Boolean);
  return String(input)
    .split(/[,;]+/)
    .map(s => s.trim())
    .filter(Boolean);
}

function setEditTrenerzy_(arr) {
  const t = (arr || []).slice(0, 4);

  const s1 = document.getElementById("editTrener1");
  const s2 = document.getElementById("editTrener2");
  const s3 = document.getElementById("editTrener3");
  const s4 = document.getElementById("editTrener4");

  if (s1) s1.value = t[0] || "";
  if (s2) s2.value = t[1] || "";
  if (s3) s3.value = t[2] || "";
  if (s4) s4.value = t[3] || "";

  // ‚úÖ poka≈º wrapy zale≈ºnie od tego, czy poprzedni trener istnieje
  const w2 = document.getElementById("editTrener2Wrap");
  const w3 = document.getElementById("editTrener3Wrap");
  const w4 = document.getElementById("editTrener4Wrap");

  if (w2) (t[0] ? w2.classList.remove("hidden") : w2.classList.add("hidden"));
  if (w3) (t[1] ? w3.classList.remove("hidden") : w3.classList.add("hidden"));
  if (w4) (t[2] ? w4.classList.remove("hidden") : w4.classList.add("hidden"));

  // ‚úÖ wymu≈õ ‚Äúrefresh‚Äù dla select√≥w (czasem Safari/Chrome na mobile lubi nie przerysowaƒá)
  [s1, s2, s3, s4].forEach(sel => {
    if (!sel) return;
    sel.dispatchEvent(new Event("change", { bubbles: true }));
  });
}
function setEditGroups_(arr) {
  selectedEditGroups = new Set((arr || []).map(x => String(x||"").trim()).filter(Boolean));

  // ‚úÖ od razu poka≈º summary na ekranie (bez klikania w "Wybierz grupy")
  updateEditGroupsSummary_();

  // ‚úÖ i od razu przygotuj listƒô (≈ºeby po otwarciu popupu checkboxy by≈Çy ju≈º gotowe)
  renderEditGroupsList_();
}

// zapis do backendu
async function trainerSaveEditEvent() {
  const msg = document.getElementById("editEventMsg");
  if (msg) msg.textContent = "";

  const btn = document.getElementById("btnEditSave");
  if (btn) { btn.classList.add("loading"); btn.disabled = true; }

  try {
    if (!editMiesiac || !editCol5) {
      if (msg) msg.textContent = "‚ùå Brak identyfikatora wydarzenia.";
      return;
    }

    const dataISO = (document.getElementById("editEventData")?.value || "").trim();
    const start = (document.getElementById("editEventStart")?.value || "").trim();
    const end   = (document.getElementById("editEventEnd")?.value || "").trim();
    const rodzaj = (document.getElementById("editEventRodzaj")?.value || "").trim();

    if (!dataISO || !start || !end) {
      if (msg) msg.textContent = "‚ùå Uzupe≈Çnij datƒô i godziny.";
      return;
    }
    if (start >= end) {
      if (msg) msg.textContent = "‚ùå Godzina ko≈Ñca musi byƒá p√≥≈∫niej ni≈º start.";
      return;
    }

    const treningId = `${editMiesiac}-${editCol5}`;

    // trenerzy z select√≥w
    const trenerzyArr = [
      document.getElementById("editTrener1")?.value,
      document.getElementById("editTrener2")?.value,
      document.getElementById("editTrener3")?.value,
      document.getElementById("editTrener4")?.value
    ].map(v => String(v || "").trim()).filter(Boolean);

    // grupy z popupu
    const grupyArr = Array.from(selectedEditGroups || []);
    grupyArr.sort((a,b) => Number(a.slice(1)) - Number(b.slice(1)));
    const grupyCsv = grupyArr.join(",");

    const r = await apiClubPost({
      action: "edytujWydarzenie",
      treningId,
      data: dataISO,
      godzStart: start,
      godzKoniec: end,
      rodzaj,
      trenerzy: trenerzyArr.join(", "),
      grupy: grupyCsv
    });

if (r && (r.success || r.ok)) {
  if (msg) msg.textContent = "‚úÖ Zapisano. Od≈õwie≈ºam listƒô‚Ä¶";

  try {
    await trainerPokazWydarzenia();     // od≈õwie≈º listƒô
    setTimeout(trainerHideEditPopup, 300); // zamknij popup po kr√≥tkiej chwili
  } catch (refreshErr) {
    console.error("Refresh after save failed:", refreshErr);
    if (msg) msg.textContent = "‚úÖ Zapisano, ale nie uda≈Ço siƒô od≈õwie≈ºyƒá listy.";
    // popup zostaje otwarty ‚Äî i dobrze
  }

  return;
} else {
  if (msg) msg.textContent = "‚ùå Nie uda≈Ço siƒô zapisaƒá zmian: " + (r?.error || r?.message || "");
}

  } catch (err) {
    console.error(err);
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd zapisu (sprawd≈∫ konsolƒô).";
  } finally {
    if (btn) { btn.classList.remove("loading"); btn.disabled = false; }
  }
}

/* =================== 99 START APLIKACJI =================== */
window.addEventListener('load', () => {
  odtworzIntroSound();

  const splash = document.getElementById('splash');
  const app = document.getElementById('app');

  if (app) app.classList.remove('hidden');

  const wersja = document.getElementById("wersjaNum");
  if (wersja) wersja.textContent = WERSJA_APKI;

  // START: najpierw ustaw clubId z URL (albo wyczy≈õƒá na linku g≈Ç√≥wnym)
  initClubFromUrl_();

  // dopiero teraz ustawiamy stan historii (bo clubId mo≈ºe siƒô zmieniƒá)
  try {
    history.replaceState(
      { view: (clubId && isCfgLocked_()) ? "loginView" : "orgHubLandingView" },
      "",
      ""
    );
  } catch (e) {}

  // router + theme
  startApp_();
const btn = document.getElementById("btnEditSave");
if (btn) {
  btn.onclick = () => {
    const m = document.getElementById("editEventMsg");
    if (m) m.textContent = "‚úÖ Klik dzia≈Ça (handler podpiƒôty)";
    trainerSaveEditEvent();
  };
}


  // splash ma byƒá zawsze widoczny minimalnie chwilƒô (≈ºeby nie "mruga≈Ç")
  if (splash) {
    setTimeout(() => { splash.style.display = 'none'; }, 2000);
  }
});

</script>
</body>
</html>
