<!DOCTYPE html>
<html lang="pl">
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000">
  <link rel="manifest" href="manifest.json">
  
    <!-- flatpickr (kalendarz) -->
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/flatpickr.min.css">
    <script src="https://npmcdn.com/flatpickr/dist/flatpickr.min.js"></script>
    
    <!-- clocklet (okrƒÖg≈Çy zegar) -->
    <link rel="stylesheet" href="https://unpkg.com/clocklet@0.3.1/css/clocklet.min.css">
    <script src="https://unpkg.com/clocklet@0.3.1"></script>
                                                 
  <style>
    :root {
  --color-accent-red: #8b0000;   /* g≈Ç√≥wny czerwony aplikacji */
  --color-accent-red-border: #ff2b2b;

  --color-accent-green: #0f7a2a; /* g≈Ç√≥wny zielony aplikacji */
  --color-accent-green-border: #19a642;

  --color-card-bg: #111;
  --color-card-border: #555;
}
  
    body {
      font-family: Collage, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #fff;
      text-align: center;
    }

    .hidden { display: none !important; }
    .container { margin-top: 40px; }

    .login-box input, .login-box select {
      display: block;
      margin: 10px auto;
      padding: 8px;
      width: 200px;
      border-radius: 6px;
      border: none;
    }

button {
  padding: 8px 16px;
  border: none;
  background: var(--color-accent-red);
  color: white;
  border-radius: 6px;
  cursor: pointer;
}
    
    button[disabled] { background: gray !important; cursor: default; }
    #btnSetupPayments:disabled,
    #btnSetupSubmit:disabled {
    background: #555 !important;
    opacity: 0.65 !important;
    cursor: not-allowed !important;
    }

    .full-btn {
      display: block;
      width: 200px;
      margin: 10px auto;
      padding: 8px;
      border-radius: 6px;
      background: red;
      border: none;
      color: white;
      cursor: pointer;
    }
    .full-btn.alt { background: #333; }

    .card {
      border: 1px solid #555;
      border-radius: 10px;
      padding: 10px;
      margin: 10px;
      background: #111;
    }

    .lista-zapisanych {
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      padding: 8px;
      margin-top: 6px;
      text-align: left;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    #wersjaApki {
      position: fixed;
      top: 8px;
      right: 12px;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      user-select: none;
      z-index: 1000;
    }

    button.loading {
      background: #222 !important;
      opacity: 0.6;
      pointer-events: none;
      transition: background 0.2s ease, opacity 0.2s ease;
    }

/* Splash (statyczny) */
#splash {
  position: fixed;
  inset: 0;
  background: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 4000;
}

    .select-like-input {
      width: 200px;
      height: 36px;
      margin: 10px auto;
      border-radius: 6px;
      border: none;
      padding: 6px;
      font-size: 14px;
      display: block;
    }

    .grupa-check {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 14px;
      color: white;
    }
    .grupa-check input {
      margin-bottom: 4px;
      transform: scale(1.3);
    }

    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      background: #444;
      color: #fff;
      cursor: pointer;
      margin: 2px;
    }
    .btn.danger { background: #800; }

    #trainerDeletePopup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none;
    }
    #trainerDeletePopup.show { display: flex; }
    #trainerDeletePopup .popup-card {
      background: #111;
      border: 1px solid #555;
      border-radius: 10px;
      padding: 16px 20px;
      max-width: 260px;
      text-align: center;
    }

    /* BUSY OVERLAY */
    #busyOverlay.hidden { display: none !important; }
    #busyOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5000;
      padding: 24px;
    }

    button, input, select { font-size: 14px; }

    /* Usu≈Ñ strza≈Çki +/‚àí w input[type=number] (Chrome, Edge, Safari) */
input[type="number"]::-webkit-outer-spin-button,
input[type="number"]::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox */
input[type="number"] {
  -moz-appearance: textfield;
  appearance: textfield;
}

  /* ===== GLOBALNY STATUS: OP≈ÅACONE ===== */
.status-red {
  background: var(--color-accent-red) !important;
  border: 1px solid var(--color-accent-red-border) !important;
  color: #fff !important;
}

.status-green {
  background: var(--color-accent-green) !important;
  border: 1px solid var(--color-accent-green-border) !important;
  color: #fff !important;
}

    .modal.hidden { display:none; }

.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.65);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:9999;
}

.modal-card{
  width:min(520px, 100%);
  background:#111;
  border:1px solid rgba(255,255,255,0.10);
  border-radius:16px;
  padding:16px;
  box-shadow:0 18px 60px rgba(0,0,0,0.55);
}

.modal-actions{
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Zielony przycisk TAK */
.full-btn.green{
  background:#0a7a2f;
  border:1px solid rgba(255,255,255,0.10);
}
.full-btn.green:active{ transform:scale(0.99); }

    /* === ADMIN GRUPY: naprawa G10 + wiƒôksze checkboxy === */
#adminGrupyView label span{
  white-space: nowrap;   /* G10 nie ≈Çamie siƒô na dwie linie */
}

#adminGrupyView input.adminGrupaChk{
  width: 28px;           /* wiƒôkszy rozmiar pod palec */
  height: 28px;
}
    #adminGrupyView label { min-width: 0; }

    
  </style>
  
<script>
  
  // Ustaw globalnie dla Twojego du≈ºego skryptu:
  window.APP_BUILD = 'BETA APP';

    const poprzednia = localStorage.getItem('wersjaApki');
  if (poprzednia !== window.APP_BUILD) {
    localStorage.setItem('wersjaApki', window.APP_BUILD);

    // ‚úÖ twarde od≈õwie≈ºenie PWA cache przy zmianie wersji
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations()
        .then(regs => Promise.all(regs.map(r => r.unregister())))
        .finally(() => location.reload());
    } else {
      location.reload();
    }
  } else {
    // normalna rejestracja SW
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(r => console.log("‚úÖ SW zarejestrowany:", r))
        .catch(e => console.error("‚ùå B≈ÇƒÖd SW:", e));
    }
  }
</script>

</head>

<body>

  <div id="wersjaApki"><span id="wersjaNum"></span></div>

  <!-- BUSY OVERLAY (jeden, zgodny z JS: busyText) -->
  <div id="busyOverlay" class="hidden">
    <div style="font-size:20px; margin-bottom:12px;">‚è≥ Przygotowujƒô aplikacjƒô‚Ä¶</div>
    <div id="busyText" style="opacity:.85; max-width:320px; line-height:1.4;">
      Tworzƒô pliki klubu, ustawiam sezon i konfiguracjƒô.
    </div>
  </div>

  <!-- Splash -->
<div id="splash">
  <div style="text-align:center;">
    <div style="
      font-size:48px;
      font-weight:700;
      letter-spacing:2px;
      color:#000;
      margin-bottom:12px;
    ">
      ORG HUB
    </div>
    <div style="
      font-size:22px;
      letter-spacing:4px;
      color:#000;
      opacity:0.8;
    ">
      SYSTEMS
    </div>
  </div>
</div>

  <!-- G≈Ç√≥wna aplikacja -->
  <div id="app" class="hidden">

    <!-- LANDING ORGHUB -->
    <div id="orgHubLandingView" class="container hidden">
<h1 style="margin-bottom:6px;color:#000;">Witamy w aplikacji</h1>
<div style="font-size:28px;font-weight:800;letter-spacing:2px;margin-bottom:18px;color:#000;">
  ORGHUB SYSTEMS
</div>

      <button class="full-btn" onclick="goToConfig()">Skonfiguruj klub</button>
    </div>

    <!-- KONFIGURACJA KLUBU -->
    <div id="clubConfigView" class="container hidden">
      <h1>Konfiguracja klubu</h1>

      <div class="card" style="max-width:320px;margin:12px auto;">
        <!-- LOGO -->
        <button class="full-btn" onclick="pickLogo()">Wgraj swoje logo</button>
        <div style="margin-top:8px;">
          <img id="cfgLogoPreview" src="" alt="" style="display:none;width:160px;border-radius:10px;border:1px solid #444;">
          <div style="font-size:12px;opacity:0.75;margin-top:6px;">
            PNG/JPG, najlepiej kwadrat, np. 512√ó512
          </div>
          <input id="cfgLogoInput" type="file" accept="image/*" class="hidden" />
        </div>

        <!-- NAZWA (zgodnie z JS: editClubName) -->
        <button class="full-btn alt" id="btnClubName" onclick="clubNameEditStart()">
        <span id="clubNameText">Podaj nazwƒô klubu</span>
        <input id="clubNameInput" type="text" class="hidden"
         placeholder="Wpisz nazwƒô klubu"
         style="width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:none;">
      </button>

        <div id="cfgClubNameLabel" style="margin-top:6px;opacity:0.9;"></div>

        <!-- KOLOR T≈ÅA -->
        <button class="full-btn alt" onclick="toggleColorPicker(true)">Wybierz kolor t≈Ça</button>
        <div id="cfgColorLabel" style="margin-top:6px;opacity:0.9;"></div>

        <div id="cfgColorGrid" class="hidden"
             style="margin-top:10px;display:grid;grid-template-columns:repeat(4, 1fr);gap:8px;">
        </div>

        <!-- EMAIL -->
        <button class="full-btn alt" id="btnEmail" onclick="emailEditStart()">
        <span id="emailText">Tw√≥j email</span>
        <input id="emailInput" type="email" class="hidden"
         placeholder="Wpisz email"
         style="width:100%;box-sizing:border-box;padding:8px;border-radius:6px;border:none;">
        </button>

        <div id="cfgEmailLabel" style="margin-top:6px;opacity:0.9;"></div>

        <button class="full-btn" style="margin-top:14px;" onclick="submitClubConfig()">Wy≈õlij</button>
        <button class="full-btn alt" onclick="goBackFromConfig()">‚¨Ö Powr√≥t</button>

        <p id="cfgMsg" style="margin-top:10px;"></p>
      </div>
    </div>

      <!-- PANEL 2 - UZUPE≈ÅNIENIE DANYCH KLUBU -->
<div id="clubSetupView" class="container hidden">
  <h1>Uzupe≈Çnij dane klubu</h1>
  <div class="card" style="max-width:320px; margin:12px auto; padding:16px;">

    <!-- POCZƒÑTEK SEZONU -->
    <button class="full-btn alt" id="btnSetupSeasonStart" onclick="setupSeasonStartPick()">
      <span id="setupSeasonStartText">PoczƒÖtek sezonu</span>
      <input id="setupSeasonStartInput" type="date" class="hidden"
             style="width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:none;">
    </button>
    <div id="setupSeasonStartLabel" style="margin-top:6px; opacity:0.9; min-height:1.2em;"></div>

    <!-- KONIEC SEZONU -->
    <button class="full-btn alt" id="btnSetupSeasonEnd" onclick="setupSeasonEndPick()">
      <span id="setupSeasonEndText">Koniec sezonu</span>
      <input id="setupSeasonEndInput" type="date" class="hidden"
             style="width:100%; box-sizing:border-box; padding:8px; border-radius:6px; border:none;">
    </button>
    <div id="setupSeasonEndLabel" style="margin-top:6px; opacity:0.9; min-height:1.2em;"></div>

    <!-- PRZYCISKI -->
    <button class="full-btn alt" id="btnSetupPayments" disabled
        style="margin-top:20px; width:100%;"
        onclick="openPaymentsPopup()">
  P≈Çatno≈õci (ustaw daty sezonu)
    </button>

<!-- HAS≈ÅO ADMINA -->
<button class="full-btn alt" id="btnSetupAdminPass" disabled
        style="margin-top:12px; width:100%;"
        onclick="openAdminPassPopup()">
  Utw√≥rz has≈Ço administratora
</button>

<!-- POPUP: HAS≈ÅO ADMINA -->
<div id="adminPassPopup" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; justify-content:center; align-items:center;
  z-index:4000; padding:18px;
">
  <div class="card" style="max-width:360px;width:100%; text-align:left;">
    <div style="font-weight:800; font-size:16px; margin-bottom:10px;">
      Has≈Ço administratora
    </div>

    <div style="display:flex; flex-direction:column; gap:8px;">
      <div style="font-weight:700;">Ustaw has≈Ço (min. 6 znak√≥w)</div>
      <input id="adminPassInput" type="password" placeholder="Wpisz has≈Ço"
             style="width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;">
      <div style="font-size:12px; opacity:0.75;">
        Login admina jest sta≈Çy: <b>admin</b>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:14px;">
      <button class="full-btn alt" style="flex:1;" type="button" onclick="closeAdminPassPopup()">Anuluj</button>
      <button class="full-btn" style="flex:1;" type="button" onclick="saveAdminPass()">Zapisz</button>
    </div>

    <p id="adminPassMsg" style="margin-top:12px; min-height:1.2em;"></p>
  </div>
</div>
    
    <button class="full-btn" id="btnSetupSubmit" disabled
        style="margin-top:12px; width:100%;"
        onclick="submitSetupAndActivateClub()">Wy≈õlij i aktywuj klub</button>

    <button class="full-btn alt" onclick="goBackFromSetup()" 
            style="margin-top:12px; width:100%;">‚¨Ö Powr√≥t</button>

    <p id="setupMsg" style="margin-top:16px; min-height:3em;"></p>
    <div id="setupErrorBox" class="hidden" style="margin-top:10px; padding:8px; border:1px solid #933; border-radius:6px; background:#2b1111; color:#ffb3b3; font-size:0.9rem; text-align:left;"></div>
  </div>
  
  <!-- POPUP P≈ÅATNO≈öCI -->
<div id="paymentsPopup" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; justify-content:center; align-items:center;
  z-index:4000; padding:18px;
">
  <div class="card" style="max-width:360px;width:100%; text-align:left;">
    <div style="font-weight:800; font-size:16px; margin-bottom:10px;">Ustal p≈Çatno≈õci</div>

    <div id="paymentsList" style="display:flex; flex-direction:column; gap:10px;"></div>

    <div style="height:1px;background:#333;margin:14px 0;"></div>

    <div style="display:flex; flex-direction:column; gap:6px;">
      <div style="font-weight:700;">Cena za pojedynczy trening</div>
      <input id="singleTrainingPriceInput" type="number" inputmode="decimal" min="0" step="0.01"
             placeholder="np. 30"
             style="width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;">
    </div>

        <div style="height:1px;background:#333;margin:14px 0;"></div>

    <!-- LIMIT TRENING√ìW W RAMACH SK≈ÅADKI -->
    <div style="display:flex; flex-direction:column; gap:8px;">
      <div style="font-weight:700;">Limit trening√≥w w ramach sk≈Çadki</div>

      <label style="display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;">
        <input id="noLimitCheckbox" type="checkbox" style="transform:scale(1.15);">
        <span>Brak limitu</span>
      </label>

      <input id="membershipLimitInput" type="number" inputmode="numeric" min="0" step="1"
             placeholder="np. 8"
             style="width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;">
      <div style="font-size:12px; opacity:0.75;">
        Je≈õli zaznaczysz ‚ÄûBrak limitu‚Äù, pole liczby zostanie zablokowane.
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:14px;">
      <button class="full-btn alt" style="flex:1;" type="button" onclick="closePaymentsPopup()">Anuluj</button>
      <button class="full-btn" style="flex:1;" type="button" onclick="applyPaymentsPopup()">Zapisz</button>
    </div>

    <p id="paymentsMsg" style="margin-top:12px; min-height:1.2em;"></p>
  </div>
</div>

  </div> <!-- /clubSetupView -->

    <!-- LOGOWANIE -->
    <div id="loginView" class="container hidden">
<img src="icon-512.png" class="logo" style="width:200px;margin-bottom:15px;" alt="Logo">

<div style="width:220px; margin:0 auto 40px auto; text-align:center;">
  <div id="clubIdBadge" style="font-size:32px; font-weight:900; letter-spacing:3px; line-height:1.1;"></div>
</div>

<h1 style="margin:0 0 40px 0;">Logowanie</h1>


      <div class="login-box">
        <input id="numer" type="text" placeholder="Numer / Inicja≈Çy">
        <input id="haslo" type="password" placeholder="Has≈Ço">
        <button class="full-btn" onclick="zaloguj()">Zaloguj</button>
        <button class="full-btn alt" onclick="pokazRejestracjaSelect()">Rejestracja</button>
      </div>
      <p id="komunikat"></p>
    </div>

    <!-- WYB√ìR TYP REJESTRACJI -->
    <div id="registerSelectView" class="container hidden">
      <h1>Rejestracja</h1>
      <button class="full-btn" onclick="pokazRejestracjaZawodnik()">Zawodnik</button>
      <button class="full-btn" onclick="pokazRejestracjaTrener()">Trener</button>
      <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- REJESTRACJA ZAWODNIKA -->
    <div id="registerZawodnikView" class="container hidden">
      <h1>Rejestracja zawodnika</h1>
      <div class="login-box">
        <input id="regNumer" type="number" placeholder="Numer zawodnika">
        <input id="regNazwisko" type="text" placeholder="Imiƒô i nazwisko">
        <input id="regHaslo" type="password" placeholder="Ustaw has≈Ço">
        <button class="full-btn" onclick="wyslijRejestracje()">Zarejestruj</button>
      </div>
      <p id="regMsg"></p>
      <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- REJESTRACJA TRENERA -->
    <div id="rejestracjaTrenerView" class="container hidden">
      <h1>Rejestracja trenera</h1>
      <div class="login-box">
        <input id="regNazwiskoTrener" type="text" placeholder="Imiƒô i nazwisko">
        <input id="regHasloTrener" type="password" placeholder="Ustaw has≈Ço">
        <button class="full-btn" onclick="wyslijRejestracjeTrener()">Zarejestruj</button>
        <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
      </div>
      <p id="regMsgTrener"></p>
    </div>

<!-- DODAJ WYDARZENIE (TRENER) -->
<div id="trainerDodajWydarzenieView" class="container hidden">
  <h1>Dodaj wydarzenie</h1>

  <div class="login-box">
    <input id="eventData" type="text" placeholder="RRRR-MM-DD" autocomplete="off">
    <input id="eventStart" type="text" data-clocklet="format:HH:mm" placeholder="HH:MM" autocomplete="off">
    <input id="eventEnd"   type="text" data-clocklet="format:HH:mm" placeholder="HH:MM" autocomplete="off">
    <input id="eventRodzaj" type="text" placeholder="Rodzaj wydarzenia">

    <!-- TRENERZY (kaskadowo, max 4) -->
    <select id="eventTrener1" class="select-like-input" onchange="onTrenerPick(1)">
      <option value="">‚Äî wybierz trenera ‚Äî</option>
    </select>

    <div id="trener2Wrap" class="hidden">
      <select id="eventTrener2" class="select-like-input" onchange="onTrenerPick(2)">
        <option value="">‚Äî kolejny trener ‚Äî</option>
      </select>
    </div>

    <div id="trener3Wrap" class="hidden">
      <select id="eventTrener3" class="select-like-input" onchange="onTrenerPick(3)">
        <option value="">‚Äî kolejny trener ‚Äî</option>
      </select>
    </div>

    <div id="trener4Wrap" class="hidden">
      <select id="eventTrener4" class="select-like-input">
        <option value="">‚Äî kolejny trener ‚Äî</option>
      </select>
    </div>
  </div><!-- ‚úÖ domkniƒôcie login-box -->

<!-- GRUPY: przycisk + popup -->
<button class="full-btn alt" id="btnPickGroups" onclick="openGroupsPopup()">Wybierz grupy</button>
<div id="groupsSummary" style="margin-top:6px;opacity:0.85;font-size:13px;">‚Äî</div>

<div id="groupsPopup" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; justify-content:center; align-items:center;
  z-index:3000; padding:18px;
">
  <div class="card" style="max-width:320px;width:100%; text-align:left;">
    <div style="font-weight:800; font-size:16px; margin-bottom:10px;">Wybierz grupy</div>

    <div id="groupsList" style="display:flex; flex-direction:column; gap:8px;"></div>

    <div style="display:flex; gap:8px; margin-top:14px;">
      <button class="full-btn alt" style="flex:1;" onclick="closeGroupsPopup()">Anuluj</button>
      <button class="full-btn" style="flex:1;" onclick="applyGroupsPopup()">Zapisz</button>
    </div>
  </div>
</div>

<div style="margin-top:10px; display:flex; justify-content:center;">
  <label style="display:flex; align-items:center; gap:10px;">
    <input id="eventStat" type="checkbox" style="transform:scale(1.35);">
    <span>Liczyƒá do statystyk</span>
  </label>
</div>

<div style="margin-top:10px; display:flex; justify-content:center;">
  <label style="display:flex; align-items:center; gap:10px;">
    <input id="eventRez" type="checkbox" style="transform:scale(1.35);">
    <span>Rezerwacja obiektu</span>
  </label>
</div>

  <button class="full-btn" onclick="wyslijNoweWydarzenie()">üíæ Dodaj wydarzenie</button>
  <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>

  <p id="eventMsg" style="margin-top:10px;"></p>
</div>


    <!-- P≈ÅATNO≈öCI -->
    <div id="platnosciView" class="container hidden">
      <h1>P≈Çatno≈õci</h1>
      <div id="listaPlatnosci">≈Åadowanie...</div>
    </div>

    <!-- WYDARZENIA (ZAWODNIK) -->
    <div id="homeView" class="container hidden">
      <h1 id="tytulTreningow">TWOJE WYDARZENIA</h1>
      <div id="listaTreningow">≈Åadowanie...</div>
      <button onclick="pokazStatystyki()" style="margin-top:20px;">üìà Poka≈º statystyki</button>
    <button class="full-btn alt" onclick="powrotDoPlatnosci()" style="margin-top:10px;">   ‚¨Ö Powr√≥t do p≈Çatno≈õci
</button>

    </div>

    <!-- STATYSTYKI -->
    <div id="statsView" class="container hidden">
      <h1>Statystyki</h1>
      <div id="listaStatystyk">≈Åadowanie...</div>
      <button onclick="powrotDoTreningow()" style="margin-top:20px;">‚¨Ö Powr√≥t</button>
    </div>

    <!-- PANEL TRENERA -->
    <div id="trainerPanelView" class="container hidden">
      <h1>Panel trenera</h1>
      <button class="full-btn" onclick="trainerPokazZawodnicy()">üë• Zawodnicy</button>
      <button class="full-btn" onclick="trainerPokazWydarzenia()">üèí Wydarzenia</button>
      <button class="full-btn alt" onclick="pokazLogowanie()">‚¨Ö Wyloguj</button>
    </div>

    <!-- PANEL ADMINISTRATORA -->
<div id="adminPanelView" class="container hidden">
  <h1>Panel administratora</h1>

  <button class="full-btn" onclick="adminPokazZawodnikow()">üë• Zawodnicy</button>
  <button class="full-btn alt" onclick="pokazLogowanie()">‚¨Ö Wyloguj</button>
</div>

<!-- LISTA ZAWODNIK√ìW (ADMIN) -->
<div id="adminZawodnicyView" class="container hidden">
  <h1>Lista zawodnik√≥w</h1>
  <div id="adminListaZawodnikow">≈Åadowanie...</div>
  <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>
</div>

   <!-- KARTA ZAWODNIKA (ADMIN) -->
<div id="adminZawodnikView" class="container hidden">
  <h1 id="adminZawodnikTitle">Zawodnik</h1>

  <button class="full-btn" onclick="adminOpenGroups()">Grupy</button>
 <button class="full-btn" onclick="adminOpenStats();">Statystyki</button>
  <button class="full-btn" onclick="adminOpenPayments()">P≈Çatno≈õci</button>

  <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>

  <p id="adminZawodnikMsg" style="margin-top:10px;"></p>
</div>

<!-- ADMIN: GRUPY (EKRAN) -->
<div id="adminGrupyView" class="container hidden">
  <h1 id="adminGrupyTitle">Grupy</h1>

  <!-- KAFEL 1: G1‚ÄìG5 -->
  <div class="card" style="margin-bottom:12px;">
    <div style="
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:6mm;
      text-align:center;
    ">
      <label><input type="checkbox" class="adminGrupaChk" value="G1"> G1</label>
      <label><input type="checkbox" class="adminGrupaChk" value="G2"> G2</label>
      <label><input type="checkbox" class="adminGrupaChk" value="G3"> G3</label>
      <label><input type="checkbox" class="adminGrupaChk" value="G4"> G4</label>
      <label><input type="checkbox" class="adminGrupaChk" value="G5"> G5</label>
    </div>
  </div>

  <!-- KAFEL 2: G6‚ÄìG10 -->
  <div class="card" style="margin-bottom:12px;">
    <div style="
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:6mm;
      text-align:center;
    ">
      <label><input type="checkbox" class="adminGrupaChk" value="G6"> G6</label>
      <label><input type="checkbox" class="adminGrupaChk" value="G7"> G7</label>
      <label><input type="checkbox" class="adminGrupaChk" value="G8"> G8</label>
      <label><input type="checkbox" class="adminGrupaChk" value="G9"> G9</label>
      <label><input type="checkbox" class="adminGrupaChk" value="G10"> G10</label>
    </div>
  </div>

  <button class="full-btn" onclick="adminSaveGrupyLocal()">Zapisz</button>
  <button class="full-btn alt" onclick="appBack()">‚¨Ö Powr√≥t</button>

  <p id="adminGrupyMsg" style="margin-top:10px;"></p>
</div>

    <!-- ADMIN: STATYSTYKI (EKRAN) -->
    
    <div id="adminStatsView" class="container hidden">
  <h1 id="adminStatsTitle">Statystyki</h1>

  <div id="adminStatsBody">
    <div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>
  </div>

  <button class="full-btn alt" onclick="goToView('adminZawodnikView')">‚¨Ö Powr√≥t</button>

  <p id="adminStatsMsg" style="margin-top:10px;"></p>
</div>
    
    <!-- ADMIN: P≈ÅATNO≈öCI ZAWODNIKA -->

    <div id="adminPaymentsView" class="container hidden">
  <h1 id="adminPaymentsTitle">P≈Çatno≈õci</h1>

  <div id="adminPaymentsBody">
    <div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>
  </div>

  <button class="full-btn alt" onclick="goToView('adminZawodnikView')">‚¨Ö Powr√≥t</button>

  <p id="adminPaymentsMsg" style="margin-top:10px;"></p>
</div>

    <!-- =================== ADMIN: MODAL POTWIERDZENIA P≈ÅATNO≈öCI =================== -->
<div id="adminPayConfirmModal" class="modal hidden">
  <div class="modal-card">
    <h2 style="margin:0 0 8px 0;">Potwierdzenie</h2>
    <div id="adminPayConfirmText" style="opacity:0.9; line-height:1.35;">
      Potwierdzam zap≈Çatƒô
    </div>

    <div style="height:10px;"></div>

    <div class="modal-actions">
      <button class="full-btn green" id="adminPayConfirmYesBtn">TAK</button>
      <button class="full-btn alt" id="adminPayConfirmNoBtn">NIE</button>
    </div>

    <p id="adminPayConfirmMsg" style="margin-top:10px;"></p>
  </div>
</div>
    
    <!-- LISTA ZAWODNIK√ìW (TRENER) -->
    <div id="trainerZawodnicyView" class="container hidden">
      <h1>Lista zawodnik√≥w</h1>
      <div id="trainerListaZawodnikow">≈Åadowanie...</div>
      <button class="full-btn alt" onclick="trainerPowrot()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- WYDARZENIA (TRENER) -->
    <div id="trainerWydarzeniaView" class="container hidden">
      <h1>Wydarzenia</h1>
      <div id="trainerListaWydarzen">≈Åadowanie...</div>
      <button class="full-btn" style="margin-top:20px;" onclick="pokazDodajWydarzenie()">‚ûï Dodaj wydarzenie</button>
      <button class="full-btn alt" onclick="trainerPowrot()">‚¨Ö Powr√≥t</button>
    </div>

    <!-- Popup potwierdzenia usuniƒôcia -->
    <div id="trainerDeletePopup">
      <div class="popup-card">
        <p style="margin-bottom:15px;">Czy napewno chcesz usunƒÖƒá wydarzenie ?</p>
        <button class="full-btn" onclick="trainerConfirmDeleteYes()">TAK</button>
        <button class="full-btn alt" style="margin-top:8px;" onclick="trainerHideDeletePopup()">Anuluj</button>
      </div>
    </div>

    <!-- Popup edycji wydarzenia -->
<div id="trainerEditPopup" style="
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  justify-content: center;
  align-items: center;
  z-index: 2100;
  display: none;
">
  <div class="popup-card" style="max-width:320px;">
    <p style="margin:0 0 10px 0;"><b>Edytuj wydarzenie</b></p>
    <div class="login-box" style="margin-top:10px;">
      <input id="editEventData" type="date">
      <input id="editEventStart" type="time">
      <input id="editEventEnd" type="time">
      <input id="editEventRodzaj" type="text" placeholder="Rodzaj wydarzenia">

      <!-- TRENERZY (kaskadowo, max 4) -->
      <select id="editTrener1" class="select-like-input" onchange="onEditTrenerPick(1)">
        <option value="">‚Äî wybierz trenera ‚Äî</option>
      </select>

      <div id="editTrener2Wrap" class="hidden">
        <select id="editTrener2" class="select-like-input" onchange="onEditTrenerPick(2)">
          <option value="">‚Äî kolejny trener ‚Äî</option>
        </select>
      </div>

      <div id="editTrener3Wrap" class="hidden">
        <select id="editTrener3" class="select-like-input" onchange="onEditTrenerPick(3)">
          <option value="">‚Äî kolejny trener ‚Äî</option>
        </select>
      </div>

      <div id="editTrener4Wrap" class="hidden">
        <select id="editTrener4" class="select-like-input">
          <option value="">‚Äî kolejny trener ‚Äî</option>
        </select>
      </div>

      <!-- GRUPY -->
      <button class="full-btn alt" id="btnEditPickGroups" type="button" onclick="openEditGroupsPopup()">
        Wybierz grupy
      </button>
      <div id="editGroupsSummary" style="margin-top:6px;opacity:0.85;font-size:13px;">‚Äî</div>
    </div>

    <!-- POPUP GRUP (edycja) -->
    <div id="editGroupsPopup" class="hidden" style="
      position:fixed; inset:0; background:rgba(0,0,0,0.7);
      display:flex; justify-content:center; align-items:center;
      z-index:3001; padding:18px;
    ">
      <div class="card" style="max-width:320px;width:100%; text-align:left;">
        <div style="font-weight:800; font-size:16px; margin-bottom:10px;">Wybierz grupy (edycja)</div>

        <div id="editGroupsList" style="display:flex; flex-direction:column; gap:8px;"></div>

        <div style="display:flex; gap:8px; margin-top:14px;">
          <button class="full-btn alt" style="flex:1;" type="button" onclick="closeEditGroupsPopup()">Anuluj</button>
          <button class="full-btn" style="flex:1;" type="button" onclick="applyEditGroupsPopup()">Zapisz</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; justify-content:center;">
  <label style="display:flex; align-items:center; gap:10px; cursor:pointer; user-select:none;">
    <input id="editEventRez" type="checkbox" style="transform:scale(1.5);">
    <span>Rezerwacja obiektu</span>
  </label>
</div>
    
    <div style="margin-top:10px;">
     <button class="full-btn" id="btnEditSave">üíæ Zapisz zmiany</button>
      <button class="full-btn alt" onclick="trainerHideEditPopup()">Anuluj</button>
    </div>

    <p id="editEventMsg" style="margin-top:10px;"></p>
  </div>
</div>

<!-- =================== ADMIN: POPUP GRUP (2 rzƒôdy po 5) =================== -->
<div id="adminGroupsPopup" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; justify-content:center; align-items:center;
  z-index:4700; padding:18px;
">
  <div class="card" style="max-width:360px;width:100%; text-align:left;">
    <div style="font-weight:900; font-size:16px; margin-bottom:10px;">
      Grupy <span id="adminGroupsNrLabel" style="opacity:.85;"></span>
    </div>

    <div id="adminGroupsGrid" style="
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:10px;
    "></div>

    <div style="display:flex; gap:8px; margin-top:14px;">
      <button class="full-btn alt" style="flex:1;" type="button" onclick="adminCloseGroupsPopup()">Anuluj</button>
      <button class="full-btn" style="flex:1;" type="button" onclick="adminApplyGroupsPopup()">Zapisz</button>
    </div>

    <div id="adminGroupsMsg" style="margin-top:10px; opacity:.9;"></div>
  </div>
</div>

<!-- =================== ADMIN: POPUP STATYSTYKI =================== -->
<div id="adminStatsPopup" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; justify-content:center; align-items:center;
  z-index:4700; padding:18px;
">
  <div class="card" style="max-width:360px;width:100%; text-align:left;">
    <div style="font-weight:900; font-size:16px; margin-bottom:10px;">
      Statystyki <span id="adminStatsNrLabel" style="opacity:.85;"></span>
    </div>

    <div id="adminStatsBody">‚è≥ ≈Åadowanie‚Ä¶</div>

    <div style="display:flex; gap:8px; margin-top:14px;">
      <button class="full-btn" style="flex:1;" type="button" onclick="adminCloseStatsPopup()">Zamknij</button>
    </div>
  </div>
</div>

<!-- =================== ADMIN: POPUP P≈ÅATNO≈öCI =================== -->
<div id="adminConfirmPayPopup" class="modal hidden">
  <div class="modal-card">
    <h2 style="margin:0 0 8px 0;">Potwierdzenie</h2>

    <div id="adminConfirmPayMsg" style="opacity:0.9; line-height:1.35;">
      Potwierdzam zap≈Çatƒô
    </div>

    <div style="height:12px;"></div>

    <div style="display:flex; gap:10px; margin-top:8px;">
      <button
        id="adminConfirmPayYes"
        class="full-btn green"
        type="button"
        style="flex:1; width:100%; margin:0;"
        onclick="adminDoConfirmPayment()"
      >TAK</button>

      <button
        class="full-btn alt"
        type="button"
        style="flex:1; width:100%; margin:0;"
        onclick="adminCancelConfirmPayment()"
      >NIE</button>
    </div>
  </div>
</div>
    
<div id="adminPaymentsPopup" class="hidden" style="
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; justify-content:center; align-items:center;
  z-index:4700; padding:18px;
">
  <div class="card" style="max-width:380px;width:100%; text-align:left;">
    <div style="font-weight:900; font-size:16px; margin-bottom:10px;">
      P≈Çatno≈õci <span id="adminPayNrLabel" style="opacity:.85;"></span>
    </div>

    <div id="adminPaymentsBody">‚è≥ ≈Åadowanie‚Ä¶</div>

    <div style="display:flex; gap:8px; margin-top:14px;">
      <button class="full-btn" style="flex:1;" type="button" onclick="adminClosePaymentsPopup()">Zamknij</button>
    </div>
  </div>
</div>
  </div><!-- /app -->

<script>
/* =================== 00 START / INTRO =================== */
function odtworzIntroSound() {
  try {
    const audio = new Audio("sound.mp3");
    audio.volume = 0.7;
    audio.play().catch(() => {});
  } catch (err) {}
}

/* =================== 10 KONFIG / GLOBALNE =================== */
const APP_BUILD = window.APP_BUILD;
const CORE_URL = "https://still-shape-2aa3.orghubsystems.workers.dev";

// ===== DEBUG: poka≈º b≈ÇƒÖd JS na ekranie (≈ºeby nie sta≈Ço "w ciszy") =====
window.addEventListener("error", (ev) => {
  try {
    const splash = document.getElementById("splash");
    const app = document.getElementById("app");
    if (splash) splash.style.display = "none";
    if (app) app.classList.remove("hidden");

    const box = document.createElement("div");
    box.style.position = "fixed";
    box.style.inset = "0";
    box.style.background = "#fff";
    box.style.color = "#000";
    box.style.padding = "16px";
    box.style.zIndex = "999999";
    box.style.overflow = "auto";
    box.style.fontFamily = "monospace";
    box.innerHTML =
      `<h2 style="margin:0 0 10px 0;">‚ùå B≈ÇƒÖd JS (apka nie wystartowa≈Ça)</h2>
       <div><b>${(ev && ev.message) ? ev.message : "unknown error"}</b></div>
       <div style="margin-top:8px;">Plik: ${ev?.filename || "-"}</div>
       <div>Linia: ${ev?.lineno || "-"}, Kolumna: ${ev?.colno || "-"}</div>
       <pre style="white-space:pre-wrap;margin-top:12px;">${(ev && ev.error && ev.error.stack) ? ev.error.stack : ""}</pre>`;
    document.body.appendChild(box);
  } catch (e) {}
});

window.addEventListener("unhandledrejection", (ev) => {
  try { alert("Unhandled Promise Rejection: " + (ev?.reason?.message || ev?.reason || ev)); } catch (e) {}
});

// stan aplikacji
let clubId = localStorage.getItem("orghub_clubId") || "";
let numerZalogowanego = null;
let grupaZalogowanego = null;
window.grupyTrenera = "";
let currentView = "loginView";

window.__adminPendingPayCol = null;
window.__adminPendingPayLabel = "";

/* =================== 20 PAMIƒòƒÜ LOKALNA (localStorage) =================== */
const LS_KEY_CFG = "orghub.clubConfig.v1";
const LS_KEY_CLUBID = "orghub_clubId";
const LS_KEY_THEME = "orghub_theme";
const LS_KEY_CFG_LOCK = "orghub_cfg_locked";

function isCfgLocked_() {
  return localStorage.getItem(LS_KEY_CFG_LOCK) === "1";
}

function lockCfg_() {
  localStorage.setItem(LS_KEY_CFG_LOCK, "1");
}

function unlockCfg_() {
  localStorage.removeItem(LS_KEY_CFG_LOCK);
}

function loadLocalClubConfig() {
  try { return JSON.parse(localStorage.getItem(LS_KEY_CFG) || "null"); }
  catch { return null; }
}
function saveLocalClubConfig(cfg) {
  localStorage.setItem(LS_KEY_CFG, JSON.stringify(cfg || {}));
}
function clearLocalClubConfig() {
  localStorage.removeItem(LS_KEY_CFG);
}
function saveClubId_(id) {
  clubId = String(id || "").trim();
  if (clubId) localStorage.setItem(LS_KEY_CLUBID, clubId);
  else localStorage.removeItem(LS_KEY_CLUBID);
}
function saveTheme_(theme) {
  localStorage.setItem(LS_KEY_THEME, JSON.stringify(theme || {}));
}
function loadTheme_() {
  try { return JSON.parse(localStorage.getItem(LS_KEY_THEME) || "null"); }
  catch { return null; }
}

function initClubFromUrl_() {
  try {
    const params = new URLSearchParams(window.location.search);
    const urlClubId = params.get("clubId");

    if (urlClubId) {
      saveClubId_(urlClubId);   // klub z linku
    } else {
      saveClubId_("");          // link og√≥lny = reset
    }
  } catch (e) {}
}

/* =================== 30 BUSY OVERLAY =================== */
function showBusy(text) {
  const ov = document.getElementById("busyOverlay");
  const bt = document.getElementById("busyText");
  if (bt && text) bt.textContent = text;
  if (ov) ov.classList.remove("hidden");
}
function hideBusy() {
  const ov = document.getElementById("busyOverlay");
  if (ov) ov.classList.add("hidden");
}

/* =================== 40 NAWIGACJA / ROUTER =================== */
function ukryjWszystkie() {
  document.querySelectorAll(".container").forEach(v => {
    if (v.id === "app") return; // ‚úÖ NIE chowamy wrappera
    v.classList.add("hidden");
  });
}

function goToView(viewId, options = {}) {
  const { replace = false } = options;
  ukryjWszystkie();
  const el = document.getElementById(viewId);
  if (el) el.classList.remove("hidden");
  currentView = viewId;
  const state = { view: viewId };
  try {
    if (replace) history.replaceState(state, "", "");
    else history.pushState(state, "", "");
  } catch (e) {}
}

function showViewFromHistory(viewId) {
  ukryjWszystkie();
  const el = document.getElementById(viewId);
  if (el) el.classList.remove("hidden");
  currentView = viewId;
}

function appBack() { history.back(); }

window.addEventListener("popstate", (event) => {
  const state = event.state;
  if (state && state.view) showViewFromHistory(state.view);
  else showViewFromHistory((clubId && isCfgLocked_()) ? "loginView" : "orgHubLandingView");
});

function refreshClubBadge_() {
  const el = document.getElementById("clubIdBadge");
  if (el) el.textContent = (clubId || "").toUpperCase();
}

function applyTheme_(theme) {
  try {
    if (theme?.bgColor) document.body.style.backgroundColor = theme.bgColor;

    const logoImg = document.querySelector("#loginView img.logo") || document.querySelector("#loginView img");
    if (logoImg && theme?.logoUrl) logoImg.src = theme.logoUrl;

  } catch (e) {}
}

async function startApp_() {

  const params = new URLSearchParams(window.location.search);
  const clubFromUrl = params.get("clubId");

  // üîß KLUCZOWE ‚Äì ustaw globalne clubId zanim apka co≈õ zrobi
if (clubFromUrl) {
  clubId = String(clubFromUrl);
}

  // --- KOLOR ---
  if (!clubFromUrl) {

    // Fabryka = zawsze bia≈Ço
    document.body.style.backgroundColor = "#ffffff";

  } else {

    try {
      const branding = await apiClubGet("branding", {});

      if (branding?.bg_color) {
        document.body.style.backgroundColor = branding.bg_color;
      }

      if (branding?.logo_data) {
        const logoImg =
          document.querySelector("#loginView img.logo") ||
          document.querySelector("#loginView img");

        if (logoImg) logoImg.src = branding.logo_data;
      }

    } catch (e) {
      console.warn("Branding load failed", e);
    }

  }

  // --- ROUTER ---
  refreshClubBadge_();
  goToView(clubFromUrl ? "loginView" : "orgHubLandingView", { replace: true });
}

/* =================== 50 API (CORE / CLUB) =================== */
function requireClubId() {
  if (!clubId) throw new Error("Brak clubId. Najpierw skonfiguruj klub.");
}

// POST do CORE bez clubId (np. createClub)
async function apiCorePost(payload = {}) {
  // DIAG_START: Panel 2 / CORE POST diagnostics
  const safePayload = { ...payload };
  ["haslo", "password", "token", "auth", "authorization"].forEach((k) => {
    if (safePayload[k] != null) safePayload[k] = "[REDACTED]";
  });
  console.log("[DIAG][apiCorePost][request]", {
    clubId: safePayload.clubId || clubId || "",
    action: safePayload.action || "",
    mode: safePayload.mode || "",
    payload: safePayload
  });
  // DIAG_END

  const body = new URLSearchParams({ ...payload });
  const res = await fetch(CORE_URL, { method: "POST", body });

  // DIAG_START: Panel 2 / CORE response diagnostics
  const contentType = res.headers.get("content-type") || "";
  console.log("[DIAG][apiCorePost][response-meta]", {
    status: res.status,
    contentType
  });
  if (!/json/i.test(contentType)) {
    const raw = await res.clone().text();
    console.log("[DIAG][apiCorePost][non-json-preview]", raw.slice(0, 200));
  }
  // DIAG_END

  return res.json();
}

window.activateClub_ = async function(payload = {}) {
  return apiCorePost({ action: "activateClub", ...payload });
};

// GET/POST do CLUB (wymaga clubId)
async function apiClubGet(action, params = {}) {
  requireClubId();
  const url = new URL(CORE_URL);
  url.searchParams.set("action", action);
  url.searchParams.set("clubId", clubId);
  Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v ?? ""));
  const res = await fetch(url.toString(), { cache: "no-store" });
  return res.json();
}

function extractGasError_(html) {
  try {
    // Najczƒô≈õciej w≈Ça≈õciwy komunikat siedzi w <div class="errorMessage">...</div>
    const m = String(html || "").match(/<div class="errorMessage"[^>]*>([\s\S]*?)<\/div>/i);
    if (!m) return "";
    // usu≈Ñ tagi i zbij spacje
    return m[1]
      .replace(/<br\s*\/?>/gi, "\n")
      .replace(/<[^>]+>/g, "")
      .replace(/\s+\n/g, "\n")
      .replace(/\n\s+/g, "\n")
      .trim();
  } catch (e) {
    return "";
  }
}

async function apiClubPost(payload = {}) {
  requireClubId();
  const body = new URLSearchParams({ clubId, ...payload });
  const res = await fetch(CORE_URL, { method: "POST", body });

  const text = await res.text();

  // 1) normalny JSON
  try {
    return JSON.parse(text);
  } catch (e) {}

  // 2) HTML z GAS ‚Äî wyciƒÖgamy sensowny komunikat
  const msg = extractGasError_(text);
  return {
    ok: false,
    error: msg ? ("GAS ERROR: " + msg) : ("Backend zwr√≥ci≈Ç nie-JSON (" + res.status + ")."),
    raw: text.slice(0, 600)
  };
}



/* =================== 60 ORGHUB START / KONFIGURACJA =================== */

/**
 * Panel 1: logo + nazwa + kolor + email (bez sezonu)
 * Panel 2: sezon + p≈Çatno≈õci
 */

let cfgDraft = {
  clubName: "",
  email: "",
  bgColor: "#000000",
  logoDataUrl: "" // dataURL
};

// Panel 2 (uzupe≈Çnienie po utworzeniu klubu)
let setupDraft = {
  sezonStart: "", // YYYY-MM-DD
  sezonEnd: "",   // YYYY-MM-DD
  months: [],     // ["Maj 2026", ...] ‚Äî wyliczymy po ustawieniu sezonu
  fees: {},       // { "Maj 2026": 200, ... }  (na razie placeholder)
  singleTrainingPrice: "" // na razie placeholder
};

// paleta
const COLOR_PRESETS = [
  "#000000", "#1a1a1a",
  "#0b1b2b", "#123a5a",
  "#0b2b5a", "#1a4fa3",
  "#0b2b2b", "#118a8a",
  "#0b2b1b", "#1f7a3a",
  "#2b2b0b", "#7a7a1f",
  "#2b1b0b", "#a35a1a",
  "#2b0b1b", "#6a1b3a"
];

const COLOR_NAMES = {
  "#000000": "Czarny",
  "#1a1a1a": "Grafit",
  "#0b1b2b": "Granat",
  "#123a5a": "Granat jasny",
  "#0b2b5a": "Niebieski",
  "#1a4fa3": "Niebieski jasny",
  "#0b2b2b": "Turkus",
  "#118a8a": "Turkus jasny",
  "#0b2b1b": "Ziele≈Ñ",
  "#1f7a3a": "Ziele≈Ñ jasna",
  "#2b2b0b": "Oliwka",
  "#7a7a1f": "Oliwka jasna",
  "#2b1b0b": "BrƒÖz",
  "#a35a1a": "Pomara≈Ñcz",
  "#2b0b1b": "Bordo",
  "#6a1b3a": "Fiolet"
};

/* ---------- Panel 1: Nazwa ---------- */
function clubNameEditStart() {
  const btn = document.getElementById("btnClubName");
  const span = document.getElementById("clubNameText");
  const input = document.getElementById("clubNameInput");
  if (!btn || !span || !input) return;

  span.classList.add("hidden");
  input.classList.remove("hidden");
  input.value = cfgDraft.clubName || "";
  input.focus();
  input.select();

  if (input.dataset.bound === "1") return;
  input.dataset.bound = "1";

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); clubNameEditCommit(); }
    if (e.key === "Escape") { e.preventDefault(); clubNameEditCancel(); }
  });

  input.addEventListener("blur", () => clubNameEditCommit());
}

function clubNameEditCommit() {
  const span = document.getElementById("clubNameText");
  const input = document.getElementById("clubNameInput");
  if (!span || !input) return;

  const v = String(input.value || "").trim();
  cfgDraft.clubName = v;

  input.classList.add("hidden");
  span.classList.remove("hidden");
  span.textContent = v ? v : "Podaj nazwƒô klubu";
}

function clubNameEditCancel() {
  const span = document.getElementById("clubNameText");
  const input = document.getElementById("clubNameInput");
  if (!span || !input) return;

  input.classList.add("hidden");
  span.classList.remove("hidden");
  span.textContent = cfgDraft.clubName ? cfgDraft.clubName : "Podaj nazwƒô klubu";
}

/* ---------- Panel 1: Email ---------- */
function emailEditStart() {
  const span = document.getElementById("emailText");
  const input = document.getElementById("emailInput");
  if (!span || !input) return;

  span.classList.add("hidden");
  input.classList.remove("hidden");
  input.value = cfgDraft.email || "";
  input.focus();
  input.select();

  if (input.dataset.bound === "1") return;
  input.dataset.bound = "1";

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); emailEditCommit(); }
    if (e.key === "Escape") { e.preventDefault(); emailEditCancel(); }
  });

  input.addEventListener("blur", () => emailEditCommit());
}

function emailEditCommit() {
  const span = document.getElementById("emailText");
  const input = document.getElementById("emailInput");
  if (!span || !input) return;

  const v = String(input.value || "").trim();
  cfgDraft.email = v;

  input.classList.add("hidden");
  span.classList.remove("hidden");
  span.textContent = v ? v : "Tw√≥j email";
}

function emailEditCancel() {
  const span = document.getElementById("emailText");
  const input = document.getElementById("emailInput");
  if (!span || !input) return;

  input.classList.add("hidden");
  span.classList.remove("hidden");
  span.textContent = cfgDraft.email ? cfgDraft.email : "Tw√≥j email";
}

/* ---------- Panel 1: Kolory ---------- */
function toggleColorPicker(show) {
  const grid = document.getElementById("cfgColorGrid");
  if (!grid) return;
  if (show) grid.classList.remove("hidden");
  else grid.classList.add("hidden");
}

function setBgColor(color) {
  cfgDraft.bgColor = color;
  document.body.style.backgroundColor = color;

  // Pod przyciskiem ma byƒá zawsze pusto
  const colEl = document.getElementById("cfgColorLabel");
  if (colEl) colEl.textContent = "";

  // Tekst NA KLAWISZU ma pokazywaƒá nazwƒô wybranego koloru
  const btn = document.querySelector("#clubConfigView button[onclick*='toggleColorPicker']");
  if (btn) {
    const name = (COLOR_NAMES && COLOR_NAMES[color]) ? COLOR_NAMES[color] : "Kolor t≈Ça";
    btn.textContent = name;
    btn.classList.add("alt");
  }

  toggleColorPicker(false);
}

/* ---------- Panel 1: Logo ---------- */
function pickLogo() {
  const input = document.getElementById("cfgLogoInput");
  if (!input) return;

  input.onchange = async () => {
    const file = input.files && input.files[0];
    if (!file) return;

    const msg = document.getElementById("cfgMsg");

    if (file.size > 2 * 1024 * 1024) {
      if (msg) msg.textContent = "‚ùå Logo za du≈ºe (max ~2MB).";
      return;
    }

    cfgDraft.logoDataUrl = await fileToDataUrl_(file);
    renderConfigUI_();
    if (msg) msg.textContent = "";
  };

  input.click();
}

function fileToDataUrl_(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(String(r.result || ""));
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

/* ---------- Render Panel 1 ---------- */
function renderConfigUI_() {
  const nameEl = document.getElementById("cfgClubNameLabel");
  const emEl = document.getElementById("cfgEmailLabel");
  const colEl = document.getElementById("cfgColorLabel");
  const prev = document.getElementById("cfgLogoPreview");
  const grid = document.getElementById("cfgColorGrid");

  // POD PRZYCISKAMI ZAWSZE PUSTO
  if (nameEl) nameEl.textContent = "";
  if (emEl) emEl.textContent = "";
  if (colEl) colEl.textContent = "";

  // LOGO
  if (prev) {
    if (cfgDraft.logoDataUrl) {
      prev.src = cfgDraft.logoDataUrl;
      prev.style.display = "inline-block";
    } else {
      prev.style.display = "none";
    }
  }

  // SIATKA KOLOR√ìW
  if (grid) {
    grid.innerHTML = COLOR_PRESETS.map(c => `
      <div onclick="setBgColor('${c}')" style="
        width:100%;
        aspect-ratio:1/1;
        border-radius:10px;
        border:1px solid #444;
        background:${c};
        cursor:pointer;">
      </div>
    `).join("");
  }

  // Nazwa na przycisku
  const cn = document.getElementById("clubNameText");
  if (cn) cn.textContent = cfgDraft.clubName ? cfgDraft.clubName : "Podaj nazwƒô klubu";

  // Email na przycisku
  const em = document.getElementById("emailText");
  if (em) em.textContent = cfgDraft.email ? cfgDraft.email : "Tw√≥j email";

  // Kolor na przycisku
  const btn = document.querySelector("#clubConfigView button[onclick*='toggleColorPicker']");
  if (btn) {
    const name = (COLOR_NAMES && COLOR_NAMES[cfgDraft.bgColor]) ? COLOR_NAMES[cfgDraft.bgColor] : "Wybierz kolor t≈Ça";
    btn.textContent = name;
    btn.classList.add("alt");
  }
}

/* ---------- Wej≈õcie/Wyj≈õcie ---------- */
function goToConfig() {
  // je≈õli klub ju≈º skonfigurowany i config zablokowany ‚Äì nie pokazuj panelu
  if (clubId && isCfgLocked_()) {
    goToView("loginView");
    return;
  }

  const saved = loadLocalClubConfig();
  if (saved) {
    cfgDraft = { ...cfgDraft, ...saved };
  }

  renderConfigUI_();
  goToView("clubConfigView");
}

function goBackFromConfig() {
  goToView(clubId ? "loginView" : "orgHubLandingView");
}

/* =================== 61 WYS≈ÅANIE KONFIGURACJI -> CREATECLUB =================== */

function validateCfg_() {
  if (!cfgDraft.logoDataUrl) return "Wgraj logo.";
  if (!cfgDraft.clubName) return "Podaj nazwƒô klubu.";
  if (!cfgDraft.bgColor) return "Wybierz kolor t≈Ça.";
  if (!cfgDraft.email) return "Podaj email admina.";
  return "";
}

async function submitClubConfig() {
  const msg = document.getElementById("cfgMsg");
  if (msg) msg.textContent = "";

  const err = validateCfg_();
  if (err) {
    if (msg) msg.textContent = "‚ùå " + err;
    return;
  }

  // zapis roboczy lokalnie
  saveLocalClubConfig({ ...cfgDraft });

  showBusy("Konfigurujƒô klub‚Ä¶");

  try {
    const r = await apiCorePost({
      action: "createClub",
      clubName: cfgDraft.clubName,
      // sezonStart/end przeniesione do Panelu 2 -> na tym etapie nie wysy≈Çamy
      sezonStart: "",
      sezonEnd: "",
      bgColor: cfgDraft.bgColor,
      ownerEmail: cfgDraft.email,
      logoBase64: cfgDraft.logoDataUrl
    });

    if (!r || (r.success !== true && r.ok !== true)) {
      hideBusy();
      if (msg) msg.textContent = "‚ùå " + (r?.error || r?.message || JSON.stringify(r));
      return;
    }

    if (!r.clubId) {
      hideBusy();
      if (msg) msg.textContent = "‚ùå CORE nie zwr√≥ci≈Ç clubId.";
      return;
    }

    // ustaw clubId
    saveClubId_(r.clubId);

    // zablokuj panel konfiguracyjny na tym urzƒÖdzeniu
    lockCfg_();

    // theme
    const theme = {
      bgColor: r.bgColor || cfgDraft.bgColor,
      logoUrl: r.logoUrl || cfgDraft.logoDataUrl,
      clubName: r.clubName || cfgDraft.clubName
    };
    saveTheme_(theme);
    applyTheme_(theme);

    // utrwal config (z clubId)
    saveLocalClubConfig({ ...cfgDraft, clubId: r.clubId });

    hideBusy();

    refreshClubBadge_();
    goToConfig2(); // -> Panel 2

  } catch (e) {
    hideBusy();
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

function goToConfig2() {
  setupDraft = {
    sezonStart: "",
    sezonEnd: "",
    months: [],
    fees: {},
    singleTrainingPrice: ""
  };
  renderSetupUI_();
  goToView("clubSetupView");
  updateSetupPaymentsState_();
}
  
  function renderSetupUI_() {
  // Minimalny renderer: tylko od≈õwie≈ºa etykiety na przyciskach panelu 2
  const s = document.getElementById("setupSeasonStartText");
  const e = document.getElementById("setupSeasonEndText");

  if (s) s.textContent = setupDraft?.sezonStart ? setupDraft.sezonStart : "PoczƒÖtek sezonu";
  if (e) e.textContent = setupDraft?.sezonEnd ? setupDraft.sezonEnd : "Koniec sezonu";

  // od razu pilnujemy stanu przycisk√≥w
  if (typeof updateSetupPaymentsState_ === "function") {
    updateSetupPaymentsState_();
  }
}

function goBackFromSetup() {
  goToView("clubConfigView");
}

// =================== PANEL 2: P≈ÅATNO≈öCI (POPUP) ===================

// helper: PL miesiƒÖce
const MONTHS_PL = ["Stycze≈Ñ","Luty","Marzec","Kwiecie≈Ñ","Maj","Czerwiec","Lipiec","Sierpie≈Ñ","Wrzesie≈Ñ","Pa≈∫dziernik","Listopad","Grudzie≈Ñ"];

// start/end: "YYYY-MM-DD" -> lista miesiƒôcy inclusive
function buildSeasonMonths_(startISO, endISO) {
  const s = new Date(startISO);
  const e = new Date(endISO);
  if (isNaN(s) || isNaN(e)) return [];

  // ustaw na 1 dzie≈Ñ miesiƒÖca
  const cur = new Date(s.getFullYear(), s.getMonth(), 1);
  const end = new Date(e.getFullYear(), e.getMonth(), 1);

  const out = [];
  while (cur <= end) {
    const y = cur.getFullYear();
    const m = cur.getMonth(); // 0..11
    const key = `${y}-${String(m+1).padStart(2,"0")}`;  // np. 2026-08
    const label = `${MONTHS_PL[m]} ${y}`;              // np. Sierpie≈Ñ 2026
    out.push({ key, label, year: y, monthIndex: m });
    cur.setMonth(cur.getMonth() + 1);
  }
  return out;
}

function openPaymentsPopup() {
  const msg = document.getElementById("setupMsg");
  if (msg) msg.textContent = "";

  const s = String(setupDraft?.sezonStart || "").trim();
  const e = String(setupDraft?.sezonEnd || "").trim();
  if (!s || !e || s > e) {
    if (msg) msg.textContent = "Ustaw poprawnie daty sezonu, ≈ºeby wej≈õƒá w p≈Çatno≈õci.";
    return;
  }

  // wygeneruj miesiƒÖce tylko raz / albo przy ka≈ºdej zmianie dat
  setupDraft.months = buildSeasonMonths_(s, e);

  renderPaymentsPopup_();

  const pop = document.getElementById("paymentsPopup");
  if (pop) pop.classList.remove("hidden");
  
  wireMembershipLimitUI_();

}

function wireMembershipLimitUI_() {
  const cb = document.getElementById("noLimitCheckbox");
  const inp = document.getElementById("membershipLimitInput");
  if (!cb || !inp) return;

  function refresh() {
    if (cb.checked) {
      inp.value = "";
      inp.disabled = true;
      inp.style.opacity = "0.55";
    } else {
      inp.disabled = false;
      inp.style.opacity = "1";
    }
  }

  cb.onchange = refresh;
  refresh();
}
  
function closePaymentsPopup() {
  const pop = document.getElementById("paymentsPopup");
  if (pop) pop.classList.add("hidden");

  const m = document.getElementById("paymentsMsg");
  if (m) m.textContent = "";
}

function renderPaymentsPopup_() {
  const list = document.getElementById("paymentsList");
  const pmsg = document.getElementById("paymentsMsg");
  if (pmsg) pmsg.textContent = "";

  const months = setupDraft.months || [];
  if (!list) return;

  list.innerHTML = months.map(m => {
    const val = (setupDraft.fees && setupDraft.fees[m.key] != null) ? setupDraft.fees[m.key] : "";
    return `
      <div style="display:flex; flex-direction:column; gap:6px;">
        <div style="font-weight:700;">${m.label}</div>
        <input data-monthkey="${m.key}" type="number" inputmode="decimal" min="0" step="0.01"
               placeholder="Kwota sk≈Çadki (np. 200)"
               value="${String(val).replace(/"/g,'&quot;')}"
               style="width:100%;box-sizing:border-box;padding:10px;border-radius:10px;border:1px solid #333;background:#111;color:#fff;">
      </div>
    `;
  }).join("");

  // wstaw cenƒô treningu
  const single = document.getElementById("singleTrainingPriceInput");
  if (single) single.value = setupDraft.singleTrainingPrice || "";
}

function applyPaymentsPopup() {
  const pmsg = document.getElementById("paymentsMsg");
  if (pmsg) pmsg.textContent = "";

  const inputs = Array.from(document.querySelectorAll(`#paymentsList input[data-monthkey]`));
  const fees = {};
  for (const inp of inputs) {
    const k = inp.getAttribute("data-monthkey");
    const raw = String(inp.value || "").trim();

    // dopuszczamy puste (je≈õli chcesz wymusiƒá wszystkie, zmienimy)
    if (raw === "") continue;

    const v = Number(raw.replace(",", "."));
    if (!isFinite(v) || v < 0) {
      if (pmsg) pmsg.textContent = "‚ùå Nieprawid≈Çowa kwota w jednym z miesiƒôcy.";
      inp.focus();
      return;
    }
    fees[k] = v;
  }

  const singleInp = document.getElementById("singleTrainingPriceInput");
  const singleRaw = String(singleInp?.value || "").trim();
  if (singleRaw !== "") {
    const v = Number(singleRaw.replace(",", "."));
    if (!isFinite(v) || v < 0) {
      if (pmsg) pmsg.textContent = "‚ùå Nieprawid≈Çowa cena pojedynczego treningu.";
      if (singleInp) singleInp.focus();
      return;
    }
    setupDraft.singleTrainingPrice = v;
  } else {
    setupDraft.singleTrainingPrice = "";
  }

  setupDraft.fees = fees;

  // ‚úÖ UI: oznacz ≈ºe p≈Çatno≈õci uzupe≈Çnione i odblokuj submit
  const btnPay = document.getElementById("btnSetupPayments");
  if (btnPay) btnPay.textContent = "P≈Çatno≈õci ‚úÖ";

  const btnSubmit = document.getElementById("btnSetupSubmit");
  if (btnSubmit) btnSubmit.disabled = false;

    const noLimit = !!document.getElementById("noLimitCheckbox")?.checked;
  const limitInp = document.getElementById("membershipLimitInput");
  const limitRaw = String(limitInp?.value || "").trim();

  if (noLimit) {
    setupDraft.membershipLimit = "NO_LIMIT";
  } else if (limitRaw === "") {
    setupDraft.membershipLimit = ""; // brak ustawienia (albo wymusimy p√≥≈∫niej)
  } else {
    const lim = Number(limitRaw.replace(",", "."));
    if (!Number.isFinite(lim) || lim < 0) {
      if (pmsg) pmsg.textContent = "‚ùå Nieprawid≈Çowy limit trening√≥w w ramach sk≈Çadki.";
      if (limitInp) limitInp.focus();
      return;
    }
    setupDraft.membershipLimit = lim;
  }

  closePaymentsPopup();
  const smsg = document.getElementById("setupMsg");
  if (smsg) smsg.textContent = "‚úÖ P≈Çatno≈õci zapisane. Mo≈ºesz kliknƒÖƒá ‚ÄûWy≈õlij i aktywuj klub‚Äù.";
}
  
/* =================== 62 PANEL 2: SEZON -> AKTYWACJA P≈ÅATNO≈öCI =================== */
function setupSeasonStartPick() {
  const span = document.getElementById("setupSeasonStartText");
  const input = document.getElementById("setupSeasonStartInput");
  if (!span || !input) return;

  span.classList.add("hidden");
  input.classList.remove("hidden");
  input.value = setupDraft.sezonStart ? String(setupDraft.sezonStart).slice(0, 10) : "";

  try { input.showPicker && input.showPicker(); } catch(e) {}

  if (input.dataset.bound === "1") return;
  input.dataset.bound = "1";

  input.addEventListener("change", () => {
    const v = String(input.value || "").trim(); // YYYY-MM-DD
    setupDraft.sezonStart = v;

    input.classList.add("hidden");
    span.classList.remove("hidden");
    span.textContent = v ? v : "PoczƒÖtek sezonu";

    updateSetupPaymentsState_(); // ‚úÖ kluczowe
  });

  input.addEventListener("blur", () => {
    input.classList.add("hidden");
    span.classList.remove("hidden");
    span.textContent = setupDraft.sezonStart ? setupDraft.sezonStart : "PoczƒÖtek sezonu";
  });
}

function setupSeasonEndPick() {
  const span = document.getElementById("setupSeasonEndText");
  const input = document.getElementById("setupSeasonEndInput");
  if (!span || !input) return;

  span.classList.add("hidden");
  input.classList.remove("hidden");
  input.value = setupDraft.sezonEnd ? String(setupDraft.sezonEnd).slice(0, 10) : "";

  try { input.showPicker && input.showPicker(); } catch(e) {}

  if (input.dataset.bound === "1") return;
  input.dataset.bound = "1";

  input.addEventListener("change", () => {
    const v = String(input.value || "").trim();
    setupDraft.sezonEnd = v;

    input.classList.add("hidden");
    span.classList.remove("hidden");
    span.textContent = v ? v : "Koniec sezonu";

    updateSetupPaymentsState_(); // ‚úÖ kluczowe
  });

  input.addEventListener("blur", () => {
    input.classList.add("hidden");
    span.classList.remove("hidden");
    span.textContent = setupDraft.sezonEnd ? setupDraft.sezonEnd : "Koniec sezonu";
  });
}

function updateSetupPaymentsState_() {
  const btnPay = document.getElementById("btnSetupPayments");
  const btnSubmit = document.getElementById("btnSetupSubmit");
  const msg = document.getElementById("setupMsg");

  // ‚úÖ Panel 2 pracuje na setupDraft, nie na cfgDraft
  const s = String(setupDraft?.sezonStart || "").trim();
  const e = String(setupDraft?.sezonEnd || "").trim();

  const okBoth = !!s && !!e;
  const okOrder = okBoth && (s <= e);

  const enablePayments = okOrder;
  if (okOrder) {
  setupDraft.months = buildSeasonMonths_(s, e);
}

  if (btnPay) {
    btnPay.disabled = !enablePayments;
    btnPay.textContent = enablePayments ? "P≈Çatno≈õci" : "P≈Çatno≈õci (ustaw daty sezonu)";
  }

   const btnAdmin = document.getElementById("btnSetupAdminPass");
  if (btnAdmin) btnAdmin.disabled = !enablePayments; 

  if (btnSubmit) btnSubmit.disabled = true;

  if (msg) {
    if (!okBoth) msg.textContent = "Ustaw poczƒÖtek i koniec sezonu, ≈ºeby odblokowaƒá p≈Çatno≈õci.";
    else if (!okOrder) msg.textContent = "‚ùå Koniec sezonu nie mo≈ºe byƒá przed poczƒÖtkiem.";
    else msg.textContent = "";
  }
}

  /* helper: ujednolicenie klucza miesiƒÖca (string) */
function monthKey_(m) {
  if (!m) return "";
  if (typeof m === "string") return m.trim();

  // gdy miesiƒÖc jest obiektem
  return String(
    m.key ?? m.id ?? m.value ?? m.label ?? m.name ?? m.text ??
    (m.monthName && m.year ? `${m.monthName} ${m.year}` : "")
  ).trim();
}

 /* =================== 62A PANEL 2: HAS≈ÅO ADMINA (UI) =================== */

// stan roboczy has≈Ça admina (na tym etapie tylko frontend)
setupDraft.adminPass = setupDraft.adminPass || "";

function openAdminPassPopup() {
  const pop = document.getElementById("adminPassPopup");
  const inp = document.getElementById("adminPassInput");
  const msg = document.getElementById("adminPassMsg");

  if (msg) msg.textContent = "";
  if (inp) {
    inp.value = setupDraft.adminPass || "";
    inp.focus();
  }
  if (pop) pop.classList.remove("hidden");
}

function closeAdminPassPopup() {
  const pop = document.getElementById("adminPassPopup");
  const msg = document.getElementById("adminPassMsg");
  if (msg) msg.textContent = "";
  if (pop) pop.classList.add("hidden");
}

async function saveAdminPass() {
  const inp = document.getElementById("adminPassInput");
  const msg = document.getElementById("adminPassMsg");
  const btn = document.getElementById("btnSetupAdminPass");

  const pass = String(inp?.value || "").trim();

  if (pass.length < 6) {
    if (msg) msg.textContent = "‚ùå Has≈Ço musi mieƒá minimum 6 znak√≥w.";
    return;
  }

  if (msg) msg.textContent = "‚è≥ Zapisujƒô has≈Ço administratora...";

  try {
    const r = await apiClubPost({
      action: "adminSetPassword",
      adminPass: pass
    });

    if (!r || (r.success !== true && r.ok !== true)) {
      if (msg) msg.textContent = "‚ùå " + (r?.error || r?.message || "B≈ÇƒÖd zapisu has≈Ça.");
      return;
    }

    // zapis lokalny (≈ºeby UI wiedzia≈Ço, ≈ºe ju≈º jest ustawione)
    setupDraft.adminPass = pass;

    if (btn) btn.textContent = "Has≈Ço administratora ‚úÖ";
    if (msg) msg.textContent = "‚úÖ Has≈Ço zapisane w panelu administracyjnym.";

    setTimeout(() => closeAdminPassPopup(), 500);

  } catch (e) {
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}
  
 async function submitSetupAndActivateClub() {
  console.log('[DIAG] submitSetupAndActivateClub fired');
  const msg = document.getElementById("setupMsg");
  const btn = document.getElementById("btnSetupSubmit");
  const errorBox = document.getElementById("setupErrorBox");
  if (msg) msg.textContent = "";
  // DIAG_START: Panel 2 error box reset
  if (errorBox) {
    errorBox.classList.add("hidden");
    errorBox.textContent = "";
  }
  // DIAG_END

  try {
    if (!clubId) {
      if (msg) msg.textContent = "‚ùå Brak clubId. Wr√≥ƒá do Panelu 1 i utw√≥rz klub.";
      return;
    }

    // zak≈Çadam, ≈ºe trzymasz to w setupDraft (tak jak pisa≈Çe≈õ)
    const sezonStart = String(setupDraft?.sezonStart || "").trim();
    const sezonEnd   = String(setupDraft?.sezonEnd || "").trim();

    if (!sezonStart || !sezonEnd || sezonStart > sezonEnd) {
      if (msg) msg.textContent = "‚ùå Ustaw poprawnie poczƒÖtek i koniec sezonu.";
      return;
    }

    const months = Array.isArray(setupDraft?.months) ? setupDraft.months : [];
    const fees = setupDraft?.fees || {};
    const singleTrainingPrice = String(setupDraft?.singleTrainingPrice || "").trim();

    if (!months.length) {
      if (msg) msg.textContent = "‚ùå Brak miesiƒôcy sezonu (sprawd≈∫ daty sezonu).";
      return;
    }

    // minimalna walidacja: kwoty sk≈Çadek dla miesiƒôcy
    const feeValues = Array.isArray(fees)
      ? fees
      : (fees && typeof fees === "object" ? Object.values(fees) : []);
    const hasAnyFee = feeValues.some((v) => v !== undefined && v !== null && String(v).trim() !== "");
    if (!hasAnyFee) {
      if (msg) msg.textContent = "‚ùå Brak zdefiniowanej sk≈Çadki.";
      return;
    }

    for (const m of months) {
      const mKey = monthKey_(m);
      const v = fees[mKey];
      if (v === undefined || v === null || String(v).trim() === "") {
        if (msg) msg.textContent = mKey ? `‚ùå Brak sk≈Çadki dla: ${mKey}` : "‚ùå Brak zdefiniowanej sk≈Çadki.";
        return;
      }
    }

    if (!singleTrainingPrice) {
      if (msg) msg.textContent = "‚ùå Podaj cenƒô pojedynczego treningu.";
      return;
    }

    if (btn) { btn.disabled = true; btn.classList.add("loading"); }
    if (msg) msg.textContent = "‚è≥ Zapisujƒô p≈Çatno≈õci i aktywujƒô klub‚Ä¶";

    // CORE zapisuje to do Administracja->Kartoteka
    
const membershipLimit =
  setupDraft?.membershipLimit === "NO_LIMIT"
    ? "NO_LIMIT"
    : (setupDraft?.membershipLimit === "" || setupDraft?.membershipLimit == null)
      ? ""
      : String(setupDraft.membershipLimit).trim();

console.log("[DIAG] activateClub payload preview", {
  clubId,
  sezonStart,
  sezonEnd,
  monthsType: typeof months,
  monthsIsArray: Array.isArray(months),
  feesType: typeof fees,
  singleTrainingPrice,
  membershipLimit_raw: setupDraft?.membershipLimit,
  membershipLimit_type: typeof setupDraft?.membershipLimit,
  membershipLimit
});

const r = await activateClub_({
  clubId,
  sezonStart,
  sezonEnd,
  months: JSON.stringify(months),
  fees: JSON.stringify(fees),
  singleTrainingPrice,
  membershipLimit
});

    if (!r || (r.success !== true && r.ok !== true)) {
      const shortErr = (r?.error || r?.message || "B≈ÇƒÖd odpowiedzi backendu");
      if (msg) msg.textContent = "‚ùå " + (r?.error || r?.message || JSON.stringify(r));
      // DIAG_START: Panel 2 error box backend error
      if (errorBox) {
        errorBox.textContent = "B≈ÇƒÖd aktywacji klubu: " + shortErr;
        errorBox.classList.remove("hidden");
      }
      // DIAG_END
      if (btn) btn.disabled = false;
      return;
    }

// Link klubu po aktywacji (budujemy po clubId ‚Äî backend nie musi zwracaƒá linku)
const link = (r && (r.clubLink || r.link))
  ? (r.clubLink || r.link)
  : ("https://orghub-systems.github.io/app/?clubId=" + encodeURIComponent(String(clubId || "").trim()));

if (msg) msg.textContent = "‚úÖ Gotowe. Klub aktywowany. Link poni≈ºej.";

// dynamiczny box (nie wymaga zmian w HTML)
let box = document.getElementById("clubLinkBox");
if (!box) {
  box = document.createElement("div");
  box.id = "clubLinkBox";
  box.style.marginTop = "12px";

  box.innerHTML = `
    <div style="font-weight:700; margin-bottom:6px;">Link Twojego klubu:</div>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input id="clubLinkInput" type="text" readonly style="flex:1; min-width:260px;" />
      <button id="btnCopyClubLink" type="button">Skopiuj link Twojego klubu</button>
    </div>
    <div id="clubLinkCopyMsg" style="margin-top:6px; opacity:.9;"></div>
  `;

  // wpinamy pod setupMsg (albo na koniec panelu)
  const anchor = document.getElementById("setupMsg");
  if (anchor && anchor.parentNode) anchor.parentNode.appendChild(box);
  else document.body.appendChild(box); // awaryjnie
}

const input = document.getElementById("clubLinkInput");
const btnCopy = document.getElementById("btnCopyClubLink");
const copyMsg = document.getElementById("clubLinkCopyMsg");

if (input) input.value = link;
if (copyMsg) copyMsg.textContent = "";

if (btnCopy) {
  btnCopy.onclick = async () => {
    try {
      await navigator.clipboard.writeText(link);
      if (copyMsg) copyMsg.textContent = "‚úÖ Skopiowano link.";
    } catch (e) {
      if (input) {
        input.focus(); input.select();
        document.execCommand("copy");
        if (copyMsg) copyMsg.textContent = "‚úÖ Skopiowano link (tryb zgodno≈õci).";
      } else {
        if (copyMsg) copyMsg.textContent = "‚ùå Skopiuj rƒôcznie z pola.";
      }
    }
  };
}
    
    // opcjonalnie: przej≈õcie na ekran login / landing
    // goToView("loginView");

  } catch (e) {
    console.error(e);
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
    // DIAG_START: Panel 2 error box transport error
    if (errorBox) {
      errorBox.textContent = "B≈ÇƒÖd po≈ÇƒÖczenia z backendem: " + (e?.message || e);
      errorBox.classList.remove("hidden");
    }
    // DIAG_END
    if (btn) btn.disabled = false;
  } finally {
    if (btn) { btn.classList.remove("loading"); }
  }
}
window.submitSetupAndActivateClub = submitSetupAndActivateClub;

  /* =================== 65 ADMIN PANEL (frontend) =================== */

async function adminSaveGrupy(nr, selectedSetOrArray) {
  const numer = String(nr || "").trim();
  if (!numer) { alert("‚ùå Brak numeru zawodnika"); return; }

  // accepted: Set, Array, string
  let grupyCsv = "";
  if (typeof selectedSetOrArray === "string") {
    grupyCsv = selectedSetOrArray.trim();
  } else if (selectedSetOrArray && typeof selectedSetOrArray.forEach === "function") {
    const arr = [];
    selectedSetOrArray.forEach(v => arr.push(String(v || "").trim()));
    grupyCsv = arr.filter(Boolean).sort((a,b)=>Number(a.slice(1))-Number(b.slice(1))).join(",");
  } else if (Array.isArray(selectedSetOrArray)) {
    grupyCsv = selectedSetOrArray.map(v=>String(v||"").trim()).filter(Boolean)
      .sort((a,b)=>Number(a.slice(1))-Number(b.slice(1))).join(",");
  }

  try {
    const r = await apiClubPost({
      action: "adminSetGrupy",
      numer,
      grupy: grupyCsv
    });

    if (!r || !(r.success || r.ok)) {
      alert("‚ùå Zapis grup nie wyszed≈Ç: " + (r?.error || r?.message || JSON.stringify(r)));
      return;
    }

    alert("‚úÖ Zapisano grupy: " + (r.written || grupyCsv || "‚Äî"));
  } catch (e) {
    alert("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e));
  }
}

  /* =================== 66 ADMIN: POPUP ZAWODNIK + GRUPY/STATY/P≈ÅATNO≈öCI =================== */

// ---- Otwarcie okna zawodnika (wywo≈Çasz z listy zawodnik√≥w) ----
function adminOpenZawodnik(nr, nazwisko) {
  // kontekst zawodnika dla admina
  window.__adminSelectedNr = String(nr || "").trim();
  window.__adminSelectedNazwisko = String(nazwisko || "").trim();

  // prze≈ÇƒÖcz na widok (NOWE OKNO)
  goToView("adminZawodnikView");

  // ustaw tytu≈Ç w tym widoku (je≈õli masz te elementy)
  const title = document.getElementById("adminZawodnikTitle");
  if (title) title.textContent = `Zawodnik #${window.__adminSelectedNr} ‚Äî ${window.__adminSelectedNazwisko || "‚Äî"}`;

  // (opcjonalnie) wyczy≈õƒá komunikaty / boxy, je≈õli istniejƒÖ
  const msg = document.getElementById("adminZawodnikMsg");
  if (msg) msg.textContent = "";


  // =================== PREFETCH ADMIN (cache w RAM) ===================
  if (!window.__adminCache) window.__adminCache = {};
  const key = String(window.__adminSelectedNr || "").trim();
  if (!window.__adminCache[key]) window.__adminCache[key] = { ts: Date.now() };

  // Odpal w tle (nie blokuje UI)
  (async () => {
    try {
      const nr2 = String(window.__adminSelectedNr || "").trim();
      if (!nr2) return;

      // 1) Grupy
      if (window.__adminCache[nr2].grupy === undefined) {
        window.__adminCache[nr2].grupy = await apiClubGet("adminGrupy", { numer: nr2 });
      }

      // 2) Statystyki (zwyk≈Çy endpoint zawodnika)
      if (window.__adminCache[nr2].staty === undefined) {
        window.__adminCache[nr2].staty = await apiClubGet("statystyki", { numer: nr2 });
      }

      // 3) P≈Çatno≈õci admin
      if (window.__adminCache[nr2].platnosci === undefined) {
        window.__adminCache[nr2].platnosci = await apiClubGet("platnosciAdmin", { numer: nr2 });
      }

      // (opcjonalnie) debug:
      // console.log("‚úÖ Prefetch done:", nr2, window.__adminCache[nr2]);

    } catch (e) {
      console.warn("Prefetch admin failed:", e);
    }
  })();
  // =================== /PREFETCH ADMIN ===================
}

// =================== GRUPY ===================
let __adminGroupsSet = new Set();

function adminRenderGroupsGrid_() {
  const grid = document.getElementById("adminGroupsGrid");
  if (!grid) return;

  const groups = Array.from({ length: 10 }, (_, i) => `G${i + 1}`);
  grid.innerHTML = groups.map(g => {
    const checked = __adminGroupsSet.has(g) ? "checked" : "";
    return `
      <label style="
        display:flex; gap:8px; align-items:center; justify-content:center;
        padding:10px; border:1px solid #333; border-radius:12px; background:#111;
        cursor:pointer; user-select:none;
      ">
        <input type="checkbox" class="adminGrpPick" value="${g}" ${checked} style="transform:scale(1.25);">
        <span style="font-weight:800;">${g}</span>
      </label>
    `;
  }).join("");
}

async function adminOpenGroups() {
  const nr = String(window.__adminSelectedNr || "").trim();
  const nazw = String(window.__adminSelectedNazw || "").trim();

  goToView("adminGrupyView");

  const t = document.getElementById("adminGrupyTitle");
  if (t) t.textContent = `Grupy ‚Äî #${nr} ${nazw ? "‚Äî " + nazw : ""}`;

  // ‚úÖ U CIEBIE checkboxy sƒÖ ju≈º w HTML (#adminGrupyView .adminGrupaChk)
  // wiƒôc NIE budujemy ≈ºadnego gridu dynamicznie.

  const msg = document.getElementById("adminGrupyMsg");
  if (msg) msg.textContent = "‚è≥ ≈Åadujƒô grupy‚Ä¶";

  // wyczy≈õƒá zaznaczenia zanim wczytamy z backendu
  document.querySelectorAll("#adminGrupyView .adminGrupaChk").forEach(ch => {
    ch.checked = false;
  });

  // === POBIERZ GRUPY Z BACKENDU I ZAZNACZ CHECKBOXY ===
try {
  // 1) najpierw spr√≥buj z cache (prefetch z adminOpenZawodnik)
  const cacheKey = String(nr || "").trim();
  const cached = window.__adminCache && window.__adminCache[cacheKey] && window.__adminCache[cacheKey].grupy;

  let res = cached;
  if (!res) {
    // fallback: dociƒÖgnij je≈õli cache nie ma
    res = await apiClubGet("adminGrupy", { numer: nr });
  }
  
if (!res || !res.success) {
  console.warn("adminGrupy error:", res);
  if (msg) msg.textContent = "‚ùå B≈ÇƒÖd pobierania grup";
  return;
}

  const grupyStr = String(res.grupy || "").trim();
  const selected = grupyStr
    ? grupyStr.split(",").map(s => s.trim()).filter(Boolean)
    : [];

document.querySelectorAll("#adminGrupyView .adminGrupaChk").forEach(ch => {
  ch.checked = selected.includes(ch.value);
});

if (msg) msg.textContent = "";

} catch (e) {
  console.error("adminGrupy fetch failed:", e);
}
  }
  
async function adminSaveGrupyLocal() {
  const nr = String(window.__adminSelectedNr || "").trim();
  const msg = document.getElementById("adminGrupyMsg");
  if (!nr) { if (msg) msg.textContent = "‚ùå Brak numeru zawodnika."; return; }

  // Zbieramy checkboxy z widoku adminGrupyView (u Ciebie sƒÖ w HTML)
  const picks = document.querySelectorAll("#adminGrupyView .adminGrupaChk");
  const arr = [];
  picks.forEach(ch => { if (ch.checked) arr.push(String(ch.value || "").trim()); });

  // Format zapisu: "G1,G3" (bez spacji) ‚Äì najbezpieczniej do arkusza
  const grupyCsv = arr
    .filter(Boolean)
    .sort((a,b)=>Number(String(a).replace("G",""))-Number(String(b).replace("G","")))
    .join(",");

  if (msg) msg.textContent = "‚è≥ Zapisujƒô‚Ä¶";

  try {
    const r = await apiClubPost({ action:"adminSetGrupy", numer: nr, grupy: grupyCsv });
    if (!r || !(r.success || r.ok)) {
      if (msg) msg.textContent = "‚ùå " + (r?.error || r?.message || "B≈ÇƒÖd zapisu");
      return;
    }

    if (msg) msg.textContent = "‚úÖ Zapisane: " + (grupyCsv || "‚Äî");
  } catch (e) {
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

  /* =================== ADMIN: STATYSTYKI (reuse statsView) =================== */
// ADMIN: Statystyki zawodnika (reuse ekranu zawodnika)
  
async function adminOpenStats() {
  const nr = String(window.__adminSelectedNr || "").trim();
  const nazw = String(window.__adminSelectedNazw || "").trim();
  if (!nr) {
    alert("‚ùå Brak wybranego zawodnika (nr).");
    return;
  }

  goToView("adminStatsView");

  const title = document.getElementById("adminStatsTitle");
  if (title) title.textContent = `Statystyki ‚Äî #${nr}${nazw ? " ‚Äî " + nazw : ""}`;

  const body = document.getElementById("adminStatsBody");
  if (body) body.innerHTML = `<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>`;

  try {
    const lista = await apiClubGet("statystyki", { numer: nr });

    // wstawiamy tymczasowy kontener o ID, kt√≥rego u≈ºywa renderStatystyki
    if (body) {
      body.innerHTML = `<div id="listaStatystyk"></div>`;
      renderStatystyki(lista);
    }

  } catch (e) {
    if (body) body.innerHTML =
      `<div class="card" style="background:#700;">‚ùå B≈ÇƒÖd: ${e?.message || e}</div>`;
  }
}
  
function adminCloseGroupsPopup() {
  const pop = document.getElementById("adminGroupsPopup");
  if (pop) pop.classList.add("hidden");
}

async function adminApplyGroupsPopup() {
  const msg = document.getElementById("adminGroupsMsg");
  if (msg) msg.textContent = "‚è≥ Zapisujƒô‚Ä¶";

  const picks = document.querySelectorAll("#adminGroupsGrid .adminGrpPick");
  __adminGroupsSet = new Set();
  picks.forEach(ch => { if (ch.checked) __adminGroupsSet.add(ch.value); });

  // ‚¨á‚¨á‚¨á TU leci zapis do backendu (akcjƒô dopniemy w CORE)
  const grupyCsv = Array.from(__adminGroupsSet).sort((a,b)=>Number(a.slice(1))-Number(b.slice(1))).join(",");

  try {
    const r = await apiClubPost({ action:"adminSetGrupy", numer: __adminSelectedNr, grupy: grupyCsv });
    if (!r || !(r.success || r.ok)) {
      if (msg) msg.textContent = "‚ùå " + (r?.error || r?.message || "B≈ÇƒÖd zapisu");
      return;
    }
    if (msg) msg.textContent = "‚úÖ Zapisane: " + (grupyCsv || "‚Äî");
    setTimeout(adminCloseGroupsPopup, 350);
  } catch (e) {
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}


// =================== P≈ÅATNO≈öCI ===================
async function adminOpenPayments() {
  const nr = String(window.__adminSelectedNr || "").trim();
  if (!nr) return alert("‚ùå Brak wybranego zawodnika.");

  goToView("adminPaymentsView");

  const title = document.getElementById("adminPaymentsTitle");
  if (title) title.textContent = `P≈Çatno≈õci ‚Äî #${nr}`;

  const body = document.getElementById("adminPaymentsBody");
  const msg  = document.getElementById("adminPaymentsMsg");
  if (msg) msg.textContent = "";
  if (body) body.innerHTML = "<div class='card' style='background:#222;'>‚è≥ ≈Åadowanie...</div>";

  try {
    const res = await apiClubGet("platnosciAdmin", { numer: nr });
    renderAdminPayments_(res);
  } catch (e) {
    if (body) body.innerHTML = `<div class="card" style="background:#700;">‚ùå B≈ÇƒÖd: ${e?.message || e}</div>`;
  }
}

function renderPaymentsSection_(title, arr) {
  if (!arr || arr.length === 0) {
    return `<div class="card" style="background:#111; margin-top:10px;"><b>${title}</b><br><span style="opacity:.8;">Brak danych</span></div>`;
  }

  return `
    <div class="card" style="background:#111; margin-top:10px; text-align:left;">
      <b>${title}</b>
    </div>
    ${arr.map(renderPaymentTile_).join("")}
  `;
}

function renderPaymentTile_(p) {
  const paid = !!p.zaplacono;
  const kw = Number(p.kwota || 0);

  const bg = paid ? "#123a1a" : "#3a1414";
  const badge = paid
    ? `<span style="color:#7CFF7C; font-weight:700;">ZAP≈ÅACONE</span>`
    : `<span style="color:#FF7C7C; font-weight:700;">NIEZAP≈ÅACONE</span>`;

  const safeLabel = String(p.label || p.nazwa || "").replace(/'/g, "\\'");

  // ‚úÖ przekazujemy kolumnƒô, a nie nr zawodnika
  const btn = (!paid)
    ? `<button class="full-btn" style="margin-top:10px;" onclick="adminConfirmPayment(${Number(p.col)}, '${safeLabel}')">Zarejestruj p≈Çatno≈õƒá</button>`
    : "";

  return `
    <div class="card" style="background:${bg}; text-align:left; margin-top:10px;">
      <div style="display:flex; justify-content:space-between; gap:10px;">
        <div>
          <div style="opacity:.9; font-size:14px;">${p.typ === "skladka" ? "Sk≈Çadka" : "Zajƒôcia dodatkowe"}</div>
          <div style="font-size:18px; font-weight:800;">${p.label || ""}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:18px; font-weight:800;">${kw} z≈Ç</div>
          <div style="margin-top:2px;">${badge}</div>
        </div>
      </div>
      ${btn}
    </div>
  `;
}
  
function adminOpenPayConfirmModal_(text, onYes) {
  const modal = document.getElementById("adminPayConfirmModal");
  const txt   = document.getElementById("adminPayConfirmText");
  const msg   = document.getElementById("adminPayConfirmMsg");
  const yes   = document.getElementById("adminPayConfirmYesBtn");
  const no    = document.getElementById("adminPayConfirmNoBtn");

  if (!modal || !txt || !yes || !no) {
    alert("‚ùå Brak element√≥w modala potwierdzenia w HTML.");
    return;
  }

  if (txt) txt.textContent = text || "Potwierdzam zap≈Çatƒô";
  if (msg) msg.textContent = "";

  // wyczy≈õƒá stare bindy (najpro≈õciej przez klon)
  const yesClone = yes.cloneNode(true);
  yes.parentNode.replaceChild(yesClone, yes);

  const noClone = no.cloneNode(true);
  no.parentNode.replaceChild(noClone, no);

  // bind: TAK
  yesClone.addEventListener("click", async () => {
    try {
      yesClone.disabled = true;
      noClone.disabled  = true;
      if (msg) msg.textContent = "‚è≥ Zapisujƒô‚Ä¶";

      await onYes();

      // je≈õli zapis OK -> zamykamy
      adminClosePayConfirmModal_();
    } catch (e) {
      if (msg) msg.textContent = "‚ùå " + (e?.message || e);
      yesClone.disabled = false;
      noClone.disabled  = false;
    }
  });

  // bind: NIE
  noClone.addEventListener("click", () => {
    adminClosePayConfirmModal_(); // zamyka modal
  });

  modal.classList.remove("hidden");
}
  window.__adminPendingPayCol = null;
window.__adminPendingPayLabel = "";

function adminAskConfirmPayment(col, label) {
  window.__adminPendingPayCol = Number(col);
  window.__adminPendingPayLabel = String(label || "");

  // Nowy modal (sp√≥jny z Panelem 2)
  const modal = document.getElementById("adminPayConfirmModal");
  const text  = document.getElementById("adminPayConfirmText");
  const msg   = document.getElementById("adminPayConfirmMsg");
  const yes   = document.getElementById("adminPayConfirmYesBtn");
  const no    = document.getElementById("adminPayConfirmNoBtn");

  if (!modal || !text || !yes || !no) {
    console.error("Brak element√≥w adminPayConfirmModal.*");
    alert("‚ùå Brak element√≥w modala potwierdzenia p≈Çatno≈õci (adminPayConfirmModal).");
    return;
  }

  // Ustaw tre≈õƒá
  text.textContent = window.__adminPendingPayLabel
    ? ("Potwierdzam zap≈Çatƒô: " + window.__adminPendingPayLabel)
    : "Potwierdzam zap≈Çatƒô";

  if (msg) msg.textContent = "";

  // Pod≈ÇƒÖcz akcje (bez dublowania event√≥w)
  yes.onclick = () => adminDoConfirmPayment();
  no.onclick  = () => adminCancelConfirmPayment();

  // Poka≈º modal
  modal.classList.remove("hidden");
}

async function adminDoConfirmPayment() {
  const yesBtn = document.getElementById("adminConfirmPayYes");
  if (yesBtn) {
    yesBtn.disabled = true;
    yesBtn.style.opacity = "0.6";
    yesBtn.textContent = "‚è≥ Zapisujƒô‚Ä¶";
  }

  const col = Number(window.__adminPendingPayCol);
  const nr  = String(window.__adminSelectedNr || "").trim();

  try {
    const r = await apiClubPost({
      action: "potwierdzPlatnoscAdmin",
      numer: nr,
      col: col
    });

    // poka≈º debug (TYLKO NA TERAZ, potem usuniemy)
    console.log("potwierdzPlatnoscAdmin response:", r);
    alert("DEBUG:\n" + JSON.stringify(r?.debug || r, null, 2));

    if (!r || !r.success) {
      alert("‚ùå Nie zapisano: " + (r?.error || r?.message || "B≈ÇƒÖd"));
      return; // IMPORTANT: finally odblokuje przycisk
    }

    document.getElementById("adminConfirmPayPopup").classList.add("hidden");
    await adminOpenPayments();

  } catch (e) {
    alert("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e));
  } finally {
    // ‚úÖ zawsze odblokuj TAK
    if (yesBtn) {
      yesBtn.disabled = false;
      yesBtn.style.opacity = "1";
      yesBtn.textContent = "TAK";
    }
  }
}
  
function adminCancelConfirmPayment() {
  document.getElementById("adminConfirmPayPopup").classList.add("hidden");
}

function adminClosePayConfirmModal_() {
  const modal = document.getElementById("adminPayConfirmModal");
  if (modal) modal.classList.add("hidden");
}

// =================== ADMIN: KLIK "Zarejestruj p≈Çatno≈õƒá" ===================
function renderAdminPayments_(res) {
  const body = document.getElementById("adminPaymentsBody");
  const msg  = document.getElementById("adminPaymentsMsg");
  if (!body) return;

  if (!res || res.success === false) {
    body.innerHTML = `<div class="card" style="background:#700;">‚ùå ${res?.error || res?.message || "Brak danych"}</div>`;
    return;
  }

  const items = Array.isArray(res.items) ? res.items : [];
  if (items.length === 0) {
    body.innerHTML = `<div class="card" style="background:#111;">Brak p≈Çatno≈õci do wy≈õwietlenia</div>`;
    return;
  }

   const skladki = items.filter(x => x.typ === "skladka");
  const zajecia = items.filter(x =>
  x.typ === "zajecia" &&
  x.kwota !== null && x.kwota !== undefined && String(x.kwota).trim() !== "" &&
  Number(x.kwota) > 0
);

  body.innerHTML = `
    ${renderPaymentsSection_("Sk≈Çadki", skladki)}
    ${renderPaymentsSection_("Zajƒôcia dodatkowe", zajecia)}
  `;

  // ‚úÖ stabilny handler (bez inline onclick i bez ryzyka apostrof√≥w)
  body.querySelectorAll("button.adminPayBtn").forEach(btn => {
    btn.addEventListener("click", (ev) => {
      const b = ev.currentTarget;
      const col = Number(b?.dataset?.col);
      const label = decodeURIComponent(String(b?.dataset?.label || ""));
      adminConfirmPayment(col, label);
    });
  });

  if (msg) msg.textContent = "";
}

function renderPaymentsSection_(title, arr) {
  if (!arr || arr.length === 0) {
    return `<div class="card" style="background:#111; margin-top:10px;"><b>${title}</b><br><span style="opacity:.8;">Brak danych</span></div>`;
  }

  return `
    <div class="card" style="background:#111; margin-top:10px; text-align:left;">
      <b>${title}</b>
    </div>
    ${arr.map(renderPaymentTile_).join("")}
  `;
}

function renderPaymentTile_(p) {
  const paid = !!p.zaplacono;
  const kw = Number(p.kwota || 0);

  const bg = paid ? "#123a1a" : "#3a1414";
  const badge = paid
    ? `<span style="color:#7CFF7C; font-weight:700;">ZAP≈ÅACONE</span>`
    : `<span style="color:#FF7C7C; font-weight:700;">NIEZAP≈ÅACONE</span>`;

  const colNum = Number(p.col);

  // Bezpieczny tekst do HTML (wy≈õwietlanie)
  const labelTxt = String(p.label || p.nazwa || "");
  const labelHtml = labelTxt
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");

  // Bezpieczny tekst do dataset (klik) ‚Äî percent-encoding (zero apostrof√≥w / cudzys≈Çow√≥w / newlines problem√≥w)
  const labelData = encodeURIComponent(labelTxt);

  const btn = (!paid)
    ? `<button class="full-btn adminPayBtn"
          style="margin-top:10px;"
          data-col="${Number.isFinite(colNum) ? colNum : ""}"
          data-label="${labelData}">
         Zarejestruj p≈Çatno≈õƒá
       </button>`
    : "";

  return `
    <div class="card" style="background:${bg}; text-align:left; margin-top:10px;">
      <div style="display:flex; justify-content:space-between; gap:10px;">
        <div>
          <div style="opacity:.9; font-size:14px;">${p.typ === "skladka" ? "Sk≈Çadka" : "Zajƒôcia dodatkowe"}</div>
          <div style="font-size:18px; font-weight:800;">${labelHtml}</div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:18px; font-weight:800;">${kw} z≈Ç</div>
          <div style="margin-top:2px;">${badge}</div>
        </div>
      </div>
      ${btn}
    </div>
  `;
}

// =================== ADMIN: CONFIRM P≈ÅATNO≈öCI (POPUP #adminConfirmPayPopup) ===================
window.__adminPendingPayCol = null;
window.__adminPendingPayLabel = "";

function adminConfirmPayment(colNum, label) {
  const nr  = String(window.__adminSelectedNr || "").trim();
  const col = Number(colNum);

  if (!nr) { alert("‚ùå Brak wybranego zawodnika."); return; }
  if (!Number.isFinite(col) || col < 1) { alert("‚ùå Brak poprawnej kolumny p≈Çatno≈õci."); return; }

  window.__adminPendingPayCol = col;
  window.__adminPendingPayLabel = String(label || "");

  // ‚úÖ Overlay style (je≈õli HTML nie ma) ‚Äî ustawiamy raz
  const pop = document.getElementById("adminConfirmPayPopup");
  if (!pop) { alert("‚ùå Brak #adminConfirmPayPopup w HTML."); return; }
  if (!pop.dataset.styled) {
    pop.dataset.styled = "1";
    pop.style.position = "fixed";
    pop.style.inset = "0";
    pop.style.zIndex = "99999";
    pop.style.display = "flex";
    pop.style.alignItems = "center";
    pop.style.justifyContent = "center";
    pop.style.padding = "16px";
    pop.style.background = "rgba(0,0,0,0.65)";
  }

  const msg = document.getElementById("adminConfirmPayMsg");
  if (msg) msg.textContent = window.__adminPendingPayLabel
    ? ("Potwierdzam zap≈Çatƒô: " + window.__adminPendingPayLabel)
    : "Potwierdzam zap≈Çatƒô";

  // ‚úÖ Podpinamy guziki na pewno (nie zak≈Çadamy onclick w HTML)
  const yesBtn = document.getElementById("adminConfirmPayYes");
  if (yesBtn) yesBtn.onclick = adminDoConfirmPayment;

  // przycisk NIE: szukamy po ID je≈õli masz, a jak nie masz ‚Äî zostaje Tw√≥j istniejƒÖcy onclick w HTML
  const noBtn =
    document.getElementById("adminConfirmPayNo") ||
    document.getElementById("adminConfirmPayCancel") ||
    pop.querySelector("button[data-no='1']");

  if (noBtn) noBtn.onclick = adminCancelConfirmPayment;

  pop.classList.remove("hidden");
}

async function adminDoConfirmPayment() {
  const yesBtn = document.getElementById("adminConfirmPayYes");
  if (yesBtn) {
    yesBtn.disabled = true;
    yesBtn.style.opacity = "0.6";
    yesBtn.textContent = "‚è≥ Zapisujƒô‚Ä¶";
  }

  const col = Number(window.__adminPendingPayCol);
  const nr  = String(window.__adminSelectedNr || "").trim();

  try {
    const r = await apiClubPost({
      action: "adminConfirmPlatnosc",   // ‚úÖ dok≈Çadnie jak by≈Ço w confirm()
      numer: nr,
      col: col
    });

    if (!r || !(r.success || r.ok)) {
      alert("‚ùå Nie zapisano: " + (r?.error || r?.message || "B≈ÇƒÖd"));
      return;
    }

    adminCancelConfirmPayment();
    await adminOpenPayments(); // od≈õwie≈º jak by≈Ço
  } catch (e) {
    alert("‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e));
  } finally {
    if (yesBtn) {
      yesBtn.disabled = false;
      yesBtn.style.opacity = "1";
      yesBtn.textContent = "TAK";
    }
    window.__adminPendingPayCol = null;
    window.__adminPendingPayLabel = "";
  }
}

function adminCancelConfirmPayment() {
  const pop = document.getElementById("adminConfirmPayPopup");
  if (pop) pop.classList.add("hidden");
}
  
  /* =================== 70 LOGOWANIE / REJESTRACJA =================== */
function pokazLogowanie() {
  numerZalogowanego = null;
  grupaZalogowanego = null;
  window.grupyTrenera = "";
  refreshClubBadge_();
  goToView("loginView");
}
function pokazRejestracjaSelect() { goToView("registerSelectView"); }
function pokazRejestracjaZawodnik() { goToView("registerZawodnikView"); }
function pokazRejestracjaTrener() { goToView("rejestracjaTrenerView"); }
  

async function zaloguj() {
  const login = document.getElementById("numer").value.trim();
  const haslo = document.getElementById("haslo").value.trim();
  const komunikat = document.getElementById("komunikat");

  if (!clubId) { komunikat.innerText = "Najpierw skonfiguruj klub."; goToView("orgHubLandingView"); return; }
  if (!login || !haslo) { komunikat.innerText = "Podaj login i has≈Ço."; return; }

  komunikat.innerText = "Trwa logowanie...";

  try {
    const data = await apiClubPost({ mode: "login", numer: login, haslo });
    
if (!data.success) {
  const err = data?.error || data?.message || "B≈ÇƒÖd logowania";
  komunikat.innerText = "‚ùå " + err;
  return;
}

    komunikat.innerText = "‚úÖ Zalogowano";

    if (data.role === "zawodnik") {
      numerZalogowanego = data.login;
      grupaZalogowanego = data.grupa || "";

      const platnosci = await apiClubGet("platnosci", { numer: numerZalogowanego });
      if (Array.isArray(platnosci) && platnosci.length > 0) {
        goToView("platnosciView");
        renderPlatnosci(platnosci);
        return;
      }

      await pokazTreningi();
      return;
    }

    if (data.role === "trener") {
      window.grupyTrenera = data.grupa || "";
      goToView("trainerPanelView");
      return;
    }

    if (data.role === "admin") {
  goToView("adminPanelView");
  return;
}

  } catch (e) {
    komunikat.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia: " + (e?.message || e);
  }
}

/* =================== 75 REJESTRACJA =================== */
async function wyslijRejestracje() {
  const numer = document.getElementById("regNumer").value.trim();
  const nazwisko = document.getElementById("regNazwisko").value.trim();
  const haslo = document.getElementById("regHaslo").value.trim();
  const msg = document.getElementById("regMsg");

  if (!numer || !nazwisko || !haslo) {
    msg.innerText = "Wype≈Çnij wszystkie pola.";
    return;
  }

  msg.innerText = "‚è≥ Rejestracja...";
  try {
    const data = await apiClubPost({ mode: "rejestracja", numer, nazwisko, haslo });

    if (data && data.ok) {
      document.getElementById("regNumer").value = "";
      document.getElementById("regNazwisko").value = "";
      document.getElementById("regHaslo").value = "";
      msg.innerText = "‚úÖ Rejestracja zako≈Ñczona!";
      setTimeout(() => { msg.innerText = ""; pokazLogowanie(); }, 1500);
    } else {
      msg.innerText = "‚ùå " + (data?.error || data?.message || data?.msg || JSON.stringify(data));
    }
  } catch (e) {
    msg.innerText = "‚ùå " + (e?.message || e);
  }
}

async function wyslijRejestracjeTrener() {
  const poleNazw = document.getElementById("regNazwiskoTrener");
  const poleHaslo = document.getElementById("regHasloTrener");
  const msg = document.getElementById("regMsgTrener");

  const nazwisko = poleNazw.value.trim();
  const haslo = poleHaslo.value.trim();

  if (!nazwisko || !haslo) {
    msg.innerText = "Wype≈Çnij wszystkie pola.";
    return;
  }

  msg.innerText = "‚è≥ Rejestracja...";

  try {
    const data = await apiClubPost({
      mode: "rejestracjaTrener",
      nazwisko,
      haslo
    });

    if (data && data.ok) {
      const inic = String(data.inic || "").toUpperCase() || "(?)";

      msg.innerHTML = `
        ‚úÖ <b>Zarejestrowano trenera!</b><br>
        Login do systemu:<br>
        <div style="font-size:22px;font-weight:800;letter-spacing:2px;margin:10px 0 14px 0;">
          ${inic}
        </div>

        <button class="full-btn" id="btnCopyInic">üìã Skopiuj login</button>
        <button class="full-btn alt" id="btnGoLogin" disabled>
          ‚û°Ô∏è Przejd≈∫ do logowania
        </button>

        <div id="copyInfo" style="opacity:.8;margin-top:10px;font-size:13px;"></div>
      `;

      poleNazw.value = "";
      poleHaslo.value = "";

      const btnCopy = document.getElementById("btnCopyInic");
      const btnGo = document.getElementById("btnGoLogin");
      const info = document.getElementById("copyInfo");

      if (btnCopy) {
        btnCopy.onclick = async () => {
          try {
            await navigator.clipboard.writeText(inic);
            btnCopy.textContent = "‚úÖ Skopiowano";
            if (info) info.textContent = "Mo≈ºesz teraz przej≈õƒá do logowania.";
            if (btnGo) btnGo.disabled = false;
          } catch (e) {
            if (info) {
              info.textContent =
                "‚ùå Nie uda≈Ço siƒô skopiowaƒá. Zaznacz login rƒôcznie: " + inic;
            }
          }
        };
      }

      if (btnGo) {
        btnGo.onclick = () => pokazLogowanie();
      }

    } else {
      msg.innerText =
        "‚ùå " + (data?.error || data?.message || data?.msg || JSON.stringify(data));
    }

  } catch (e) {
    msg.innerText = "‚ùå " + (e?.message || e);
  }
}



/* =================== 80 ZAWODNIK: TRENINGI / ZAPISY =================== */
  
function renderPlatnosci(lista) {
  const div = document.getElementById("listaPlatnosci");

  if (!lista?.length) {
    div.innerHTML =
      "<p>Brak zaleg≈Ço≈õci ‚úÖ</p>" +
      "<button class='full-btn' onclick='pokazTreningi()'>Dalej ‚û°</button>";
    return;
  }

  div.innerHTML =
    "<h3>P≈ÅATNO≈öCI</h3>" +
    lista.map(p => {
      // red = zaleg≈Ço≈õƒá
      // green = op≈Çacone / w terminie
      if (p.status === "green") {
        return `
          <div class="card status-green">
            <div style="font-weight:700;">${p.nazwa}</div>
            <div>${p.kwota} z≈Ç</div>
          </div>
        `;
      } else {
        // dok≈Çadnie styl aplikacji jak przycisk "Zapisz siƒô"
return `
  <div class="card status-red">
    <div style="font-weight:700;">${p.nazwa}</div>
    <div>${p.kwota} z≈Ç</div>
  </div>
`;

      }
    }).join('') +
    `<button class="full-btn" onclick="pokazTreningi()" style="margin-top:20px;">Dalej ‚û°</button>`;
}

  function parsePlatnoscMeta_(nazwa){
  if (!nazwa) return null;

  const lower = nazwa.toLowerCase();

  const isSkladka = lower.startsWith("sk≈Çadka");
  const isZajecia = lower.startsWith("zajƒôcia");

  const yearMatch = nazwa.match(/20\d{2}/);
  if (!yearMatch) return null;
  const year = Number(yearMatch[0]);

  const miesiace = [
    "stycze≈Ñ","luty","marzec","kwiecie≈Ñ","maj","czerwiec",
    "lipiec","sierpie≈Ñ","wrzesie≈Ñ","pa≈∫dziernik","listopad","grudzie≈Ñ"
  ];

  const monthIdx = miesiace.findIndex(m => lower.includes(m));
  if (monthIdx === -1) return null;

  return {
    type: isSkladka ? "S" : (isZajecia ? "Z" : null),
    year,
    monthIdx
  };
}

 function getPlatnoscColor_(meta, today){
  if (!meta) return "#b30000"; // mocna czerwie≈Ñ fallback

  const GREEN = "#00c853";  // zielony jak sygnalizacja (mocny)
  const RED   = "#ff0000";  // agresywna czerwie≈Ñ

  const paymentMonth = new Date(meta.year, meta.monthIdx, 1);
  const nextMonth = new Date(meta.year, meta.monthIdx + 1, 1);

  // ======================
  // SK≈ÅADKA
  // ======================
  if (meta.type === "S") {
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();

    // bie≈ºƒÖcy miesiƒÖc ‚Üí zielony
    if (meta.year === currentYear && meta.monthIdx === currentMonth) {
      return GREEN;
    }

    // zaleg≈Çe ‚Üí czerwony
    return RED;
  }

  // ======================
  // ZAJƒòCIA DODATKOWE
  // ======================
  if (meta.type === "Z") {
    // deadline: 15 dzie≈Ñ nastƒôpnego miesiƒÖca
    const deadline = new Date(meta.year, meta.monthIdx + 1, 15);
    deadline.setHours(0,0,0,0);

    if (today <= deadline) {
      return GREEN; // jeszcze czas na rozliczenie
    } else {
      return RED;   // po 15 ‚Äì wali po oczach
    }
  }

  return RED;
}

  function formatPlatnoscNazwa_(txt){
  if (!txt) return "";
  return String(txt)
    .replace(/^Sk≈Çadka\s*\(.*?\)\s*/i, "Sk≈Çadka ")
    .replace(/^Zajƒôcia dodatkowe\s*/i, "Zajƒôcia ");
}

async function pokazTreningi() {
  goToView("homeView");
  const lista = await apiClubGet("treningi", { grupa: grupaZalogowanego, numer: numerZalogowanego });
  renderTreningi(lista);
}

function powrotDoPlatnosci() {
  goToView("platnosciView", { replace: true });
}
  
function renderTreningi(lista) {
  const div = document.getElementById('listaTreningow');
  if (!lista?.length) { div.innerHTML = "<p>Brak wydarze≈Ñ</p>"; return; }

  div.innerHTML = lista.map(t => `
    <div class="card">
      <p>
        <b>${t.rodzaj}</b> &nbsp;&nbsp; ${t.data} (${t.dzien})<br>
        Godzina: <b>${t.godzStart}</b> ‚Äì <b>${t.godzKoniec}</b><br>
        Trener: <b>${t.trener}</b> &nbsp;&nbsp; Zapisanych: ${t.zapisanych}
      </p>

      <div style="display:flex;justify-content:center;gap:8px;flex-wrap:wrap;">
        <button id="btn-${t.id}" ${t.zapisany ? 'disabled' : ''} onclick="zapiszSie('${t.id}')">
          ${t.zapisany ? 'Zapisano ‚úÖ' : 'Zapisz siƒô'}
        </button>
        <button id="wypisz-${t.id}" ${t.zapisany ? '' : 'disabled'} style="background:#444;" onclick="wypiszSie('${t.id}')">
          Wypisz siƒô
        </button>
        <button style="background:#333;" onclick="toggleZapisani('${t.id}')">üë• Zapisani</button>
      </div>

      <div id="zapisani-${t.id}" class="hidden lista-zapisanych"></div>
    </div>
  `).join('');
}

async function toggleZapisani(id) {
  const box = document.getElementById(`zapisani-${id}`);
  if (!box) return;

  if (!box.classList.contains('hidden')) { box.classList.add('hidden'); return; }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>';

  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd pobierania listy</div>';
  }
}

async function zapiszSie(id) {
  const btn = document.getElementById(`btn-${id}`);
  const wypiszBtn = document.getElementById(`wypisz-${id}`);
  const box = document.getElementById(`zapisani-${id}`);

  btn.classList.add("loading");
  try {
    const r = await apiClubGet("zapisz", { numer: numerZalogowanego, treningId: id });
    if (r.ok) {
      btn.innerText = "Zapisano ‚úÖ";
      btn.disabled = true;
      wypiszBtn.disabled = false;
      if (box && !box.classList.contains("hidden")) await odswiezListeZapisanych(id);
    } else alert(r.message);
  } catch (err) {
    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + err);
  } finally {
    btn.classList.remove("loading");
  }
}

async function wypiszSie(id) {
  const btn = document.getElementById(`wypisz-${id}`);
  const zapiszBtn = document.getElementById(`btn-${id}`);
  const box = document.getElementById(`zapisani-${id}`);

  btn.classList.add("loading");
  try {
    const r = await apiClubGet("wypisz", { numer: numerZalogowanego, treningId: id });
    if (r.ok) {
      zapiszBtn.innerText = "Zapisz siƒô";
      zapiszBtn.disabled = false;
      btn.disabled = true;
      if (box && !box.classList.contains("hidden")) await odswiezListeZapisanych(id);
    } else alert(r.message);
  } catch (err) {
    alert("B≈ÇƒÖd po≈ÇƒÖczenia: " + err);
  } finally {
    btn.classList.remove("loading");
  }
}

async function odswiezListeZapisanych(id) {
  const box = document.getElementById(`zapisani-${id}`);
  if (!box) return;

  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ Od≈õwie≈ºanie...</div>';
  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd od≈õwie≈ºania</div>';
  }
}

async function pokazStatystyki() {
  try {
    goToView("statsView");

    // WA≈ªNE: apiClubGet ju≈º powinno dokleiƒá clubId i ogarnƒÖƒá SCRIPT_URL wewnƒôtrznie
    const lista = await apiClubGet("statystyki", { numer: numerZalogowanego });

    renderStatystyki(lista);
  } catch (e) {
    const div = document.getElementById("listaStatystyk");
    if (div) div.innerHTML = `<p>B≈ÇƒÖd ≈Çadowania statystyk: ${String(e)}</p>`;
  }
}
function renderStatystyki(lista) {
  // ‚úÖ Kontener zale≈ºny od widoku (admin ma sw√≥j)
  const isAdminStats = (currentView === "adminStatsView");
  const div = isAdminStats
    ? document.getElementById("adminStatsBody")
    : document.getElementById("listaStatystyk");

  if (!div) return;

  if (!Array.isArray(lista) || lista.length === 0) {
    div.innerHTML = "<p>Brak danych</p>";
    return;
  }

  // Kolejno≈õƒá sezonowa: Wrzesie≈Ñ -> Sierpie≈Ñ
  const seasonOrder = ["Wrzesie≈Ñ","Pa≈∫dziernik","Listopad","Grudzie≈Ñ","Stycze≈Ñ","Luty","Marzec","Kwiecie≈Ñ","Maj","Czerwiec","Lipiec","Sierpie≈Ñ"];
  const orderIdx = Object.fromEntries(seasonOrder.map((m, i) => [m.toLowerCase(), i]));

  const sorted = [...lista].sort((a, b) => {
    const ai = orderIdx[String(a.miesiac || "").toLowerCase()];
    const bi = orderIdx[String(b.miesiac || "").toLowerCase()];
    const aIdx = (ai == null ? 999 : ai);
    const bIdx = (bi == null ? 999 : bi);
    return aIdx - bIdx;
  });

  const suma = sorted.reduce((acc, s) => acc + (Number(s.treningi) || 0), 0);

  const now = new Date();
  const currentMonthName = ["Stycze≈Ñ","Luty","Marzec","Kwiecie≈Ñ","Maj","Czerwiec","Lipiec","Sierpie≈Ñ","Wrzesie≈Ñ","Pa≈∫dziernik","Listopad","Grudzie≈Ñ"][now.getMonth()];

  div.innerHTML =
    sorted.map(s => {
      const miesiac = String(s.miesiac || "").trim();
      const treningi = Number(s.treningi) || 0;
      const isCurrent = miesiac.toLowerCase() === currentMonthName.toLowerCase();
      const badge = isCurrent ? ` <span style="opacity:.9;font-weight:700;">(teraz)</span>` : "";

      return `<div class="card">
        üìÖ ${miesiac}${badge} ‚Äî üèí <b>${treningi}</b>
      </div>`;
    }).join("") +
    `<div class="card" style="background:#222;margin-top:20px;font-weight:800;">
      üî• ≈ÅƒÖcznie: ${suma} trening√≥w w sezonie
    </div>`;
}
  
function powrotDoTreningow() {
  goToView("homeView"); // zamiast appBack() ‚Äî stabilne
}
 
/* =================== 90 TRENER: LISTA / WYDARZENIA / DODAWANIE / USUWANIE =================== */
function trainerPowrot() { appBack(); }

  // ‚úÖ MUSI byƒá globalne dla onclick w HTML
window.trainerPokazWydarzenia = async function trainerPokazWydarzenia() {
  goToView("trainerWydarzeniaView");
  try {
    const lista = await apiClubGet("treningiTrener", { grupa: window.grupyTrenera || "" });
    renderTreningiTrainer(lista);
  } catch (e) {
    const div = document.getElementById("trainerListaWydarzen");
    if (div) div.innerHTML = `<div class="card" style="background:#700;">‚ùå B≈ÇƒÖd: ${e?.message || e}</div>`;
  }
};

async function trainerPokazZawodnicy() {
  goToView("trainerZawodnicyView");
  const box = document.getElementById("trainerListaZawodnikow");
  box.innerHTML = "<div class='card' style='background:#222;'>‚è≥ ≈Åadowanie...</div>";

  try {
    const lista = await apiClubGet("listaZawodnikow", { grupy: window.grupyTrenera || "" });
    if (!Array.isArray(lista) || lista.length === 0) {
      box.innerHTML = "<div class='card' style='background:#111;'>Brak danych</div>";
      return;
    }

    box.innerHTML = lista.map(z => `
      <div class="card" style="text-align:left;">
        <b>#${z.nr}</b> ‚Äî ${z.nazwisko}<br>
        <span style="opacity:0.8;">${z.suma} trening√≥w ≈ÇƒÖcznie</span>
      </div>
    `).join('');
  } catch {
    box.innerHTML = "<div class='card' style='background:#700;'>B≈ÇƒÖd pobierania danych</div>";
  }
}

  async function adminPokazZawodnikow() {
  goToView("adminZawodnicyView");
  const box = document.getElementById("adminListaZawodnikow");
  if (box) box.innerHTML = "<div class='card' style='background:#222;'>‚è≥ ≈Åadowanie...</div>";

  try {
    // admin widzi wszystkich ‚Äì nie filtrujemy po grupach
    const lista = await apiClubGet("listaZawodnikow", { grupy: "" });

    if (!Array.isArray(lista) || lista.length === 0) {
      if (box) box.innerHTML = "<div class='card' style='background:#111;'>Brak danych</div>";
      return;
    }

    // prosta lista kart ‚Äì klik w nastƒôpnym kroku otworzy szczeg√≥≈Çy zawodnika
box.innerHTML = lista.map(z => {
  const nr = String(z.nr || "").trim();
  const nazw = String(z.nazwisko || "").replace(/'/g, "\\'");

  return `
    <div class="card" style="text-align:left; cursor:pointer;"
         onclick="adminOpenZawodnik('${nr}','${nazw}')">
      <b>#${nr}</b> ‚Äî ${z.nazwisko}<br>
      <span style="opacity:0.8;">${z.suma} trening√≥w ≈ÇƒÖcznie</span>
    </div>
  `;
}).join('');

  } catch (e) {
    if (box) box.innerHTML = `<div class='card' style='background:#700;'>‚ùå B≈ÇƒÖd: ${e?.message || e}</div>`;
  }
}
  
function renderTreningiTrainer(lista) {
  const div = document.getElementById("trainerListaWydarzen");
  if (!lista?.length) { div.innerHTML = "<p>Brak wydarze≈Ñ</p>"; return; }

  // ‚úÖ Globalna mapa event√≥w dla popupu edycji
  window.__trainerEventsByKey = {};

  // lokalny parser "dd.mm.yyyy" albo "dd-mm-yyyy" -> "yyyy-mm-dd"
  function toISO_(dataTxt) {
    const s = String(dataTxt || "").trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    const m = s.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{4})$/);
    if (!m) return "";
    const dd = String(m[1]).padStart(2, "0");
    const mm = String(m[2]).padStart(2, "0");
    const yyyy = m[3];
    return `${yyyy}-${mm}-${dd}`;
  }

  div.innerHTML = lista.map(t => {
    const key = `${t.miesiac}-${t.czasCol}`;
    const dataISO = toISO_(t.data);

    // ‚úÖ zapisz dane do edycji (bez wrzucania obiekt√≥w do onclick)
    window.__trainerEventsByKey[key] = {
      key,
      miesiac: t.miesiac,
      czasCol: t.czasCol,
      dataISO,
      start: String(t.godzStart || ""),
      end: String(t.godzKoniec || ""),
      rodzaj: String(t.rodzaj || ""),
    };

    return `
      <div class="card" data-event-id="${key}">
        <b>${t.rodzaj}</b> ${t.data} (${t.dzien})<br>
        Godzina: <b>${t.godzStart}</b> ‚Äì <b>${t.godzKoniec}</b><br>
        Trener: <b>${t.trener || "‚Äî"}</b> | Zapisanych: ${t.zapisanych}<br><br>

        <div style="display:flex; justify-content:center; gap:8px; flex-wrap:wrap;">
          <button class="btn" onclick="trainerToggleZapisani('${t.id}')">üë• Zapisani</button>
          <button class="btn" onclick="trainerShowEditPopup('${t.miesiac}', ${t.czasCol})">‚úèÔ∏è Edytuj</button>
          <button class="btn danger" onclick="trainerShowDeletePopup('${t.miesiac}', ${t.czasCol})">üóëÔ∏è Usu≈Ñ</button>
        </div>

        <div id="trainer-zapisani-${t.id}" class="hidden"></div>
      </div>
    `;
  }).join('');
}


async function trainerToggleZapisani(id) {
  const box = document.getElementById(`trainer-zapisani-${id}`);
  if (!box) return;

  if (!box.classList.contains('hidden')) { box.classList.add('hidden'); return; }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="card" style="background:#222;">‚è≥ ≈Åadowanie...</div>';

  try {
    const lista = await apiClubGet("zapisani", { treningId: id });
    if (!Array.isArray(lista) || !lista.length) {
      box.innerHTML = '<div class="card" style="background:#111;">Brak zapisanych</div>';
      return;
    }
    box.innerHTML = `<div class="card" style="background:#111;">
      <b>Lista zapisanych:</b>
      <ul style="margin:6px 0 0 20px; padding:0; list-style-type:none;">
        ${lista.map(p => `<li>${p.nazwisko}</li>`).join('')}
      </ul>
    </div>`;
  } catch {
    box.innerHTML = '<div class="card" style="background:#700;">B≈ÇƒÖd pobierania listy</div>';
  }
}

/* --- dodawanie wydarzenia --- */
async function zaladujListeTrenerow() {
  try {
    const lista = await apiClubGet("getTrenerzy", {});
    const t1 = document.getElementById("eventTrener1");
    const t2 = document.getElementById("eventTrener2");
    t1.innerHTML = "<option value=''>‚Äî wybierz trenera ‚Äî</option>";
    t2.innerHTML = "<option value=''>‚Äî Brak ‚Äî</option>";
    (lista || []).forEach(nazw => {
      t1.innerHTML += `<option value="${nazw}">${nazw}</option>`;
      t2.innerHTML += `<option value="${nazw}">${nazw}</option>`;
    });
  } catch {}
}

  function resetTrenerSelects_() {
  // ukryj kolejne selecty
  ["trener2Wrap","trener3Wrap","trener4Wrap"].forEach(id => {
    const w = document.getElementById(id);
    if (w) w.classList.add("hidden");
  });

  // wyczy≈õƒá warto≈õci (≈ºeby nie ‚Äúpamiƒôta≈Ço‚Äù)
  ["eventTrener1","eventTrener2","eventTrener3","eventTrener4"].forEach(id => {
    const s = document.getElementById(id);
    if (s) s.value = "";
  });
}

// pokazuj kolejny select dopiero gdy wybrano poprzedni
function onTrenerPick(n) {
  const cur = document.getElementById(`eventTrener${n}`);
  const nextWrap = document.getElementById(`trener${n+1}Wrap`);
  if (!cur) return;

  const picked = String(cur.value || "").trim();
  if (nextWrap) {
    if (picked) nextWrap.classList.remove("hidden");
    else nextWrap.classList.add("hidden");
  }
}

  /* ===== EDYCJA: TRENERZY (selecty) ===== */
async function zaladujListeTrenerowDoEdycji() {
  try {
    const lista = await apiClubGet("getTrenerzy", {});
    const ids = ["editTrener1","editTrener2","editTrener3","editTrener4"];

    ids.forEach((id, idx) => {
      const sel = document.getElementById(id);
      if (!sel) return;

      // pierwsza lista ma "wybierz", kolejne majƒÖ "kolejny"
      const firstOpt = (idx === 0)
        ? "<option value=''>‚Äî wybierz trenera ‚Äî</option>"
        : "<option value=''>‚Äî kolejny trener ‚Äî</option>";

      sel.innerHTML = firstOpt + (lista || []).map(n => `<option value="${n}">${n}</option>`).join("");
    });
  } catch (e) {
    console.warn("Nie uda≈Ço siƒô wczytaƒá trener√≥w do edycji", e);
  }
}

function resetEditTrenerSelects_() {
  ["editTrener2Wrap","editTrener3Wrap","editTrener4Wrap"].forEach(id => {
    const w = document.getElementById(id);
    if (w) w.classList.add("hidden");
  });

  ["editTrener1","editTrener2","editTrener3","editTrener4"].forEach(id => {
    const s = document.getElementById(id);
    if (s) s.value = "";
  });
}

function onEditTrenerPick(n) {
  const cur = document.getElementById(`editTrener${n}`);
  const nextWrap = document.getElementById(`editTrener${n+1}Wrap`);
  if (!cur) return;

  const picked = String(cur.value || "").trim();
  if (nextWrap) {
    if (picked) nextWrap.classList.remove("hidden");
    else nextWrap.classList.add("hidden");
  }
}

/* ===== EDYCJA: GRUPY (popup G1‚ÄìG10) ===== */
let selectedEditGroups = new Set(); // np. "G1","G2"...

function renderEditGroupsList_() {
  const box = document.getElementById("editGroupsList");
  if (!box) return;

  const groups = Array.from({ length: 10 }, (_, i) => `G${i + 1}`);

  box.innerHTML = groups.map(g => {
    const checked = selectedEditGroups.has(g) ? "checked" : "";
    return `
      <label style="display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid #333;border-radius:10px;background:#111;">
        <span style="font-weight:700;">${g}</span>
        <input type="checkbox" class="editGrpPick" value="${g}" ${checked} style="transform:scale(1.25);">
      </label>
    `;
  }).join("");
}

function openEditGroupsPopup() {
  renderEditGroupsList_();
  const pop = document.getElementById("editGroupsPopup");
  if (pop) pop.classList.remove("hidden");
}

function closeEditGroupsPopup() {
  const pop = document.getElementById("editGroupsPopup");
  if (pop) pop.classList.add("hidden");
}

function applyEditGroupsPopup() {
  const picks = document.querySelectorAll("#editGroupsList .editGrpPick");
  selectedEditGroups = new Set();
  picks.forEach(ch => { if (ch.checked) selectedEditGroups.add(ch.value); });

  updateEditGroupsSummary_();
  closeEditGroupsPopup();
}

function updateEditGroupsSummary_() {
  const el = document.getElementById("editGroupsSummary");
  if (!el) return;

  const arr = Array.from(selectedEditGroups);
  arr.sort((a, b) => Number(a.slice(1)) - Number(b.slice(1)));

  el.textContent = arr.length ? `‚úÖ Wybrane: ${arr.join(", ")}` : "‚Äî";
}

function resetEditGroups_() {
  selectedEditGroups = new Set();
  updateEditGroupsSummary_();
}

function pokazDodajWydarzenie() {
  goToView("trainerDodajWydarzenieView");

  // ‚úÖ wymu≈õ start kalendarza i zegar√≥w po wej≈õciu do widoku
  try { initEventPickers_(); } catch (e) { console.warn("initEventPickers_ failed:", e); }

  resetTrenerSelects_();
  resetGroups_();
  zaladujListeTrenerow();
}

  /* ===== GRUPY: popup G1‚ÄìG10 ===== */
let selectedGroups = new Set(); // np. "G1","G2"...

function renderGroupsList_() {
  const box = document.getElementById("groupsList");
  if (!box) return;

  const groups = Array.from({ length: 10 }, (_, i) => `G${i + 1}`);

  box.innerHTML = groups.map(g => {
    const checked = selectedGroups.has(g) ? "checked" : "";
    return `
      <label style="display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px solid #333;border-radius:10px;background:#111;">
        <span style="font-weight:700;">${g}</span>
        <input type="checkbox" class="grpPick" value="${g}" ${checked} style="transform:scale(1.25);">
      </label>
    `;
  }).join("");
}

function openGroupsPopup() {
  renderGroupsList_();
  const pop = document.getElementById("groupsPopup");
  if (pop) pop.classList.remove("hidden");
}

function closeGroupsPopup() {
  const pop = document.getElementById("groupsPopup");
  if (pop) pop.classList.add("hidden");
}

function applyGroupsPopup() {
  const picks = document.querySelectorAll("#groupsList .grpPick");
  selectedGroups = new Set();
  picks.forEach(ch => { if (ch.checked) selectedGroups.add(ch.value); });

  updateGroupsSummary_();
  closeGroupsPopup();
}

function updateGroupsSummary_() {
  const el = document.getElementById("groupsSummary");
  if (!el) return;

  const arr = Array.from(selectedGroups);
  arr.sort((a, b) => Number(a.slice(1)) - Number(b.slice(1)));

  el.textContent = arr.length ? `‚úÖ Wybrane: ${arr.join(", ")}` : "‚Äî";
}

function resetGroups_() {
  selectedGroups = new Set();
  updateGroupsSummary_();
}

function validHour(hhmm) { return /^\d{2}:\d{2}$/.test(hhmm); }

async function wyslijNoweWydarzenie() {
  const data = document.getElementById("eventData").value;
  const start = document.getElementById("eventStart").value;
  const end = document.getElementById("eventEnd").value;
  const rodzaj = document.getElementById("eventRodzaj").value;

  const trener1 = document.getElementById("eventTrener1").value;
  const trener2 = document.getElementById("eventTrener2")?.value || "";
  const trener3 = document.getElementById("eventTrener3")?.value || "";
  const trener4 = document.getElementById("eventTrener4")?.value || "";

  const grupy = Array.from(selectedGroups).join(",");
  const liczDoStat = document.getElementById("eventStat").checked;
  const rezerwacjaObiektu = document.getElementById("eventRez")?.checked ? 1 : 0;
  const msg = document.getElementById("eventMsg");

  if (!data || !start || !rodzaj) { msg.innerText = "Uzupe≈Çnij: Data, Godzina, Rodzaj."; return; }
  if (!validHour(start) || !validHour(end)) { msg.innerText = "‚ùå Godzina w formacie HH:MM."; return; }
  if (start >= end) { msg.innerText = "‚ùå Koniec musi byƒá p√≥≈∫niej ni≈º start."; return; }

  msg.innerText = "‚è≥ Dodawanie wydarzenia...";
  try {
const r = await apiClubPost({
  action: "dodajWydarzenie",
  data,
  godzStart: start,
  godzKoniec: end,
  rodzaj,
  trener1,
  trener2,
  trener3,
  trener4,
  grupy,
  liczDoStatystyk: String(liczDoStat),
  rezerwacjaObiektu: rezerwacjaObiektu
});

    msg.innerText = r.message || "Nieznany wynik.";

    if (r.success) {
      document.querySelectorAll("#trainerDodajWydarzenieView input").forEach(i => {
        if (i.type !== "checkbox") i.value = "";
        else i.checked = false;
      });

      resetTrenerSelects_();
      resetGroups_();

      setTimeout(() => trainerPokazWydarzenia(), 800);
    }

  } catch (err) {
    msg.innerText = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + err;
  }
}

function initEventPickers_() {
  // ===== KALENDARZ (flatpickr) =====
  const elDate = document.getElementById("eventData");
  if (elDate && window.flatpickr && !elDate._flatpickr) {
    flatpickr(elDate, {
      dateFormat: "Y-m-d",
      allowInput: true
    });
  }

  // ===== ZEGARY (Clocklet ‚Äì okrƒÖg≈Çe) =====
  const startEl = document.getElementById("eventStart");
  const endEl   = document.getElementById("eventEnd");

  if (window.clocklet) {
    if (startEl) clocklet(startEl);
    if (endEl)   clocklet(endEl);
  }
}
  
 // ===== DELETE WYDARZENIA =====

function trainerShowDeletePopup(miesiac, czasCol) {
  deleteMiesiac = miesiac;
  deleteCzasCol = czasCol;
  document.getElementById("trainerDeletePopup").classList.add("show");
}
function trainerHideDeletePopup() {
  document.getElementById("trainerDeletePopup").classList.remove("show");
}
async function trainerConfirmDeleteYes() {
  trainerHideDeletePopup();

  const treningId = `${deleteMiesiac}-${deleteCzasCol}`;
  const card = document.querySelector(`[data-event-id='${treningId}']`);
  if (card) card.innerHTML = `<div class="card" style="background:#222;text-align:center;">‚è≥ Usuwam wydarzenie‚Ä¶</div>`;

  try {
    const data = await apiClubGet("usunWydarzenie", { treningId });
    if (data.success) {
      if (card) card.innerHTML = `<div class="card" style="background:#152;text-align:center;">üóëÔ∏è Usuniƒôto</div>`;
      setTimeout(() => trainerPokazWydarzenia(), 800);
    } else {
      if (card) card.innerHTML = `<div class="card" style="background:#522;text-align:center;">‚ùå ${data.error || "B≈ÇƒÖd"}</div>`;
    }
  } catch (err) {
    if (card) card.innerHTML = `<div class="card" style="background:#522;text-align:center;">‚ùå ${err}</div>`;
  }
}
  
/* =================== 90B TRENER: EDYCJA WYDARZENIA (POPUP) =================== */

// stan edycji
let editMiesiac = null;
let editCol5 = null;

// otwarcie popupu + wype≈Çnienie p√≥l + dociƒÖgniƒôcie trener√≥w i grup (bez psucia startu apki)
async function trainerShowEditPopup(miesiac, col5) {
  editMiesiac = String(miesiac || "");
  editCol5 = Number(col5);

  const pop = document.getElementById("trainerEditPopup");
  const msg = document.getElementById("editEventMsg");
  if (msg) msg.textContent = "‚è≥ ≈Åadujƒô trener√≥w i grupy...";

  // 1) podstawowe pola z cache listy (od razu)
  const key = `${editMiesiac}-${editCol5}`;
  const cached = window.__trainerEventsByKey ? window.__trainerEventsByKey[key] : null;

  const d = document.getElementById("editEventData");
  const s = document.getElementById("editEventStart");
  const e = document.getElementById("editEventEnd");
  const r = document.getElementById("editEventRodzaj");

  if (d) d.value = cached?.dataISO || "";
  if (s) s.value = cached?.start || "";
  if (e) e.value = cached?.end || "";
  if (r) r.value = cached?.rodzaj || "";

  // 2) reset UI (≈ºeby nie pamiƒôta≈Ço)
  resetEditTrenerSelects_();
  resetEditGroups_();

  // 3) poka≈º popup od razu, ale z komunikatem "≈Çadujƒô"
  if (pop) pop.style.display = "flex";

  // ‚úÖ zawsze podepnij klik do przycisku w tym popupie (unikamy duplikat√≥w ID w innych miejscach)
const saveBtn = pop ? pop.querySelector("#btnEditSave") : null;
if (saveBtn) saveBtn.onclick = trainerSaveEditEvent;

  // 4) za≈Çaduj opcje trener√≥w do select√≥w
  await zaladujListeTrenerowDoEdycji();

  // 5) pobierz szczeg√≥≈Çy wydarzenia (trenerzy + grupy)
  try {
    const treningId = `${editMiesiac}-${editCol5}`;
    const details = await apiClubGet("wydarzenieDetails", { treningId });

if (details?.success) {
  const trenerArr = normalizeTrenerzy_(details?.trenerzy);
  const grupyArr  = normalizeGrupy_(details?.grupy);

  setEditTrenerzy_(trenerArr);
  setEditGroups_(grupyArr);

  // === NOWE: ustaw checkboxy z backendu ===
  const chkStat = document.getElementById("editEventStat");
  const chkRez  = document.getElementById("editEventRez");

  if (chkStat) chkStat.checked = !!details.liczDoStatystyk;
  if (chkRez)  chkRez.checked  = !!details.rezerwacjaObiektu;

  if (msg) msg.textContent = ""; // gotowe

    } else {
      if (msg) msg.textContent = "‚ö†Ô∏è Nie uda≈Ço siƒô wczytaƒá trener√≥w i grup.";
      console.warn("wydarzenieDetails:", details);
    }
  } catch (err) {
    if (msg) msg.textContent = "‚ö†Ô∏è B≈ÇƒÖd pobierania trener√≥w i grup.";
    console.warn(err);
  }
}

function trainerHideEditPopup() {
  const pop = document.getElementById("trainerEditPopup");
  if (pop) pop.style.display = "none";
  editMiesiac = null;
  editCol5 = null;

  const msg = document.getElementById("editEventMsg");
  if (msg) msg.textContent = "";
}

function validHour_(hhmm) { return /^\d{2}:\d{2}$/.test(String(hhmm || "")); }

function normalizeTrenerzy_(input) {
  if (!input) return [];
  if (Array.isArray(input)) return input.map(x => String(x||"").trim()).filter(Boolean);
  // string: "A, B" albo "A;B"
  return String(input)
    .split(/[,;]+/)
    .map(s => s.trim())
    .filter(Boolean);
}

function normalizeGrupy_(input) {
  if (!input) return [];
  if (Array.isArray(input)) return input.map(x => String(x||"").trim()).filter(Boolean);
  return String(input)
    .split(/[,;]+/)
    .map(s => s.trim())
    .filter(Boolean);
}

function setEditTrenerzy_(arr) {
  const t = (arr || []).slice(0, 4);

  const s1 = document.getElementById("editTrener1");
  const s2 = document.getElementById("editTrener2");
  const s3 = document.getElementById("editTrener3");
  const s4 = document.getElementById("editTrener4");

  if (s1) s1.value = t[0] || "";
  if (s2) s2.value = t[1] || "";
  if (s3) s3.value = t[2] || "";
  if (s4) s4.value = t[3] || "";

  // ‚úÖ poka≈º wrapy zale≈ºnie od tego, czy poprzedni trener istnieje
  const w2 = document.getElementById("editTrener2Wrap");
  const w3 = document.getElementById("editTrener3Wrap");
  const w4 = document.getElementById("editTrener4Wrap");

  if (w2) (t[0] ? w2.classList.remove("hidden") : w2.classList.add("hidden"));
  if (w3) (t[1] ? w3.classList.remove("hidden") : w3.classList.add("hidden"));
  if (w4) (t[2] ? w4.classList.remove("hidden") : w4.classList.add("hidden"));

  // ‚úÖ wymu≈õ ‚Äúrefresh‚Äù dla select√≥w (czasem Safari/Chrome na mobile lubi nie przerysowaƒá)
  [s1, s2, s3, s4].forEach(sel => {
    if (!sel) return;
    sel.dispatchEvent(new Event("change", { bubbles: true }));
  });
}
function setEditGroups_(arr) {
  selectedEditGroups = new Set((arr || []).map(x => String(x||"").trim()).filter(Boolean));

  // ‚úÖ od razu poka≈º summary na ekranie (bez klikania w "Wybierz grupy")
  updateEditGroupsSummary_();

  // ‚úÖ i od razu przygotuj listƒô (≈ºeby po otwarciu popupu checkboxy by≈Çy ju≈º gotowe)
  renderEditGroupsList_();
}

// zapis do backendu
async function trainerSaveEditEvent() {
  const msg = document.getElementById("editEventMsg");
  if (msg) msg.textContent = "";

  const btn = document.getElementById("btnEditSave");
  if (btn) { btn.classList.add("loading"); btn.disabled = true; }

  try {
    if (!editMiesiac || !editCol5) {
      if (msg) msg.textContent = "‚ùå Brak identyfikatora wydarzenia.";
      return;
    }

    const dataISO = (document.getElementById("editEventData")?.value || "").trim();
    const start = (document.getElementById("editEventStart")?.value || "").trim();
    const end   = (document.getElementById("editEventEnd")?.value || "").trim();
    const rodzaj = (document.getElementById("editEventRodzaj")?.value || "").trim();

    if (!dataISO || !start || !end) {
      if (msg) msg.textContent = "‚ùå Uzupe≈Çnij datƒô i godziny.";
      return;
    }
    if (start >= end) {
      if (msg) msg.textContent = "‚ùå Godzina ko≈Ñca musi byƒá p√≥≈∫niej ni≈º start.";
      return;
    }

    const treningId = `${editMiesiac}-${editCol5}`;

    // trenerzy z select√≥w
    const trenerzyArr = [
      document.getElementById("editTrener1")?.value,
      document.getElementById("editTrener2")?.value,
      document.getElementById("editTrener3")?.value,
      document.getElementById("editTrener4")?.value
    ].map(v => String(v || "").trim()).filter(Boolean);

    // grupy z popupu
    const grupyArr = Array.from(selectedEditGroups || []);
    grupyArr.sort((a,b) => Number(a.slice(1)) - Number(b.slice(1)));
    const grupyCsv = grupyArr.join(",");

    // ‚úÖ NOWE: checkbox "Rezerwacja obiektu" w edycji
    const rezerwacjaObiektu = document.getElementById("editEventRez")?.checked ? 1 : 0;

    const r = await apiClubPost({
      action: "edytujWydarzenie",
      treningId,
      data: dataISO,
      godzStart: start,
      godzKoniec: end,
      rodzaj,
      trenerzy: trenerzyArr.join(", "),
      grupy: grupyCsv,

      // ‚úÖ NOWE pole do backendu
      rezerwacjaObiektu: rezerwacjaObiektu
    });

    if (r && (r.success || r.ok)) {
      if (msg) msg.textContent = "‚úÖ Zapisano. Od≈õwie≈ºam listƒô‚Ä¶";

      try {
        await trainerPokazWydarzenia();          // od≈õwie≈º listƒô
        setTimeout(trainerHideEditPopup, 300);  // zamknij popup po kr√≥tkiej chwili
      } catch (refreshErr) {
        console.error("Refresh after save failed:", refreshErr);
        if (msg) msg.textContent = "‚úÖ Zapisano, ale nie uda≈Ço siƒô od≈õwie≈ºyƒá listy.";
      }

      return;
    } else {
      if (msg) msg.textContent = "‚ùå Nie uda≈Ço siƒô zapisaƒá zmian: " + (r?.error || r?.message || "");
    }

  } catch (err) {
    console.error(err);
    if (msg) msg.textContent = "‚ùå B≈ÇƒÖd zapisu (sprawd≈∫ konsolƒô).";
  } finally {
    if (btn) { btn.classList.remove("loading"); btn.disabled = false; }
  }
}
  
/* =================== 99 START APLIKACJI =================== */
window.addEventListener('load', () => {
  odtworzIntroSound();

  const splash = document.getElementById('splash');
  const app = document.getElementById('app');

  if (app) app.classList.remove('hidden');

  const wersja = document.getElementById("wersjaNum");
  if (wersja) wersja.textContent = APP_BUILD;

  const setupSubmitBtn = document.getElementById("btnSetupSubmit");
  if (setupSubmitBtn && !setupSubmitBtn.getAttribute("onclick")) {
    setupSubmitBtn.addEventListener("click", submitSetupAndActivateClub);
  }

  // START: najpierw ustaw clubId z URL (albo wyczy≈õƒá na linku g≈Ç√≥wnym)
  initClubFromUrl_();

  // dopiero teraz ustawiamy stan historii (bo clubId mo≈ºe siƒô zmieniƒá)
  try {
    history.replaceState(
      { view: (clubId && isCfgLocked_()) ? "loginView" : "orgHubLandingView" },
      "",
      ""
    );
  } catch (e) {}

  // router + theme
  startApp_();
  const btn = document.getElementById("btnEditSave");
if (btn) {
  btn.onclick = () => {
    const m = document.getElementById("editEventMsg");
    if (m) m.textContent = "‚úÖ Klik dzia≈Ça (handler podpiƒôty)";
    trainerSaveEditEvent();
  };
}

  // splash ma byƒá zawsze widoczny minimalnie chwilƒô (≈ºeby nie "mruga≈Ç")
  if (splash) {
    setTimeout(() => { splash.style.display = 'none'; }, 2000);
  }
});

</script>
</body>
</html>
